# Copilot Instructions (workspace-wide)

## 目的

- 正しく、保守しやすいコードを、差分を最小限にして作る  
- レビューしやすい小さな変更を優先する  
- 共有本番環境（複数チーム共存）での衝突・事故を最優先で避ける

## 最重要: 最初に確認すること（必須）

- あなたは作業開始時（会話の最初）に、必ず次を質問してから提案する:  
  - 「あなたのチーム名（またはチームID）は？（例: teamUD）」  
- これらが不明なまま、他チームや共通領域を変更する提案をしない  
- 以降の提案・パッチは、原則として上で指定された範囲（ディレクトリ/URL/DB）内に限定する  
- チーム情報を聞くのは“会話の最初だけ”で、2回目以降は聞かない

## 基本ルール

- 要件が曖昧なときは、もっとも小さく妥当な仮定を置き、回答内で明記する  
- リポジトリ内に存在しないファイル/API/挙動は捏造しない。見つからない場合は「見つからない」と言う  
- 秘密情報（トークン/キー等）を出力しない。環境変数とプレースホルダを使う  
- 変更は最小限にし、既存の実装・命名・構成に合わせる（不要なリファクタはしない）

## 共有本番環境（複数チーム）ルール

- 他チームのディレクトリや共通設定（例: ルート直下の `settings.py` / `urls.py` / デプロイ設定 / 共通テンプレ・静的設定）を変更する必要がある場合:  
  - 勝手に変更せず、先に「変更理由」「影響範囲」「代替案」「ロールバック方針」を短く提示する  
  - 可能なら各チーム配下の変更だけで解決する案を優先する  
- URL prefix、静的ファイル出力先、サービス名、DB（SQLiteファイル/DBエイリアス）はチーム間で衝突しうるため、チーム固有のものを使う  
- 迷ったら “共有物は触らない” を優先する

## プロジェクト規約

- 言語: Python 3.9  
- フレームワーク: Django 4.2  
- パッケージ管理: uv（仮想環境: `.venv`）  
- データベース: SQLite（複数DB構成。使用DBは「チーム確認」で得たDBエイリアスに従う）  
- フォーマット: 未設定（標準的な Python/Django 規約に従う。PEP8、Django style を意識）  
- 出力言語: 説明・コメントは日本語でよい（ただし識別子は英語のまま）

## コーディングスタイル

- 可能な限り、純粋関数・明示的な型（型注釈）を優先する（無理なら最低限の型注釈に留める）  
- 変数名/関数名は説明的にする。日本語コメントは「意図・理由」を説明するために適切に使用する  
- 関数は小さく（目安30〜60行）。ネストを増やすよりヘルパー関数に切り出す  
- Djangoテンプレートでは `{% url %}` タグを使い、URLのハードコードを避ける

## アーキテクチャと境界（Django）

- ドメインロジックは I/O（ネットワーク/ファイル/DB）から切り離す（I/Oはビュー/アダプタ層へ）  
- DB操作は必ず「チーム確認」で得たDBエイリアスを用いて `.using("<DB_ALIAS>")` を使用する  
- APIエンドポイント（`/api/`）は `JsonResponse` を返す  
- フォーム（HTML）には `{% csrf_token %}` を含める  
- APIで `@csrf_exempt` を使う場合は最小限にし、理由をコメントで明記する（安易に全体を exempt しない）

## エラーハンドリング & ログ

- 境界（リクエスト受け取り時）で入力を検証し、原因が分かるエラーを返す/投げる  
- APIは適切なHTTPステータスコード（200, 400, 404, 405）を返す（不正入力/存在しない/メソッド違いを区別）  
- JavaScript の `fetch` は `.catch()` でエラーハンドリングする（UI表示やリトライは必要最小限）

## テスト（最低限の運用ルール）

- ロジックを変更したら、ブラウザで手動テストして主要導線を確認する  
- APIエンドポイントは `curl` または開発者ツール（Network/Console）で動作確認する  
- テストは決定的に（実ネットワーク/実時間に依存しない）。必要ならモック/固定値を使う  
- 共有本番に影響しそうな変更（URL/DB/静的出力/認証）は、影響範囲と確認項目を箇条書きで出す

## パフォーマンス & 安全性

- 正当化できない O(n^2) を避ける  
- DBクエリは `.filter()` 等で必要なデータのみ取得する（無駄な全件取得を避ける）  
- テンプレートでHTMLエスケープを確保する（`safe` の安易な使用を避ける）  
- JavaScriptでは `escapeHtml()` を使ってXSS対策する（DOM挿入前にエスケープ）  
- ユーザー入力は必ずバリデーション（フロント/バックエンド両方）する  
- 直接SQLや危険な動的実行（`eval`/`exec`）は使わない

## Copilot Chat の出力ルール

- 出力は次の順で書く:  
  1) 3〜6個の箇条書きで方針（前提/影響範囲を含む）  
  2) 影響ファイル一覧（複数ファイルの場合）  
  3) ファイルごとのパッチ形式コード（どのファイルに何を足す/変えるかが分かる形）  
  4) 実行方法（起動・確認手順・API確認コマンド等）  
- マイグレーションが必要な場合は、対象（Django app名）とコマンドを明記する:  
  - `.venv/Scripts/python.exe manage.py makemigrations <APP_NAME>`  
  - `.venv/Scripts/python.exe manage.py migrate`  
- 共有物（他チーム/共通設定）を触る提案をする場合は、必ず先に理由と代替案を提示する

