# AGENT.md

このファイルは、このリポジトリで作業する際にCodexに対するガイダンスを提供します。

## プロジェクト概要

これは**複数の独立したチーム（20以上のチーム）が、共通のテンプレートディレクトリとコードベースを共有しながら、個別のSQLiteデータベースで独立したアプリケーションを運用する**マルチチームDjangoプロジェクトです。このアーキテクチャにより、複数チームがデータベースの競合なしに並行して開発を進めることができます。
このプロジェクトでは、情報系の大学院１年生が受講する「プロジェクトベース学習（PBL）」の一環として、各チームが独自のDjangoアプリケーションを開発しています。アジャイル開発を実践し、特にチーム開発を学べるように設計されています。また、チーム間で競い合うのではなく、クラス全体の成功を目指す協力的な学習環境を促進しているため、20以上のチームを一つのリポジトリで管理しています。

## 技術スタック

### バックエンド
- **Python**: 3.9以上
- **Webフレームワーク**: Django 5.2以上
- **データベース**: SQLite3（チームごとに独立したデータベース）

### パッケージ管理
- **uv**: 高速なPythonパッケージマネージャー・仮想環境管理ツール
- **pyproject.toml**: 依存関係定義
- **uv.lock**: ロックファイル（依存関係のバージョン固定）

### インフラ
- **ホスティング**: 大学ネットワーク内のオンプレミスVM
- **OS**: Ubuntu 24.04
- **Webサーバー**: Django開発サーバー（ポート80、`start-stop-daemon`で管理）
- **CI/CD**: GitHub Actions（self-hosted runner）

### 開発ツール
- **バージョン管理**: Git / GitHub
- **ブランチ戦略**: フィーチャーブランチ（`<チーム名>/<機能名>`形式）
- **レビュー**: Pull Request必須、mainブランチは保護設定

### デプロイ
- **デプロイ方式**: GitHub Actions（self-hosted runner）を使用した自動デプロイ
- **デプロイフロー**: mainブランチへのマージをトリガーに、大学VM上で動作するself-hosted runnerが自動的にデプロイを実行
- **デプロイ先**: 大学ネットワーク内のオンプレミスVM（Ubuntu 24.04）

## 重要: 言語使用ガイドライン

**PRやIssueのやりとりは日本語で実施する。思考は英語で実施する。**

- GitHub上のPRのコメント、Issueのコメント、レビューコメントなどは全て日本語で記述してください
- 内部的な思考プロセスや推論は英語で実施して構いません
- コミットメッセージは日本語で記述してください
- 指示に対する応答も日本語で行ってください

## 最重要: チーム特定プロトコル

**どのチーム/アプリ/ディレクトリに対する指示なのかを必ず日本語で確認してから作業を開始してください。**

このリポジトリには20以上のチームディレクトリがあり、類似した構造を持っているため、以下を必ず確認する必要があります：
- どのチーム（チーム名）が対象か
- どのアプリ/ディレクトリを修正すべきか
- 不明な場合は必ず質問する：「どのチーム（どのアプリ・どのディレクトリ）に対する指示ですか？」

**例:**
- ❌ 悪い例: ユーザーが「モデルを追加して」と言った → すぐにランダムなチームを修正する
- ✅ 良い例: ユーザーが「モデルを追加して」と言った → 「どのチーム（どのアプリ）に対してモデルを追加しますか？」と質問する

**ユーザーがどのチームで作業しているかを決して推測しないでください。必ず最初に確認してください。**

## 必須コマンド

### 開発環境のセットアップ
```bash
# 依存関係をインストールして環境を同期
uv sync

# マイグレーションを作成（チーム非依存）
uv run python manage.py makemigrations

# 特定のチームデータベースにマイグレーションを適用
uv run python manage.py migrate --database=<チーム名>

# 開発サーバーを起動
uv run python manage.py runserver
```

### データベース操作
```bash
# チーム固有のデータベースシェルにアクセス
uv run python manage.py dbshell --database=<チーム名>

# Django設定をチェック
uv run python manage.py check
```

### テスト
```bash
# 特定のチームのテストを実行
uv run python manage.py test <チーム名>
```

## 重要なアーキテクチャの概念

### マルチデータベースルーティングシステム

**基本原則**: 各チームアプリは独自の隔離されたSQLiteデータベースを持っています。データベースルーティングは `routers.py` で管理されています。

**データベースルーター (`routers.py`)**:
- `app_to_db` 辞書を介して各チームアプリを専用データベースにマッピング
- **重要**: 新しいチームを追加する際は、必ず `routers.py` の `app_to_db` を更新する必要があります
- クロスデータベースリレーションは設計上許可されていません（Djangoの制限）
- チームデータベースは `<チーム名>/db.sqlite3` に配置されています

**ビュー内での使用**: モデルをクエリする際は常に `.using('<チーム名>')` を使用してください：
```python
# 正しい例
Member.objects.using('team_terrace').all()

# 間違った例 - defaultデータベースを使用してしまう
Member.objects.all()
```

### テンプレート管理

**テンプレートはプロジェクトルートの `templates/` ディレクトリに集約されています**:
- 設定で `APP_DIRS=False` - アプリレベルのテンプレートは無視されます
- チームのテンプレートは `templates/teams/<チーム名>/` に配置する必要があります
- チームアプリディレクトリ内にテンプレートを作成しないでください

### 新しいチームのセットアッププロセス

新しいチームを追加する際は、以下の4つのコアファイルを必ず修正する必要があります：

1. **`pbl_project/settings.py`**:
   - `INSTALLED_APPS` にチームを追加
   - `DATABASES` にチームのデータベース設定を追加

2. **`routers.py`**:
   - `app_to_db` 辞書にチームマッピングを追加

3. **`pbl_project/urls.py`**:
   - `include()` を使用してチームのURLパターンを追加

4. **`pbl_project/views.py`**:
   - ポータルページ用に `index()` ビューの `teams` リストにチームエントリを追加

詳細な手順については [docs/NEW_TEAM_SETUP.md](docs/NEW_TEAM_SETUP.md) を参照してください。

### コンフリクト解決

**予想される動作**: 複数のチームが同時にセットアップを行う場合、上記の4つのコアファイルでマージコンフリクトが発生します。

**解決戦略**: 必ず両方のチームの変更を保持してください - 他のチームの設定を削除しないでください。詳細なガイダンスについては [docs/HOW_TO_RESOLVE_CONFLICTS.md](docs/HOW_TO_RESOLVE_CONFLICTS.md) を参照してください。

## 共通パターン

### 新しいチームビューの作成
```python
# team_name/views.py
from django.shortcuts import render
from .models import YourModel

def your_view(request):
    # 必ず .using() でデータベースを指定
    data = YourModel.objects.using('team_name').all()
    return render(request, 'teams/team_name/template.html', {'data': data})
```

### マイグレーションによるデータシード

手動SQLスクリプトではなく、Djangoマイグレーションを使用してシードデータを管理してください：
```bash
# データ用の空のマイグレーションを作成
uv run python manage.py makemigrations --empty <チーム名> -n seed_data

# マイグレーションファイルを編集してRunSQL操作を追加
# その後適用
uv run python manage.py migrate --database=<チーム名>
```

詳細な手順については [docs/HOW_TO_DATA_INSERT_BY_MIGRATION.md](docs/HOW_TO_DATA_INSERT_BY_MIGRATION.md) を参照してください。

## 依存関係

- **Python**: 3.9以上（`uv` で管理）
- **パッケージマネージャー**: `uv`（pip/venvではありません） - [docs/UV_INSTALLATION.md](docs/UV_INSTALLATION.md) を参照
- **依存関係**: `pyproject.toml` で定義、`uv.lock` でロック
- **データベース**: SQLite3（Windowsを除き個別のインストールは不要 - [docs/SQLITE3_INSTALLATION.md](docs/SQLITE3_INSTALLATION.md) を参照）

## デプロイ

プロジェクトは大学のVM（Ubuntu）上でセルフホストランナーを使用しています。VMデプロイ手順については [docs/HOW_TO_DEPLOY.md](docs/HOW_TO_DEPLOY.md) を参照してください。

**主なデプロイメモ**:
- チームはフィーチャーブランチで作業します（フォーマット: `<チーム名>/<機能名>`）
- mainにマージする前にPRを作成してレビューが必要です
- ブランチ保護によりmainへの直接プッシュは防止されています
- サーバーは `start-stop-daemon` を使用してポート80で動作します

## プロジェクト構造に関する注記

- 各チームディレクトリは標準的なDjangoアプリ構造に従っています
- チームデータベースはチームコードと同じ場所に配置されています：`<チーム名>/db.sqlite3`
- `default` データベース（ルートの `db.sqlite3`）は非チームデータ（認証、管理など）用です
- URLルーティング：`/` は全チームポータルを表示、`/<チーム名>/` はチームアプリにルーティング

## 重要な制約

1. **クロスデータベースリレーションの禁止**: チームは他チームのモデルへのForeignKeyを作成できません
2. **明示的なデータベース指定が必要**: ビューで常に `.using('<チーム名>')` を使用してください
3. **テンプレートの配置場所**: プロジェクトルートの `templates/` のみで、アプリディレクトリ内は不可
4. **マイグレーションのターゲット指定**: チームアプリをマイグレートする際は常に `--database=<チーム名>` を指定してください
5. **共有設定ファイル**: 4つのコアファイル（settings.py、urls.py、views.py、routers.py）は共有されており、慎重なマージコンフリクト解決が必要です
