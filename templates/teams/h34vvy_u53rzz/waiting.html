<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <title>ドア開けてや - 待機中</title>
  </head>
  <body class="bg-slate-50 px-4 py-6 font-sans text-slate-900">
    {% include "teams/h34vvy_u53rzz/_nav.html" %}
    <div class="mx-auto max-w-2xl space-y-6">
      <header class="space-y-2 text-center">
        <p class="text-sm font-semibold uppercase tracking-wide text-blue-600">
          Waiting for helper
        </p>
        <h1 class="text-3xl font-bold text-slate-900">
          ヘルパーからの応答を待っています
        </h1>
        <p class="text-sm text-slate-600">
          近くの学生へリクエストを送信しました。しばらくその場で待機し、応答があれば案内に従ってください。
        </p>
      </header>

      <section
        id="helperStatusCard"
        class="rounded-xl border border-blue-100 bg-blue-50/80 p-6 text-center text-sm text-blue-900"
        data-status-url="{% url 'h34vvy_u53rzz:waiting_status' entry.id %}"
        data-initial-confirmed="{{ entry.helper_confirmed_at|yesno:'true,false' }}"
      >
        <p class="text-base font-semibold text-blue-900" id="helperStatusText">
          {% if entry.helper_confirmed_at %}
          近くの学生がヘルプに向かっています。
          {% else %}
          まだ応答は届いていません。しばらくお待ちください。
          {% endif %}
        </p>
        <p class="mt-2 text-xs text-blue-800" id="helperStatusSubtext">
          {% if entry.helper_confirmed_at %}
          {% if entry.helper_confirmed_at %}
          {{ entry.helper_confirmed_at|date:"H:i" }} に受け付け済みです。
          {% endif %}
          {% else %}
          このページは数秒ごとに自動更新されます。
          {% endif %}
        </p>
      </section>

      <section class="rounded-xl bg-white p-6 shadow">
        <h2 class="text-xl font-semibold text-slate-900">リクエスト内容</h2>
        <dl class="mt-4 space-y-3 text-sm text-slate-700">
          <div class="flex flex-col rounded-md bg-slate-50 p-3">
            <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              ドア
            </dt>
            <dd class="text-lg font-semibold text-slate-900">
              {{ entry.door_label }} <span class="text-sm text-slate-500">({{ entry.door_id }})</span>
            </dd>
          </div>
          <div class="flex flex-col rounded-md bg-slate-50 p-3">
            <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              送信時刻
            </dt>
            <dd>{{ entry.created_at|date:"Y年n月j日 H:i" }}</dd>
          </div>
          <div class="flex flex-col rounded-md bg-slate-50 p-3">
            <dt class="text-xs font-semibold uppercase tracking-wide text-slate-500">
              コメント
            </dt>
            <dd class="whitespace-pre-wrap">{{ entry.comment }}</dd>
          </div>
        </dl>
        <p class="mt-6 text-sm text-slate-600">
          周囲の安全を確保しながら、見知らぬ人にはついて行かないなど基本的な安全対策を守ってください。
        </p>
      </section>

      <section class="rounded-xl border border-dashed border-blue-200 bg-blue-50/60 p-6 text-sm text-blue-900">
        <h2 class="text-base font-semibold text-blue-900">次のアクション</h2>
        <ul class="mt-3 list-disc space-y-2 pl-5">
          <li>数分経っても応答がない場合は、別のドアを試すか再度リクエストしてください。</li>
          <li>緊急の状況であれば、大学の警備・学生支援センターへ直接連絡してください。</li>
        </ul>
        <div class="mt-4 flex flex-wrap gap-3">
          <a
            href="{% url 'h34vvy_u53rzz:help' %}"
            class="inline-flex items-center justify-center rounded bg-white px-4 py-2 text-sm font-medium text-blue-700 shadow-sm ring-1 ring-blue-200 transition hover:bg-blue-50"
            >別のドアを選ぶ</a
          >
          <a
            href="{% url 'h34vvy_u53rzz:index' %}"
            class="inline-flex items-center justify-center rounded bg-blue-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-blue-700"
            >トップへ戻る</a
          >
        </div>
      </section>
    </div>
  </body>
  <script>
    (function () {
      const card = document.getElementById("helperStatusCard");
      if (!card) return;
      let confirmed = card.dataset.initialConfirmed === "true";
      const statusUrl = card.dataset.statusUrl;
      const textEl = document.getElementById("helperStatusText");
      const subtextEl = document.getElementById("helperStatusSubtext");

      async function refreshStatus() {
        try {
          const response = await fetch(statusUrl, { headers: { Accept: "application/json" } });
          if (!response.ok) return;
          const data = await response.json();
          if (data.helper_confirmed && !confirmed) {
            confirmed = true;
            textEl.textContent = "近くの学生がヘルプに向かっています。";
            if (data.helper_confirmed_at) {
              const confirmedTime = new Date(data.helper_confirmed_at).toLocaleTimeString("ja-JP", {
                hour: "2-digit",
                minute: "2-digit",
              });
              subtextEl.textContent = `${confirmedTime} に受け付け済みです。`;
            } else {
              subtextEl.textContent = "ヘルパーが応答しました。到着を待ってください。";
            }
            card.classList.remove("border-blue-100", "bg-blue-50/80", "text-blue-900");
            card.classList.add("border-green-200", "bg-green-50", "text-green-900");
            textEl.classList.add("text-green-900");
          }
        } catch (error) {
          console.error(error);
        }
      }

      if (!confirmed) {
        setInterval(refreshStatus, 5000);
      }
    })();
  </script>
</html>
