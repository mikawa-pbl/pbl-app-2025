<!DOCTYPE html>
<html lang="ja">
{% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>imadokoda!</title>
    <style>
        /* å…¨ä½“ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            margin: 20px;
            color: #333;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ãŸã‚ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ãŸã‚ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
        @media (max-width: 768px) {
            body {
                margin: 10px; /* ã‚¹ãƒãƒ›ã§ã¯ä½™ç™½ã‚’æ¸›ã‚‰ã™ */
            }

            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®èª¿æ•´ */
            .header-container {
                flex-direction: column;
                align-items: flex-start !important; /* å·¦å¯„ã› */
                gap: 10px;
                /* padding: 15px !important; <- å‰Šé™¤ */
            }
            
            
            h1 {
                font-size: 1.4em !important; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’å°‘ã—å°ã•ã */
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end; /* ãƒœã‚¿ãƒ³ç­‰ã¯å³å¯„ã›ã®ã¾ã¾ */
            }

            /* ã‚«ãƒ©ãƒ ã®èª¿æ•´ */
            .dashboard-columns {
                flex-direction: column; /* ç¸¦ä¸¦ã³ */
                align-items: stretch; /* å¹…ã„ã£ã±ã„ã« */
            }

            .dashboard-column {
                min-width: 100%; /* å¹…100% */
                max-width: none;
            }
            
            /* ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ã®æŠ¼ã—ã‚„ã™ã•èª¿æ•´ */
            a[title="å ´æ‰€ã‚’è¿½åŠ "], a[title="ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ "] {
                font-size: 1.8em !important; /* å°‘ã—å¤§ãã */
                padding: 0 5px;
            }
            
            button[type="submit"] {
                padding: 10px 15px !important; /* ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã‚„ã™ã */
            }
        }

        /* Header Styling (Clean) */
        .header-container {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.8em;
            margin: 0;
            color: #333;
        }

        /* ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        /* ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆå…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .member-list {
            list-style-type: none; /* ãƒ»ã‚’æ¶ˆã™ */
            padding: 0;
            max-width: 600px; /* å¹…åˆ¶é™ */
        }

        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼ˆ1è¡Œã”ã¨ã®æ ï¼‰ */
        .member-list li {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px; /* è§’ä¸¸ */
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* ã†ã£ã™ã‚‰å½± */
        }

        /* å†™çœŸã¨åå‰ã‚’ã¾ã¨ã‚ã‚‹ã‚¨ãƒªã‚¢ */
        .member-info {
            display: flex;
            align-items: center;
            gap: 15px; /* å†™çœŸã¨åå‰ã®é–“éš” */
            flex-grow: 1; /* ä½™ç™½ã‚’åŸ‹ã‚ã‚‹ */
        }

        /* é¡”å†™çœŸã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .member-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%; /* ä¸¸ãã™ã‚‹ */
            object-fit: cover;  /* æ ã«åˆã‚ã›ã¦ãƒˆãƒªãƒŸãƒ³ã‚° */
            border: 1px solid #ccc;
        }

        /* å†™çœŸãŒãªã„å ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ */
        .default-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #eee;
            display: flex;       /* ä¸­èº«ã‚’ä¸­å¤®æƒãˆ */
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #888;
            border: 1px solid #ccc;
        }

        /* ãƒ¡ãƒ³ãƒãƒ¼åã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .member-name {
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
        }

        /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        select {
            font-size: 1em;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            cursor: pointer;
        }
        select:hover {
            background-color: #e9e9e9;
        }
    </style>
</head>

<body>
    <script>
        function activateEasterEgg() {
            const bezitaUrl = "{% static 'images/bezita.jpg' %}";
            
            // 1. Existing photos
            const photos = document.querySelectorAll('.member-photo');
            photos.forEach(img => {
                img.src = bezitaUrl;
            });

            // 2. Default icons (replace div with img)
            const defaultIcons = document.querySelectorAll('.default-icon');
            defaultIcons.forEach(div => {
                const newImg = document.createElement('img');
                newImg.src = bezitaUrl;
                newImg.className = 'member-photo';
                newImg.alt = 'Bezita';
                div.parentNode.replaceChild(newImg, div);
            });
        }

        // --- Auto Home Reset Logic ---
        function checkAutoHome() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            
            // 00:00 Check (24:00)
            if (hours === 0 && minutes === 0) {
                const todayStr = now.toDateString();
                const lastRun = localStorage.getItem('last_auto_home');
                
                if (lastRun !== todayStr) {
                    console.log("Auto triggering Home Reset...");
                    localStorage.setItem('last_auto_home', todayStr);
                    
                    // Submit the form
                    const form = document.getElementById('reset-form');
                    if (form) {
                        form.submit();
                    }
                }
            }
        }

        // Check every 10 seconds
        setInterval(checkAutoHome, 10000);
        
        // Run immediately on load just in case
        window.onload = checkAutoHome;
    </script>
</head>

<body>
    <div class="header-container">
        <h1 style="margin: 0; display: flex; align-items: center;">
            <span onclick="activateEasterEgg()" style="cursor: pointer; margin-right: 10px; font-size: 1.5em;">â™¨</span>
            <img src="{% static 'images/logo.png' %}" alt="ã„ã¾ã©ã“ã ï¼è¡¨" style="height: 60px; width: auto;">
        </h1>

        <div class="header-actions" style="display: flex; align-items: center; gap: 10px;">
            <a href="{% url 'mori_doragon_yuhi_machi:add_place' %}" title="å ´æ‰€ã‚’è¿½åŠ " style="text-decoration: none;">
                <img src="{% static 'images/location.png' %}" alt="å ´æ‰€ã‚’è¿½åŠ " style="height: 50px; width: auto;">
            </a>
            <a href="{% url 'mori_doragon_yuhi_machi:add_member' %}" title="ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ " style="text-decoration: none;">
                <img src="{% static 'images/hito.png' %}" alt="ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ " style="height: 50px; width: auto;">
            </a>
            
            <!-- å…¨å“¡å¸°å®…ãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸãŒã€è‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã®ãŸã‚ã«ãƒ•ã‚©ãƒ¼ãƒ ã¯éè¡¨ç¤ºã§æ®‹ã—ã¾ã™ -->
            <form id="reset-form" action="{% url 'mori_doragon_yuhi_machi:reset_to_home' %}" method="POST" style="display: none;">
                {% csrf_token %}
            </form>
        </div>
    </div>
    
    <style>
        /* Row category colors - Specificity increased to override .member-list li */
        .member-list li.row-cat-Laboratory { background-color: #ffcccc; border-left: 5px solid red; }
        .member-list li.row-cat-LectureRoom { background-color: #e0ffff; border-left: 5px solid cyan; }
        .member-list li.row-cat-Outdoor { background-color: #f3e6ff; border-left: 5px solid purple; }
        .member-list li.row-cat-Home { background-color: #ffffff; border-left: 5px solid #ccc; }
        .member-list li.row-cat-Other { 
            background: linear-gradient(to right, #ffafbd, #ffc3a0, #ffdfc4, #ffffc4, #e4ffc4, #c4ffdd, #c4f3ff, #c4d9ff, #dcc4ff, #ffc4fa);
            border-left: 5px solid gold;
        }

        /* å ´æ‰€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ–‡å­—è‰²ã¯é»’ã€å¤ªå­—ã®ã¿æ®‹ã™ï¼‰ */
        .cat-Laboratory { font-weight: bold; color: black; }
        .cat-LectureRoom { font-weight: bold; color: black; } 
        .cat-Outdoor { font-weight: bold; color: black; }
        .cat-Home { font-weight: bold; color: black; }
        .cat-Other { font-weight: bold; color: black; }
        
        /* 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
        .dashboard-columns {
            display: flex;
            gap: 15px; /* ã‚«ãƒ©ãƒ é–“ã®éš™é–“ */
            align-items: flex-start; /* ä¸Šæƒãˆ */
            justify-content: center; /* ä¸­å¤®å¯„ã› */
            flex-wrap: wrap; /* ç”»é¢ãŒç‹­ã„ã¨ãã¯æŠ˜ã‚Šè¿”ã— */
        }
        
        /* å„ã‚«ãƒ©ãƒ  */
        .dashboard-column {
            flex: 1;
            min-width: 280px; /* ã‚ã‚‹ç¨‹åº¦ã®å¹…ã‚’ç¢ºä¿ */
            max-width: 400px;
        }

        /* ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ */
        .member-list {
            padding: 0;
            width: 100%;
        }
        
        .member-list li {
            padding: 5px 8px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ç¸®å° */
            margin-bottom: 6px; /* ãƒãƒ¼ã‚¸ãƒ³ç¸®å° */
        }

        .member-info {
            gap: 8px; /* ç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“éš”ç¸®å° */
        }

        .member-photo, .default-icon {
            width: 40px; /* å†™çœŸã‚µã‚¤ã‚ºå°‘ã—ç¸®å° */
            height: 40px;
        }
        
        .member-name {
            font-size: 1.1em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºå¾®èª¿æ•´ */
        }
    </style>

    <div class="dashboard-columns">
            {% for column in columns %}
            <div class="dashboard-column">
                {% for grade, members in column %}
                    <h3 style="margin-top: 15px; border-bottom: 2px solid #eee; padding-bottom: 3px; font-size: 1.2em;">{{ grade }}</h3>
                    <ul class="member-list">
                        {% for member in members %}
                        <li class="row-cat-{{ member.current_place.category|default:'Other' }}">
                            <form action="{% url 'mori_doragon_yuhi_machi:update_location' %}" method="POST" style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                                
                                {% csrf_token %}
                                
                                <input type="hidden" name="member_id" value="{{ member.id }}">

                                <div class="member-info">
                                    
                                    {% if member.photo %}
                                        <img src="{{ member.photo.url }}" alt="{{ member.name }}" class="member-photo">
                                    
                                    {% else %}
                                        <div class="default-icon">ğŸ‘¤</div>
                                    {% endif %}

                                    <div class="member-details">
                                        <label for="place-select-{{ member.id }}" class="member-name" style="display: block;">
                                            {{ member.name }}
                                        </label>
                                        {% if member.updated_at %}
                                            <span style="font-size: 0.75em; color: #888;">
                                                æœ€çµ‚æ›´æ–°: {{ member.updated_at|date:"m/d H:i" }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <select name="place_id" id="place-select-{{ member.id }}" onchange="this.form.submit()" style="padding: 4px; font-size: 0.95em;">
                                    
                                    <option value="" {% if member.current_place is None %}selected{% endif %}>
                                        æœªè¨­å®š
                                    </option> 

                                    {% for place in all_places %}
                                        <option 
                                            value="{{ place.id }}" 
                                            class="cat-{{ place.category }}"
                                            {% if member.current_place == place %}selected{% endif %}
                                        >
                                            {{ place.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <div style="margin-bottom: 50px;"></div>
</body>
</html>