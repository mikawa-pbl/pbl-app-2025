{# templates/teams/shiokara/company_detail.html #}
{% extends "teams/shiokara/base.html" %}
{% load static %}

{% block content %}
<style>
    .tut-logo-box {
        flex: 0 0 auto;
        order: 2;
        margin-left: auto;
    }

    .tut-page-title {
        order: 1;
    }

    .tut-logo-img {
        max-height: 56px;
        width: auto;
        display: block;
    }

    .tut-page-title h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
        color: #42413F;
    }

    .tut-page-lead {
        margin: 4px 0 0;
        font-size: 0.9rem;
        line-height: 1.6;
    }

    .company-info-card {
        background: white;
        padding: 24px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-top: 24px;
    }

    .company-info-item {
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .company-info-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .company-info-label {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 6px;
    }

    .company-info-value {
        color: #333;
        font-size: 1rem;
    }

    .fav-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.2s;
        background: #f5f5f5;
        color: #666;
    }

    .fav-btn[aria-pressed="true"] {
        background: #fff3cd;
        color: #856404;
    }

    .fav-btn:hover {
        background: #e8e8e8;
    }

    .fav-btn[aria-pressed="true"]:hover {
        background: #ffe69c;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .section-header h2 {
        margin: 0;
        font-size: 1.5rem;
        color: #333;
    }

    .sort-form {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .sort-form label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
    }

    .sort-form select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .rating-summary {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .rating-number {
        font-size: 2rem;
        font-weight: 700;
        color: #ff9800;
    }

    .rating-stars {
        font-size: 1.5rem;
        color: #ff9800;
    }

    .review-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .review-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid #cc0000;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .review-rating {
        font-size: 1.2rem;
        font-weight: 700;
        color: #ff9800;
    }

    .review-meta {
        font-size: 0.85rem;
        color: #666;
        line-height: 1.6;
    }

    .review-comment {
        color: #333;
        line-height: 1.7;
        margin-top: 12px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        background: #f9f9f9;
        border-radius: 10px;
        color: #666;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        flex-wrap: wrap;
    }

    .btn-primary {
        padding: 12px 24px;
        background: #cc0000;
        color: white;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
        font-weight: 600;
    }

    .btn-primary:hover {
        background: #aa0000;
    }

    .btn-secondary {
        padding: 12px 24px;
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
        transition: background 0.2s;
    }

    .btn-secondary:hover {
        background: #e8e8e8;
    }

    @media (max-width: 640px) {
        .tut-page-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .tut-logo-img {
            max-height: 44px;
        }
        .tut-page-title h1 {
            font-size: 1.5rem;
        }
        .company-info-card {
            padding: 16px;
        }
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }
    }
</style>

<div class="tut-page-wrapper">
    <!-- å·¦å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    {% include "teams/shiokara/includes/sidebar.html" %}

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tut-main-content">
        <header class="tut-page-header page-header">
            <div class="tut-logo-box">
                <img src="{% static 'image/mark_gikanavi.png' %}"
                     alt="è±Šæ©‹æŠ€è¡“ç§‘å­¦å¤§å­¦ ãƒ­ã‚´" class="tut-logo-img">
            </div>
            <div class="tut-page-title">
                <h1>{{ company.name }}</h1>
                <p class="tut-page-lead page-lead">
                    ä¼æ¥­æƒ…å ±ã¨å­¦ç”Ÿã®å£ã‚³ãƒŸã‚’ç¢ºèªã§ãã¾ã™
                </p>
            </div>
        </header>

        <form method="post" action="{% url 'shiokara:company_favorite' company.pk %}" class="fav-form" style="margin-top: 20px;">
            {% csrf_token %}
            <button type="submit" class="fav-btn" aria-pressed="{% if is_favorite %}true{% else %}false{% endif %}">
                {% if is_favorite %}â˜… ãŠæ°—ã«å…¥ã‚Šè§£é™¤{% else %}â˜† ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ {% endif %}
            </button>
        </form>

        <div class="company-info-card">
            {% if company.description %}
            <div class="company-info-item">
                <div class="company-info-label">ä¼æ¥­ç´¹ä»‹</div>
                <div class="company-info-value">{{ company.description|linebreaksbr }}</div>
            </div>
            {% endif %}

            {% if company.url %}
            <div class="company-info-item">
                <div class="company-info-label">å…¬å¼ã‚µã‚¤ãƒˆ</div>
                <div class="company-info-value">
                    <a href="{{ company.url }}" target="_blank" rel="noopener" style="color: #0066cc; text-decoration: none;">
                        {{ company.url }} ğŸ”—
                    </a>
                </div>
            </div>
            {% endif %}

            {% if company.area %}
            <div class="company-info-item">
                <div class="company-info-label">å‹¤å‹™åœ°åŸŸ</div>
                <div class="company-info-value">{{ company.area }}</div>
            </div>
            {% endif %}

            {% if company.avg_annual_income %}
            <div class="company-info-item">
                <div class="company-info-label">å¹³å‡å¹´å</div>
                <div class="company-info-value" style="font-size: 1.3rem; font-weight: 700; color: #cc0000;">
                    {{ company.avg_annual_income }}ä¸‡å††
                </div>
            </div>
            {% endif %}

            {% if company.starting_salary %}
            <div class="company-info-item">
                <div class="company-info-label">åˆä»»çµ¦</div>
                <div class="company-info-value" style="font-weight: 600;">
                    {{ company.starting_salary }}ä¸‡å††
                </div>
            </div>
            {% endif %}

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                {% if company.employees %}
                <div class="company-info-item" style="border: none; padding: 12px; background: #f9f9f9; border-radius: 6px; margin: 0;">
                    <div class="company-info-label">å¾“æ¥­å“¡æ•°</div>
                    <div class="company-info-value">{{ company.employees }}äºº</div>
                </div>
                {% endif %}

                {% if company.annual_holidays %}
                <div class="company-info-item" style="border: none; padding: 12px; background: #f9f9f9; border-radius: 6px; margin: 0;">
                    <div class="company-info-label">å¹´é–“ä¼‘æ—¥æ•°</div>
                    <div class="company-info-value">{{ company.annual_holidays }}æ—¥</div>
                </div>
                {% endif %}

                {% if company.hiring_quota %}
                <div class="company-info-item" style="border: none; padding: 12px; background: #f9f9f9; border-radius: 6px; margin: 0;">
                    <div class="company-info-label">æ¡ç”¨ç›®å®‰</div>
                    <div class="company-info-value">{{ company.hiring_quota }}</div>
                </div>
                {% endif %}
            </div>

            {% if company.internship_acceptance %}
            <div class="company-info-item">
                <div class="company-info-label">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³å—ã‘å…¥ã‚Œ</div>
                <div class="company-info-value">{{ company.internship_acceptance }}</div>
            </div>
            {% endif %}

            {% if company.accepts_jitsumu_kunren or company.tut_recommendation or oncampus_briefing_names %}
            <div class="company-info-item">
                <div class="company-info-label">æŠ€ç§‘å¤§é–¢é€£æƒ…å ±</div>
                <div class="company-info-value">
                    {% if company.accepts_jitsumu_kunren %}
                    <span style="display: inline-block; padding: 4px 10px; background: #e3f2fd; color: #1565c0; border-radius: 4px; font-size: 0.85rem; margin-right: 6px; margin-bottom: 6px;">âœ“ å®Ÿå‹™è¨“ç·´å—ã‘å…¥ã‚Œ</span>
                    {% endif %}
                    {% if company.tut_recommendation %}
                    <span style="display: inline-block; padding: 4px 10px; background: #fff3e0; color: #e65100; border-radius: 4px; font-size: 0.85rem; margin-right: 6px; margin-bottom: 6px;">âœ“ æŠ€ç§‘å¤§æ¨è–¦ã‚ã‚Š</span>
                    {% endif %}
                    {% if oncampus_briefing_names %}
                    <div style="margin-top: 8px;">
                        <strong style="font-size: 0.9rem; color: #6a1b9a;">èª¬æ˜ä¼šå¯¾è±¡åˆ†é‡:</strong>
                        <div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px;">
                        {% for field_name in oncampus_briefing_names %}
                            <span style="display: inline-block; padding: 4px 10px; background: #f3e5f5; color: #6a1b9a; border-radius: 4px; font-size: 0.85rem;">{{ field_name }}</span>
                        {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% if company.selection_process %}
            <div class="company-info-item">
                <div class="company-info-label">é¸è€ƒãƒ—ãƒ­ã‚»ã‚¹</div>
                <div class="company-info-value">{{ company.selection_process|linebreaksbr }}</div>
            </div>
            {% endif %}

            {% if company.internship_start_date or company.internship_deadline or company.last_year_selection_start_date %}
            <div class="company-info-item">
                <div class="company-info-label">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ±</div>
                <div class="company-info-value" style="font-size: 0.9rem;">
                    {% if company.internship_start_date %}
                    <div style="margin-bottom: 4px;">ğŸ“… ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³é–‹å§‹: {{ company.internship_start_date|date:"Yå¹´mæœˆdæ—¥" }}</div>
                    {% endif %}
                    {% if company.internship_deadline %}
                    <div style="margin-bottom: 4px;">â° ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç· åˆ‡: {{ company.internship_deadline|date:"Yå¹´mæœˆdæ—¥" }}</div>
                    {% endif %}
                    {% if company.last_year_selection_start_date %}
                    <div>ğŸ“ å‰å¹´åº¦é¸è€ƒé–‹å§‹: {{ company.last_year_selection_start_date|date:"Yå¹´mæœˆdæ—¥" }}</div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <div style="margin-top: 40px;">
            <div class="section-header">
                <h2>å£ã‚³ãƒŸ</h2>
                <form method="get" class="sort-form">
                    <label for="sort-select">ä¸¦ã³æ›¿ãˆ:</label>
                    <select name="sort" id="sort-select" onchange="this.form.submit()">
                        <option value="new" {% if sort == "new" %}selected{% endif %}>æ–°ç€é †</option>
                        <option value="rating" {% if sort == "rating" %}selected{% endif %}>è©•ä¾¡ãŒé«˜ã„é †</option>
                    </select>
                </form>
            </div>

            {% if avg_rating %}
            <div class="rating-summary">
                <div class="rating-number">{{ avg_rating|floatformat:1 }}</div>
                <div>
                    <div class="rating-stars">â˜…â˜…â˜…â˜…â˜…</div>
                    <div style="font-size: 0.85rem; color: #666;">å¹³å‡è©•ä¾¡ (5ç‚¹æº€ç‚¹)</div>
                </div>
            </div>
            {% endif %}

            {% if reviews %}
            <div class="review-list">
                {% for review in reviews %}
                <div class="review-card">
                    <div class="review-header">
                        <div class="review-rating">â˜…{{ review.rating }}</div>
                        <div class="review-meta">
                            {{ review.grade }} / {{ review.department_name }} / {{ review.lab_field }}<br>
                            æ€§åˆ¥: {% if review.gender == "male" %}ç”·æ€§{% elif review.gender == "female" %}å¥³æ€§{% elif review.gender == "other" %}ãã®ä»–{% else %}å›ç­”ã—ãªã„{% endif %}
                            {% if review.high_school %} / é«˜æ ¡: {{ review.high_school }}{% endif %}<br>
                            æŠ•ç¨¿æ—¥: {{ review.created_at|date:"Yå¹´mæœˆdæ—¥" }}
                        </div>
                    </div>
                    <div class="review-comment">{{ review.comment|linebreaksbr }}</div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <p>ã¾ã å£ã‚³ãƒŸã¯æŠ•ç¨¿ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                <p style="font-size: 0.9rem; margin-top: 8px;">æœ€åˆã®å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ</p>
            </div>
            {% endif %}
        </div>

        <div class="action-buttons">
            <a href="{% url 'shiokara:company_experience_post' company.pk %}" class="btn-primary">
                å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹
            </a>
            <a href="{% url 'shiokara:company_search' %}" class="btn-secondary">
                â† ä¼æ¥­æ¤œç´¢ã«æˆ»ã‚‹
            </a>
        </div>

{% if points_awarded %}
  <div id="points-popup-wrapper" aria-live="polite" role="status">
    <div id="points-popup" class="points-popup" role="alert">
      <div class="points-popup-title">ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼</div>
      <div class="points-popup-body">{{ points_awarded }}pt ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</div>
      <button id="points-popup-close" class="points-popup-close" aria-label="ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹">âœ•</button>
    </div>
  </div>

  <style>
    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—: ä¸Šä¸­å¤®ã‹ã‚‰ã²ã‚‡ã£ã“ã‚Šãƒãƒƒãƒ—ã‚¤ãƒ³ */
    #points-popup-wrapper {
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 12000;
      pointer-events: none; /* wrapper ã¯ã‚¯ãƒªãƒƒã‚¯é€éã€å†…éƒ¨ã§ãƒœã‚¿ãƒ³ã¯æœ‰åŠ¹ */
    }

    .points-popup {
      pointer-events: auto;
      min-width: 260px;
      max-width: 90vw;
      background: linear-gradient(180deg,#f0fff4,#ffffff);
      color: #155724;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      border: 1px solid rgba(34,139,34,0.12);
      text-align: left;
      transform-origin: 50% 0%;
      transform: translateY(-22px) scale(0.92);
      opacity: 0;
      transition: transform 420ms cubic-bezier(.2,.9,.3,1), opacity 300ms ease;
      position: relative;
      overflow: hidden;
    }

    /* è¡¨ç¤ºæ™‚ã‚¯ãƒ©ã‚¹ */
    .points-popup.show {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .points-popup-title{ font-weight:700; margin-bottom:6px; }
    .points-popup-body{ font-size:0.98rem; }

    .points-popup-close{
      position:absolute; top:6px; right:8px; border:0; background:transparent; font-size:14px; cursor:pointer; color:#2f6f34;
      padding:4px 6px; line-height:1; border-radius:6px;
    }
    .points-popup-close:focus{ outline:2px solid rgba(34,139,34,0.15); }
  </style>

  <script>
    (function(){
      var wrapper = document.getElementById('points-popup-wrapper');
      if(!wrapper) return;
      var popup = document.getElementById('points-popup');
      var btn = document.getElementById('points-popup-close');
      // å°ã•ãªé…å»¶ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™ºç«ã•ã›ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®æç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å¾…ã¤ï¼‰
      requestAnimationFrame(function(){
        requestAnimationFrame(function(){
          popup.classList.add('show');
        });
      });

      // è‡ªå‹•ã§æ•°ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦ DOM ã‹ã‚‰å‰Šé™¤
      var hideDelay = 3500;
      var hideTimer = setTimeout(function(){
        popup.classList.remove('show');
        setTimeout(function(){ if(wrapper) wrapper.remove(); }, 420);
      }, hideDelay);

      btn.addEventListener('click', function(e){
        e.preventDefault();
        clearTimeout(hideTimer);
        popup.classList.remove('show');
        setTimeout(function(){ if(wrapper) wrapper.remove(); }, 220);
      });
    })();
  </script>
{% endif %}

<!-- ======================== -->
<!-- ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« -->
<!-- ======================== -->
<style>
    /* ãƒã‚¤ãƒ³ãƒˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    #points-tut-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 9998;
        display: none;
    }

    .points-tut-highlight {
        position: relative;
        z-index: 9999 !important;
        box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 0 6px rgba(255,255,255,0.05) inset;
        transform: translateZ(0) scale(1.02);
        transition: box-shadow 180ms ease, transform 180ms ease;
        outline: 3px solid rgba(203,0,0,0.95);
        border-radius: 8px;
    }

    #points-tut-tooltip {
        position: fixed;
        z-index: 10000;
        max-width: 320px;
        background: #fff;
        color: #222;
        border-radius: 8px;
        box-shadow: 0 6px 28px rgba(0,0,0,0.18);
        padding: 12px;
        display: none;
        font-size: 0.95rem;
    }

    #points-tut-tooltip #points-tut-controls {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
    }

    #points-tut-tooltip button {
        background: #f3f3f3;
        border: 1px solid #ddd;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    #points-tut-start-btn {
        position: fixed;
        left: 18px;
        bottom: 18px;
        z-index: 10001;
        background: linear-gradient(180deg, #4CAF50, #45a049);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 999px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.18);
        cursor: pointer;
        font-weight: 700;
        font-size: 0.9rem;
    }

    @media (max-width:640px) {
        #points-tut-tooltip { max-width: 260px; font-size: 0.9rem; }
        #points-tut-start-btn { left: 12px; bottom: 12px; font-size: 0.85rem; }
    }
</style>

<div id="points-tut-overlay" aria-hidden="true"></div>
<div id="points-tut-tooltip" aria-hidden="true" role="dialog" aria-label="ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½èª¬æ˜">
    <div id="points-tut-content"></div>
    <div id="points-tut-controls">
        <button id="points-tut-prev" type="button">æˆ»ã‚‹</button>
        <button id="points-tut-next" type="button">æ¬¡ã¸</button>
        <button id="points-tut-close" type="button">é–‰ã˜ã‚‹</button>
    </div>
</div>

<button id="points-tut-start-btn" aria-label="ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‹å§‹">ğŸ’š ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½</button>

<script>
    (function(){
        const steps = [
            {
                sel: 'header',
                title: 'ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º',
                body: 'ãƒ˜ãƒƒãƒ€ãƒ¼ã®å³ä¸Šã«ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆæ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã®ã‚µã‚¤ãƒˆã§ã¯ãƒã‚¤ãƒ³ãƒˆã§ä¼æ¥­æƒ…å ±ã‚’é–²è¦§ã§ãã¾ã™ã€‚'
            },
            {
                sel: 'h1',
                title: 'ä¼æ¥­è©³ç´°ãƒšãƒ¼ã‚¸',
                body: 'ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹ã®ã«1ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ã—ã¾ã—ãŸã€‚åŒã˜ä¼æ¥­ã‚’ã‚‚ã†ä¸€åº¦è¨ªã‚Œã‚‹å ´åˆã€ãƒã‚¤ãƒ³ãƒˆã¯æ¶ˆè²»ã•ã‚Œã¾ã›ã‚“ã€‚'
            },
            {
                sel: 'a[href*="company_experience_post"]',
                title: 'å£ã‚³ãƒŸæŠ•ç¨¿ã§ç²å¾—',
                body: 'ã“ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹ã¨ã€5ãƒã‚¤ãƒ³ãƒˆç²å¾—ã§ãã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã‚’å¢—ã‚„ã—ã¦ã€ã‚‚ã£ã¨å¤šãã®ä¼æ¥­æƒ…å ±ã‚’è¦‹ã¾ã—ã‚‡ã†ï¼'
            },
            {
                sel: 'h2',
                title: 'å£ã‚³ãƒŸä¸€è¦§',
                body: 'ä»–ã®å­¦ç”Ÿã®å£ã‚³ãƒŸãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ä¼æ¥­é¸ã³ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚'
            }
        ];

        let idx = 0;
        const overlay = document.getElementById('points-tut-overlay');
        const tooltip = document.getElementById('points-tut-tooltip');
        const content = document.getElementById('points-tut-content');
        const btnPrev = document.getElementById('points-tut-prev');
        const btnNext = document.getElementById('points-tut-next');
        const btnClose = document.getElementById('points-tut-close');
        const startBtn = document.getElementById('points-tut-start-btn');

        function showStep(i){
            document.querySelectorAll('.points-tut-highlight').forEach(el=>el.classList.remove('points-tut-highlight'));
            tooltip.style.display = 'none';
            overlay.style.display = 'block';

            const step = steps[i];
            if(!step) { endTutorial(); return; }
            const target = document.querySelector(step.sel);
            content.innerHTML = '<strong>'+step.title+'</strong><div style="margin-top:6px;">'+step.body+'</div>';

            if(target){
                target.classList.add('points-tut-highlight');
                const r = target.getBoundingClientRect();
                const tt = tooltip;
                const margin = 100;
                let top = window.scrollY + r.bottom + margin;
                let left = window.scrollX + r.left;
                left = Math.min(Math.max(left, 8 + window.scrollX), window.scrollX + document.documentElement.clientWidth - tt.offsetWidth - 8);
                tt.style.top = top + 'px';
                tt.style.left = left + 'px';
                tt.style.display = 'block';
                btnNext.focus();
            } else {
                const tt = tooltip;
                tt.style.top = (window.scrollY + window.innerHeight/2 - 80) + 'px';
                tt.style.left = (window.scrollX + (window.innerWidth - tt.offsetWidth)/2) + 'px';
                tt.style.display = 'block';
            }

            btnPrev.disabled = (i===0);
            btnNext.textContent = (i === steps.length -1) ? 'å®Œäº†' : 'æ¬¡ã¸';
            idx = i;
        }

        function nextStep(){
            if(idx < steps.length -1) showStep(idx+1);
            else endTutorial();
        }
        function prevStep(){ if(idx>0) showStep(idx-1); }

        function startTutorial(){
            showStep(0);
            overlay.style.display = 'block';
            document.body.classList.add('points-tut-in-progress');
        }

        function endTutorial(){
            overlay.style.display = 'none';
            tooltip.style.display = 'none';
            document.querySelectorAll('.points-tut-highlight').forEach(el=>el.classList.remove('points-tut-highlight'));
            document.body.classList.remove('points-tut-in-progress');
        }

        btnNext.addEventListener('click', nextStep);
        btnPrev.addEventListener('click', prevStep);
        btnClose.addEventListener('click', endTutorial);
        overlay.addEventListener('click', endTutorial);
        startBtn.addEventListener('click', startTutorial);

        document.addEventListener('keydown', (ev)=>{
            if(!document.body.classList.contains('points-tut-in-progress')) return;
            if(ev.key === 'Escape') endTutorial();
            if(ev.key === 'ArrowRight' || ev.key === 'Enter') nextStep();
            if(ev.key === 'ArrowLeft') prevStep();
        });

        // åˆå›ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»æ™‚ã¯è‡ªå‹•èµ·å‹•
        const FIRST_POINT_USAGE = {{ first_point_usage|yesno:"true,false" }};
        const SEEN_POINTS_TUTORIAL = {{ seen_points_tutorial|yesno:"true,false" }};
        console.log('ğŸ” FIRST_POINT_USAGE:', FIRST_POINT_USAGE, 'SEEN_POINTS_TUTORIAL:', SEEN_POINTS_TUTORIAL);
        if(FIRST_POINT_USAGE && !SEEN_POINTS_TUTORIAL){
            console.log('ğŸš€ Points Tutorial will auto-start...');
            setTimeout(()=>{ startTutorial(); }, 300);
        } else {
            console.log('âœ… Points Tutorial auto-start is disabled');
        }

        window.__points_tut_start = startTutorial;
    })();
</script>
        {% comment %} Favorite toggle AJAX handler for company detail {% endcomment %}
        <script>
        document.addEventListener('DOMContentLoaded', function(){
          var form = document.querySelector('.fav-form');
          if(!form) return;
          form.addEventListener('submit', function(ev){
            ev.preventDefault();
            var btn = form.querySelector('.fav-btn');
            var csrftoken = form.querySelector('input[name=csrfmiddlewaretoken]')?.value;
            fetch(form.action, { method: 'POST', headers: { 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken } })
              .then(r=>r.json()).then(function(data){
                if(data && data.ok){
                  if(data.added){ btn.textContent = 'â˜… ãŠæ°—ã«å…¥ã‚Šè§£é™¤'; btn.setAttribute('aria-pressed','true'); }
                  else { btn.textContent = 'â˜† ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ '; btn.setAttribute('aria-pressed','false'); }
                }
              }).catch(function(){ form.submit(); });
          });
        });
        </script>

<!-- å£ã‚³ãƒŸæŠ•ç¨¿æˆåŠŸã®æ¼”å‡º -->
{% if points_awarded %}
<style>
    /* æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ« */
    .success-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s;
    }

    .success-modal {
        background: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        animation: bounceIn 0.6s;
        max-width: 500px;
        position: relative;
    }

    .success-modal h2 {
        font-size: 2rem;
        color: #cc0000;
        margin: 0 0 16px;
        animation: pulse 1s infinite;
    }

    .success-modal p {
        font-size: 1.2rem;
        color: #333;
        margin: 12px 0;
    }

    .points-badge {
        display: inline-block;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #856404;
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.5);
        animation: scaleUp 0.8s;
    }

    .close-success-btn {
        background: #cc0000;
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.2s;
    }

    .close-success-btn:hover {
        background: #aa0000;
    }

    /* ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background: #f0f;
        position: absolute;
        animation: confetti-fall 3s linear forwards;
        z-index: 10001;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes bounceIn {
        0% { transform: scale(0.3); opacity: 0; }
        50% { transform: scale(1.05); }
        70% { transform: scale(0.9); }
        100% { transform: scale(1); opacity: 1; }
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    @keyframes scaleUp {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    @keyframes confetti-fall {
        to {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }
</style>

<div class="success-overlay" id="successOverlay">
    <div class="success-modal">
        <h2>ğŸ‰ æŠ•ç¨¿å®Œäº†ï¼ğŸ‰</h2>
        <p>å£ã‚³ãƒŸã®æŠ•ç¨¿ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
        <div class="points-badge">
            +{{ points_awarded }} ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼
        </div>
        <p style="font-size: 1rem; color: #666;">ã‚ãªãŸã®ä½“é¨“ãŒä»–ã®å­¦ç”Ÿã®å½¹ã«ç«‹ã¡ã¾ã™</p>
        <button class="close-success-btn" onclick="closeSuccessModal()">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
(function() {
    // åŠ¹æœéŸ³ã‚’ç”Ÿæˆï¼ˆWeb Audio APIä½¿ç”¨ï¼‰
    function playSuccessSound() {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // æˆåŠŸéŸ³ã®ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼ã‚’ä½œæˆ
            const notes = [
                { freq: 523.25, start: 0, duration: 0.15 },    // C5
                { freq: 659.25, start: 0.15, duration: 0.15 }, // E5
                { freq: 783.99, start: 0.3, duration: 0.3 }    // G5
            ];
            
            notes.forEach(note => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = note.freq;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + note.start);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + note.start + note.duration);
                
                oscillator.start(audioContext.currentTime + note.start);
                oscillator.stop(audioContext.currentTime + note.start + note.duration);
            });
        } catch (e) {
            console.log('Audio playback not supported');
        }
    }

    // ç´™å¹é›ªã‚’ç”Ÿæˆ
    function createConfetti() {
        const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#ffd93d', '#6bcf7f', '#c44569'];
        const confettiCount = 100;
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                confetti.style.animationDelay = (Math.random() * 0.5) + 's';
                
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 4000);
            }, i * 20);
        }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSuccessModal = function() {
        const overlay = document.getElementById('successOverlay');
        if (overlay) {
            overlay.style.animation = 'fadeOut 0.3s';
            setTimeout(() => overlay.remove(), 300);
        }
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    window.addEventListener('DOMContentLoaded', function() {
        playSuccessSound();
        createConfetti();
        
        // 5ç§’å¾Œã«è‡ªå‹•çš„ã«é–‰ã˜ã‚‹
        setTimeout(closeSuccessModal, 5000);
    });

    // fadeOut ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
    const style = document.createElement('style');
    style.textContent = '@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }';
    document.head.appendChild(style);
})();
</script>
{% endif %}

    </div>
</div>

        {% endblock %}
