{# templates/teams/shiokara/company_detail.html #}
{% extends "teams/shiokara/base.html" %}

{% block content %}
<h1>{{ company.name }}</h1>

<p>ã“ã“ã¯ {{ company.name }} ã®ä½“é¨“è«‡ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³æƒ…å ±ãªã©ã‚’è¼‰ã›ã‚‹äºˆå®šã®ãƒšãƒ¼ã‚¸ã§ã™ã€‚</p>

<ul>
    {% if company.url %}
    <li>
        å…¬å¼ã‚µã‚¤ãƒˆï¼š
        <a href="{{ company.url }}" target="_blank" rel="noopener">
            {{ company.url }}
        </a>
    </li>
    {% endif %}

    {% if company.description %}
    <li>
        ç´¹ä»‹æ–‡ï¼š<br>
        <small>{{ company.description|linebreaksbr }}</small>
    </li>
    {% endif %}
</ul>

<hr>

<h2>å£ã‚³ãƒŸ</h2>

{% if avg_rating %}
  <p>å¹³å‡è©•ä¾¡ï¼šâ˜…{{ avg_rating|floatformat:1 }} / 5</p>
{% endif %}

{# â˜… ä¸¦ã³æ›¿ãˆãƒ•ã‚©ãƒ¼ãƒ  #}
<form method="get" style="margin-bottom: 8px;">
  <label>
    ä¸¦ã³æ›¿ãˆ:
    <select name="sort" onchange="this.form.submit()">
      <option value="new" {% if sort == "new" %}selected{% endif %}>æ–°ç€é †</option>
      <option value="rating" {% if sort == "rating" %}selected{% endif %}>è©•ä¾¡ãŒé«˜ã„é †</option>
    </select>
  </label>
</form>

{% if avg_rating %}
  <p>å¹³å‡è©•ä¾¡ï¼šâ˜…{{ avg_rating|floatformat:1 }} / 5</p>
{% endif %}

{% if reviews %}
  <ul>
    {% for review in reviews %}
      <li style="margin-bottom:1.2em;">
        <strong>â˜…{{ review.rating }}</strong><br>
        <small>
          {{ review.grade }} /
          {{ review.department_name }} /
          {{ review.lab_field }}<br>
          æ€§åˆ¥: 
          {% if review.gender == "male" %}ç”·æ€§{% elif review.gender == "female" %}å¥³æ€§
          {% elif review.gender == "other" %}ãã®ä»–{% else %}å›ç­”ã—ãªã„{% endif %}
          {% if review.high_school %}
            / é«˜æ ¡: {{ review.high_school }}
          {% endif %}
          / {{ review.created_at|date:"Y-m-d" }}
        </small><br>
        {{ review.comment|linebreaksbr }}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>ã¾ã å£ã‚³ãƒŸã¯æŠ•ç¨¿ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
{% endif %}

<p>
  <a href="{% url 'shiokara:company_experience_post' company.pk %}">
    ã“ã®ä¼æ¥­ã®å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹
  </a>
</p>

<p>
    <a href="{% url 'shiokara:company_search' %}">â† ä¼æ¥­æ¤œç´¢ã«æˆ»ã‚‹</a>
</p>

{% if points_awarded %}
  <div id="points-popup-wrapper" aria-live="polite" role="status">
    <div id="points-popup" class="points-popup" role="alert">
      <div class="points-popup-title">ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼</div>
      <div class="points-popup-body">{{ points_awarded }}pt ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚</div>
      <button id="points-popup-close" class="points-popup-close" aria-label="ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹">âœ•</button>
    </div>
  </div>

  <style>
    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—: ä¸Šä¸­å¤®ã‹ã‚‰ã²ã‚‡ã£ã“ã‚Šãƒãƒƒãƒ—ã‚¤ãƒ³ */
    #points-popup-wrapper {
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 12000;
      pointer-events: none; /* wrapper ã¯ã‚¯ãƒªãƒƒã‚¯é€éã€å†…éƒ¨ã§ãƒœã‚¿ãƒ³ã¯æœ‰åŠ¹ */
    }

    .points-popup {
      pointer-events: auto;
      min-width: 260px;
      max-width: 90vw;
      background: linear-gradient(180deg,#f0fff4,#ffffff);
      color: #155724;
      padding: 12px 16px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      border: 1px solid rgba(34,139,34,0.12);
      text-align: left;
      transform-origin: 50% 0%;
      transform: translateY(-22px) scale(0.92);
      opacity: 0;
      transition: transform 420ms cubic-bezier(.2,.9,.3,1), opacity 300ms ease;
      position: relative;
      overflow: hidden;
    }

    /* è¡¨ç¤ºæ™‚ã‚¯ãƒ©ã‚¹ */
    .points-popup.show {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .points-popup-title{ font-weight:700; margin-bottom:6px; }
    .points-popup-body{ font-size:0.98rem; }

    .points-popup-close{
      position:absolute; top:6px; right:8px; border:0; background:transparent; font-size:14px; cursor:pointer; color:#2f6f34;
      padding:4px 6px; line-height:1; border-radius:6px;
    }
    .points-popup-close:focus{ outline:2px solid rgba(34,139,34,0.15); }
  </style>

  <script>
    (function(){
      var wrapper = document.getElementById('points-popup-wrapper');
      if(!wrapper) return;
      var popup = document.getElementById('points-popup');
      var btn = document.getElementById('points-popup-close');
      // å°ã•ãªé…å»¶ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç™ºç«ã•ã›ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®æç”»ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’å¾…ã¤ï¼‰
      requestAnimationFrame(function(){
        requestAnimationFrame(function(){
          popup.classList.add('show');
        });
      });

      // è‡ªå‹•ã§æ•°ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦ DOM ã‹ã‚‰å‰Šé™¤
      var hideDelay = 3500;
      var hideTimer = setTimeout(function(){
        popup.classList.remove('show');
        setTimeout(function(){ if(wrapper) wrapper.remove(); }, 420);
      }, hideDelay);

      btn.addEventListener('click', function(e){
        e.preventDefault();
        clearTimeout(hideTimer);
        popup.classList.remove('show');
        setTimeout(function(){ if(wrapper) wrapper.remove(); }, 220);
      });
    })();
  </script>
{% endif %}

<!-- ======================== -->
<!-- ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« -->
<!-- ======================== -->
<style>
    /* ãƒã‚¤ãƒ³ãƒˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    #points-tut-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 9998;
        display: none;
    }

    .points-tut-highlight {
        position: relative;
        z-index: 9999 !important;
        box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 0 6px rgba(255,255,255,0.05) inset;
        transform: translateZ(0) scale(1.02);
        transition: box-shadow 180ms ease, transform 180ms ease;
        outline: 3px solid rgba(203,0,0,0.95);
        border-radius: 8px;
    }

    #points-tut-tooltip {
        position: fixed;
        z-index: 10000;
        max-width: 320px;
        background: #fff;
        color: #222;
        border-radius: 8px;
        box-shadow: 0 6px 28px rgba(0,0,0,0.18);
        padding: 12px;
        display: none;
        font-size: 0.95rem;
    }

    #points-tut-tooltip #points-tut-controls {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
    }

    #points-tut-tooltip button {
        background: #f3f3f3;
        border: 1px solid #ddd;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    #points-tut-start-btn {
        position: fixed;
        left: 18px;
        bottom: 18px;
        z-index: 10001;
        background: linear-gradient(180deg, #4CAF50, #45a049);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 999px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.18);
        cursor: pointer;
        font-weight: 700;
        font-size: 0.9rem;
    }

    @media (max-width:640px) {
        #points-tut-tooltip { max-width: 260px; font-size: 0.9rem; }
        #points-tut-start-btn { left: 12px; bottom: 12px; font-size: 0.85rem; }
    }
</style>

<div id="points-tut-overlay" aria-hidden="true"></div>
<div id="points-tut-tooltip" aria-hidden="true" role="dialog" aria-label="ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½èª¬æ˜">
    <div id="points-tut-content"></div>
    <div id="points-tut-controls">
        <button id="points-tut-prev" type="button">æˆ»ã‚‹</button>
        <button id="points-tut-next" type="button">æ¬¡ã¸</button>
        <button id="points-tut-close" type="button">é–‰ã˜ã‚‹</button>
    </div>
</div>

<button id="points-tut-start-btn" aria-label="ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‹å§‹">ğŸ’š ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½</button>

<script>
    (function(){
        const steps = [
            {
                sel: 'header',
                title: 'ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º',
                body: 'ãƒ˜ãƒƒãƒ€ãƒ¼ã®å³ä¸Šã«ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆæ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã®ã‚µã‚¤ãƒˆã§ã¯ãƒã‚¤ãƒ³ãƒˆã§ä¼æ¥­æƒ…å ±ã‚’é–²è¦§ã§ãã¾ã™ã€‚'
            },
            {
                sel: 'h1',
                title: 'ä¼æ¥­è©³ç´°ãƒšãƒ¼ã‚¸',
                body: 'ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹ã®ã«1ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ã—ã¾ã—ãŸã€‚åŒã˜ä¼æ¥­ã‚’ã‚‚ã†ä¸€åº¦è¨ªã‚Œã‚‹å ´åˆã€ãƒã‚¤ãƒ³ãƒˆã¯æ¶ˆè²»ã•ã‚Œã¾ã›ã‚“ã€‚'
            },
            {
                sel: 'a[href*="company_experience_post"]',
                title: 'å£ã‚³ãƒŸæŠ•ç¨¿ã§ç²å¾—',
                body: 'ã“ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹ã¨ã€5ãƒã‚¤ãƒ³ãƒˆç²å¾—ã§ãã¾ã™ã€‚ãƒã‚¤ãƒ³ãƒˆã‚’å¢—ã‚„ã—ã¦ã€ã‚‚ã£ã¨å¤šãã®ä¼æ¥­æƒ…å ±ã‚’è¦‹ã¾ã—ã‚‡ã†ï¼'
            },
            {
                sel: 'h2',
                title: 'å£ã‚³ãƒŸä¸€è¦§',
                body: 'ä»–ã®å­¦ç”Ÿã®å£ã‚³ãƒŸãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ä¼æ¥­é¸ã³ã®å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚'
            }
        ];

        let idx = 0;
        const overlay = document.getElementById('points-tut-overlay');
        const tooltip = document.getElementById('points-tut-tooltip');
        const content = document.getElementById('points-tut-content');
        const btnPrev = document.getElementById('points-tut-prev');
        const btnNext = document.getElementById('points-tut-next');
        const btnClose = document.getElementById('points-tut-close');
        const startBtn = document.getElementById('points-tut-start-btn');

        function showStep(i){
            document.querySelectorAll('.points-tut-highlight').forEach(el=>el.classList.remove('points-tut-highlight'));
            tooltip.style.display = 'none';
            overlay.style.display = 'block';

            const step = steps[i];
            if(!step) { endTutorial(); return; }
            const target = document.querySelector(step.sel);
            content.innerHTML = '<strong>'+step.title+'</strong><div style="margin-top:6px;">'+step.body+'</div>';

            if(target){
                target.classList.add('points-tut-highlight');
                const r = target.getBoundingClientRect();
                const tt = tooltip;
                const margin = 100;
                let top = window.scrollY + r.bottom + margin;
                let left = window.scrollX + r.left;
                left = Math.min(Math.max(left, 8 + window.scrollX), window.scrollX + document.documentElement.clientWidth - tt.offsetWidth - 8);
                tt.style.top = top + 'px';
                tt.style.left = left + 'px';
                tt.style.display = 'block';
                btnNext.focus();
            } else {
                const tt = tooltip;
                tt.style.top = (window.scrollY + window.innerHeight/2 - 80) + 'px';
                tt.style.left = (window.scrollX + (window.innerWidth - tt.offsetWidth)/2) + 'px';
                tt.style.display = 'block';
            }

            btnPrev.disabled = (i===0);
            btnNext.textContent = (i === steps.length -1) ? 'å®Œäº†' : 'æ¬¡ã¸';
            idx = i;
        }

        function nextStep(){
            if(idx < steps.length -1) showStep(idx+1);
            else endTutorial();
        }
        function prevStep(){ if(idx>0) showStep(idx-1); }

        function startTutorial(){
            showStep(0);
            overlay.style.display = 'block';
            document.body.classList.add('points-tut-in-progress');
        }

        function endTutorial(){
            overlay.style.display = 'none';
            tooltip.style.display = 'none';
            document.querySelectorAll('.points-tut-highlight').forEach(el=>el.classList.remove('points-tut-highlight'));
            document.body.classList.remove('points-tut-in-progress');
        }

        btnNext.addEventListener('click', nextStep);
        btnPrev.addEventListener('click', prevStep);
        btnClose.addEventListener('click', endTutorial);
        overlay.addEventListener('click', endTutorial);
        startBtn.addEventListener('click', startTutorial);

        document.addEventListener('keydown', (ev)=>{
            if(!document.body.classList.contains('points-tut-in-progress')) return;
            if(ev.key === 'Escape') endTutorial();
            if(ev.key === 'ArrowRight' || ev.key === 'Enter') nextStep();
            if(ev.key === 'ArrowLeft') prevStep();
        });

        // åˆå›ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»æ™‚ã¯è‡ªå‹•èµ·å‹•
        const FIRST_POINT_USAGE = {{ first_point_usage|yesno:"true,false" }};
        const SEEN_POINTS_TUTORIAL = {{ seen_points_tutorial|yesno:"true,false" }};
        console.log('ğŸ” FIRST_POINT_USAGE:', FIRST_POINT_USAGE, 'SEEN_POINTS_TUTORIAL:', SEEN_POINTS_TUTORIAL);
        if(FIRST_POINT_USAGE && !SEEN_POINTS_TUTORIAL){
            console.log('ğŸš€ Points Tutorial will auto-start...');
            setTimeout(()=>{ startTutorial(); }, 300);
        } else {
            console.log('âœ… Points Tutorial auto-start is disabled');
        }

        window.__points_tut_start = startTutorial;
    })();
</script>
{% endblock %}
