{% extends "teams/shiokara/base.html" %}
{% load static %}

{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸ - å°±æ´»æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹{% endblock %}

{% block content %}
<div class="tut-page-wrapper">
    <!-- å·¦å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    {% include "teams/shiokara/includes/sidebar.html" with active_page='my_page' %}

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tut-main-content">
  <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>

  {% if person %}
    <section style="background: white; padding: 24px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
      <h2 style="margin-top: 0;">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
      
      <form method="post" enctype="multipart/form-data" style="max-width: 600px;">
        {% csrf_token %}
        
        <div style="margin-bottom: 20px; text-align: center;">
          {% if person.icon_picture %}
            <img src="{% static person.icon_picture %}" alt="ã‚¢ã‚¤ã‚³ãƒ³" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid #cc0000;">
          {% else %}
            <img src="{% static 'image/person.png' %}" alt="ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³" style="width: 80px; height: 80px; object-fit: cover;">
          {% endif %}
          <div style="margin-top: 12px;">
            <label for="id_icon" style="cursor: pointer; background: #0066cc; color: white; padding: 8px 16px; border-radius: 6px; display: inline-block;">
              ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ
            </label>
            <input type="file" name="icon" id="id_icon" accept="image/*" style="display: none;" onchange="previewIcon(this)">
          </div>
          <small style="display: block; margin-top: 8px; color: #666;">â€» ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (jpg, png, gif) ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</small>
        </div>

        <div style="margin-bottom: 20px;">
          <label for="id_nickname" style="display: block; margin-bottom: 6px; font-weight: 600;">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
          <input type="text" name="nickname" id="id_nickname" value="{{ person.nickname }}" maxlength="50" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box;">
          <small style="display: block; margin-top: 4px; color: #666;">â€» æœªè¨­å®šã®å ´åˆã¯å­¦ç±ç•ªå·ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
        </div>

        <button type="submit" style="padding: 12px 24px; background: #cc0000; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem;">
          ä¿å­˜
        </button>
      </form>

      <script>
        function previewIcon(input) {
          if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const img = input.closest('form').querySelector('img');
              img.src = e.target.result;
              img.style.width = '100px';
              img.style.height = '100px';
              img.style.borderRadius = '50%';
              img.style.border = '3px solid #cc0000';
            };
            reader.readAsDataURL(input.files[0]);
          }
        }
      </script>
    </section>

    <section style="background: white; padding: 24px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
      <h2 style="margin-top: 0;">ç™»éŒ²æƒ…å ±</h2>
      <ul style="list-style: none; padding: 0;">
        <li style="margin-bottom: 12px;"><strong>å­¦ç±ç•ªå·:</strong> {{ person.student_id }}</li>
        <li style="margin-bottom: 12px;"><strong>èª²ç¨‹:</strong> {{ person.get_course_display }}</li>
        <li style="margin-bottom: 12px;"><strong>å­¦å¹´:</strong> {{ person.grade }} å¹´</li>
        <li style="margin-bottom: 12px;"><strong>å­¦ç§‘ãƒ»å°‚æ”»:</strong> {{ person.department_name }}</li>
        <li style="margin-bottom: 12px;"><strong>ç ”ç©¶åˆ†é‡:</strong> {{ person.lab_field }}</li>
        <li style="margin-bottom: 12px;"><strong>ãƒã‚¤ãƒ³ãƒˆ:</strong> <strong style="font-size: 1.2rem; color: #cc0000;">{{ person.points }}</strong> pt</li>
        <li style="margin-bottom: 12px;"><strong>ç™»éŒ²æ—¥æ™‚:</strong> {{ person.created_at|date:"Y/m/d H:i" }}</li>
      </ul>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
        <a href="{% url 'shiokara:site_feedback' %}" style="
          display: inline-block;
          padding: 10px 20px;
          background: #0066cc;
          color: white;
          text-decoration: none;
          border-radius: 6px;
          transition: background 0.2s;
        " onmouseover="this.style.background='#0055aa'" onmouseout="this.style.background='#0066cc'">
          ğŸ’¬ ã‚µã‚¤ãƒˆè¦æœ›ã‚’é€ä¿¡ã—ã¦ãƒã‚¤ãƒ³ãƒˆç²å¾—
        </a>
      </div>
    </section>
  {% else %}
    <p>ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
  {% endif %}

    <section style="background: white; padding: 24px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">
      <h2 style="margin-top: 0;">ğŸ“… å°±æ´»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
      <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">ãŠæ°—ã«å…¥ã‚Šä¼æ¥­ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ãƒ»é¸è€ƒæ—¥ç¨‹ã‚’ç¢ºèªã§ãã¾ã™</p>
      
      <div id="calendar-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <button id="prev-month" style="padding: 8px 16px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">â—€ å‰æœˆ</button>
          <h3 id="current-month" style="margin: 0; font-size: 1.2rem;"></h3>
          <button id="next-month" style="padding: 8px 16px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">æ¬¡æœˆ â–¶</button>
        </div>
        
        <div id="calendar" style="border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;"></div>
        
        <div style="margin-top: 16px; display: flex; gap: 16px; flex-wrap: wrap; font-size: 0.85rem;">
          <div><span style="display: inline-block; width: 12px; height: 12px; background: #4caf50; border-radius: 2px; margin-right: 4px;"></span>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³é–‹å§‹</div>
          <div><span style="display: inline-block; width: 12px; height: 12px; background: #ff9800; border-radius: 2px; margin-right: 4px;"></span>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³ç· åˆ‡</div>
          <div><span style="display: inline-block; width: 12px; height: 12px; background: #2196f3; border-radius: 2px; margin-right: 4px;"></span>å‰å¹´åº¦é¸è€ƒé–‹å§‹</div>
        </div>
      </div>
      
      <script>
        // ãŠæ°—ã«å…¥ã‚Šä¼æ¥­ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
        const events = [
          {% for company in favorites %}
            {% if company.internship_start_date %}
              { date: '{{ company.internship_start_date|date:"Y-m-d" }}', type: 'start', company: '{{ company.name|escapejs }}' },
            {% endif %}
            {% if company.internship_deadline %}
              { date: '{{ company.internship_deadline|date:"Y-m-d" }}', type: 'deadline', company: '{{ company.name|escapejs }}' },
            {% endif %}
            {% if company.last_year_selection_start_date %}
              { date: '{{ company.last_year_selection_start_date|date:"Y-m-d" }}', type: 'selection', company: '{{ company.name|escapejs }}' },
            {% endif %}
          {% endfor %}
        ];

        let currentDate = new Date();

        function renderCalendar() {
          const year = currentDate.getFullYear();
          const month = currentDate.getMonth();
          
          // æœˆã®è¡¨ç¤º
          const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
          document.getElementById('current-month').textContent = year + 'å¹´ ' + monthNames[month];
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ä½œæˆ
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          
          let calendarHTML = '<table style="width: 100%; border-collapse: collapse;">';
          calendarHTML += '<thead><tr>';
          ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].forEach((day, i) => {
            const color = i === 0 ? '#e74c3c' : i === 6 ? '#3498db' : '#333';
            calendarHTML += `<th style="padding: 8px; background: #f5f5f5; border: 1px solid #e0e0e0; color: ${color};">${day}</th>`;
          });
          calendarHTML += '</tr></thead><tbody><tr>';
          
          // ç©ºç™½ã‚»ãƒ«
          for (let i = 0; i < firstDay; i++) {
            calendarHTML += '<td style="padding: 8px; border: 1px solid #e0e0e0;"></td>';
          }
          
          // æ—¥ä»˜ã‚»ãƒ«
          for (let day = 1; day <= daysInMonth; day++) {
            if ((firstDay + day - 1) % 7 === 0 && day !== 1) {
              calendarHTML += '</tr><tr>';
            }
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayEvents = events.filter(e => e.date === dateStr);
            
            let cellStyle = 'padding: 8px; border: 1px solid #e0e0e0; vertical-align: top; height: 60px;';
            let cellContent = `<div style="font-weight: 600; margin-bottom: 4px;">${day}</div>`;
            
            dayEvents.forEach(event => {
              const colors = { start: '#4caf50', deadline: '#ff9800', selection: '#2196f3' };
              const labels = { start: 'é–‹å§‹', deadline: 'ç· åˆ‡', selection: 'é¸è€ƒ' };
              cellContent += `<div style="font-size: 0.7rem; background: ${colors[event.type]}; color: white; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${event.company}">${labels[event.type]}</div>`;
            });
            
            calendarHTML += `<td style="${cellStyle}">${cellContent}</td>`;
          }
          
          // æ®‹ã‚Šã®ç©ºç™½ã‚»ãƒ«
          const remainingCells = (7 - (firstDay + daysInMonth) % 7) % 7;
          for (let i = 0; i < remainingCells; i++) {
            calendarHTML += '<td style="padding: 8px; border: 1px solid #e0e0e0;"></td>';
          }
          
          calendarHTML += '</tr></tbody></table>';
          document.getElementById('calendar').innerHTML = calendarHTML;
        }
        
        document.getElementById('prev-month').addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() - 1);
          renderCalendar();
        });
        
        document.getElementById('next-month').addEventListener('click', () => {
          currentDate.setMonth(currentDate.getMonth() + 1);
          renderCalendar();
        });
        
        // åˆå›æç”»
        renderCalendar();
      </script>
    </section>

    <h2>ãŠæ°—ã«å…¥ã‚Šä¼æ¥­</h2>
        {% if favorites %}
        <ul id="favorites-list">
            {% for c in favorites %}
                <li data-company-id="{{ c.pk }}">
                    <a href="{% url 'shiokara:company_detail' c.pk %}">{{ c.name }}</a>
                    <form method="post" action="{% url 'shiokara:company_favorite' c.pk %}" class="fav-form-inline" style="display:inline-block; margin-left:8px;">
                        {% csrf_token %}
                        <button type="submit" class="fav-remove-btn">â˜… ãŠæ°—ã«å…¥ã‚Šè§£é™¤</button>
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>ãŠæ°—ã«å…¥ã‚Šã¯ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
    {% endif %}

    <p>â€» ä¸Šã§è¡¨ç¤ºã•ã‚Œã‚‹ã®ã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã«ç™»éŒ²ã—ãŸãŠæ°—ã«å…¥ã‚Šä¼æ¥­ã§ã™ã€‚</p>

<!-- ======================== -->
<!-- ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« -->
<!-- ======================== -->
<style>
    #mypage-tut-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.55);
        z-index: 9998;
        display: none;
    }

    .mypage-tut-highlight {
        position: relative;
        z-index: 9999 !important;
        box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 0 6px rgba(255,255,255,0.05) inset;
        transform: translateZ(0) scale(1.02);
        transition: box-shadow 180ms ease, transform 180ms ease;
        outline: 3px solid rgba(76,175,80,0.95);
        border-radius: 8px;
    }

    #mypage-tut-tooltip {
        position: fixed;
        z-index: 10000;
        max-width: 320px;
        background: #fff;
        color: #222;
        border-radius: 8px;
        box-shadow: 0 6px 28px rgba(0,0,0,0.18);
        padding: 12px;
        display: none;
        font-size: 0.95rem;
    }

    #mypage-tut-tooltip #mypage-tut-controls {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
    }

    #mypage-tut-tooltip button {
        background: #f3f3f3;
        border: 1px solid #ddd;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    #mypage-tut-start-btn {
        position: fixed;
        right: 18px;
        bottom: 18px;
        z-index: 10001;
        background: linear-gradient(180deg, #4CAF50, #45a049);
        color: #fff;
        border: none;
        padding: 10px 14px;
        border-radius: 999px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.18);
        cursor: pointer;
        font-weight: 700;
        font-size: 0.9rem;
    }

    @media (max-width:640px) {
        #mypage-tut-tooltip { max-width: 260px; font-size: 0.9rem; }
        #mypage-tut-start-btn { right: 12px; bottom: 12px; font-size: 0.85rem; }
    }
</style>

<div id="mypage-tut-overlay" aria-hidden="true"></div>
<div id="mypage-tut-tooltip" aria-hidden="true" role="dialog" aria-label="ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½èª¬æ˜">
    <div id="mypage-tut-content"></div>
    <div id="mypage-tut-controls">
        <button id="mypage-tut-prev" type="button">æˆ»ã‚‹</button>
        <button id="mypage-tut-next" type="button">æ¬¡ã¸</button>
        <button id="mypage-tut-close" type="button">é–‰ã˜ã‚‹</button>
    </div>
</div>

<button id="mypage-tut-start-btn" aria-label="ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‹å§‹">ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆæƒ…å ±</button>

<script>
    (function(){
        const steps = [
            {
                sel: 'h1',
                title: 'ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ã‚ˆã†ã“ã',
                body: 'ã“ã“ã¯ã‚ãªãŸã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¨ã€æœ€ã‚‚é‡è¦ãªã€Œãƒã‚¤ãƒ³ãƒˆã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚'
            },
            {
                sel: 'li:has(> strong)',
                title: 'ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º',
                body: 'ã“ã®ã‚µã‚¤ãƒˆã§ã¯ãƒã‚¤ãƒ³ãƒˆåˆ¶åº¦ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆæ•°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚'
            },
            {
                sel: 'ul',
                title: 'ãƒã‚¤ãƒ³ãƒˆã®ä½¿ã„æ–¹',
                body: 'ä¼æ¥­è©³ç´°ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹ãŸã³ã«1ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ã•ã‚Œã¾ã™ã€‚åŒã˜ä¼æ¥­ã¯2å›ç›®ä»¥é™ã€ãƒã‚¤ãƒ³ãƒˆä¸è¦ã§ã™ã€‚'
            },
            {
                sel: 'p',
                title: 'ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã‚ˆã†',
                body: 'å£ã‚³ãƒŸã‚’æŠ•ç¨¿ã™ã‚‹ã¨5ãƒã‚¤ãƒ³ãƒˆç²å¾—ã§ãã¾ã™ã€‚ç©æ¥µçš„ã«æŠ•ç¨¿ã—ã¦ã€ãƒã‚¤ãƒ³ãƒˆã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ï¼'
            },
            {
                sel: 'h1',
                title: 'ãƒã‚¤ãƒ³ãƒˆæ©Ÿèƒ½ã®ã¾ã¨ã‚',
                body: 'åˆæœŸå€¤ï¼š10pt | æ¶ˆè²»ï¼šä¼æ¥­è©³ç´°-1pt | ç²å¾—ï¼šå£ã‚³ãƒŸæŠ•ç¨¿+5pt'
            }
        ];

        let idx = 0;
        const overlay = document.getElementById('mypage-tut-overlay');
        const tooltip = document.getElementById('mypage-tut-tooltip');
        const content = document.getElementById('mypage-tut-content');
        const btnPrev = document.getElementById('mypage-tut-prev');
        const btnNext = document.getElementById('mypage-tut-next');
        const btnClose = document.getElementById('mypage-tut-close');
        const startBtn = document.getElementById('mypage-tut-start-btn');

        function showStep(i){
            document.querySelectorAll('.mypage-tut-highlight').forEach(el=>el.classList.remove('mypage-tut-highlight'));
            tooltip.style.display = 'none';
            overlay.style.display = 'block';

            const step = steps[i];
            if(!step) { endTutorial(); return; }
            const target = document.querySelector(step.sel);
            content.innerHTML = '<strong>'+step.title+'</strong><div style="margin-top:6px;">'+step.body+'</div>';

            if(target){
                target.classList.add('mypage-tut-highlight');
                const r = target.getBoundingClientRect();
                const tt = tooltip;
                const margin = 100;
                let top = window.scrollY + r.bottom + margin;
                let left = window.scrollX + r.left;
                left = Math.min(Math.max(left, 8 + window.scrollX), window.scrollX + document.documentElement.clientWidth - tt.offsetWidth - 8);
                tt.style.top = top + 'px';
                tt.style.left = left + 'px';
                tt.style.display = 'block';
                btnNext.focus();
            } else {
                const tt = tooltip;
                tt.style.top = (window.scrollY + window.innerHeight/2 - 80) + 'px';
                tt.style.left = (window.scrollX + (window.innerWidth - tt.offsetWidth)/2) + 'px';
                tt.style.display = 'block';
            }

            btnPrev.disabled = (i===0);
            btnNext.textContent = (i === steps.length -1) ? 'å®Œäº†' : 'æ¬¡ã¸';
            idx = i;
        }

        function nextStep(){
            if(idx < steps.length -1) showStep(idx+1);
            else endTutorial();
        }
        function prevStep(){ if(idx>0) showStep(idx-1); }

        function startTutorial(){
            showStep(0);
            overlay.style.display = 'block';
            document.body.classList.add('mypage-tut-in-progress');
        }

        function endTutorial(){
            overlay.style.display = 'none';
            tooltip.style.display = 'none';
            document.querySelectorAll('.mypage-tut-highlight').forEach(el=>el.classList.remove('mypage-tut-highlight'));
            document.body.classList.remove('mypage-tut-in-progress');
        }

        btnNext.addEventListener('click', nextStep);
        btnPrev.addEventListener('click', prevStep);
        btnClose.addEventListener('click', endTutorial);
        overlay.addEventListener('click', endTutorial);
        startBtn.addEventListener('click', startTutorial);

        document.addEventListener('keydown', (ev)=>{
            if(!document.body.classList.contains('mypage-tut-in-progress')) return;
            if(ev.key === 'Escape') endTutorial();
            if(ev.key === 'ArrowRight' || ev.key === 'Enter') nextStep();
            if(ev.key === 'ArrowLeft') prevStep();
        });

        window.__mypage_tut_start = startTutorial;
    })();
</script>
<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.fav-form-inline').forEach(function(form){
        form.addEventListener('submit', function(ev){
            ev.preventDefault();
            var li = form.closest('li');
            var csrftoken = form.querySelector('input[name=csrfmiddlewaretoken]')?.value;
            fetch(form.action, { method: 'POST', headers: { 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': csrftoken } })
                .then(r=>r.json()).then(function(data){
                    if(data && data.ok){
                        // ãŠæ°—ã«å…¥ã‚Šè§£é™¤ãªã‚‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                        if(!data.added && li){ li.remove(); }
                    }
                }).catch(function(){ form.submit(); });
        });
    });
});
</script>
    </div>
</div>
{% endblock %}
