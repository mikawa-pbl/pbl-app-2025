
{% load static %}
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      html,
      body {
        background-color: #fbfef9;
        margin: 0;
        padding: 0;
        font-family: "Noto Sans JP", sans-serif;
      }

      /* 戻るボタン */
      .back-btn {
        position: relative;
        top: 32px;
        left: 32px;
        font-size: 48px;
        color: #649ce4;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 9999;
      }
      .back-btn:focus {
        outline: none;
      }

      /* ===== ページ中央寄せコンテナ ===== */
      .page {
        width: 100%;
        position: relative;
        display: flex;
        justify-content: center;
        box-sizing: border-box;
      }

      .card {
        width: 100%;
        max-width: 576px;
        background: #fbfef9;
        border-radius: 24px;
        padding: 24px;
        box-sizing: border-box;
      }

      .title {
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 18px;
        color: #111;
      }

      .field {
        margin-bottom: 16px;
      }
      .label {
        display: block;
        font-size: 14px;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
        text-align: left;
      }

      .input,
      .textarea,
      .select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1.5px solid rgba(100, 156, 228, 0.35);
        background: white;
        box-sizing: border-box;
        font-size: 16px;
        outline: none;
      }
      .textarea {
        min-height: 120px;
        resize: vertical;
      }

      /* ===== selectをinput寄せにする ===== */
      .select-wrap {
        position: relative;
        width: 100%;
      }

      .select-wrap .select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;

        background: white;
        border: 1.5px solid rgba(100, 156, 228, 0.35);
        border-radius: 14px;
        padding: 12px 44px 12px 14px;
        font-size: 16px;
        line-height: 1.2;
        cursor: pointer;
      }

      .select-wrap::after {
        content: "\f078"; /* fa-chevron-down */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #649ce4;
        pointer-events: none;
        font-size: 14px;
      }

      .select-wrap .select:focus,
      .input:focus,
      .textarea:focus {
        border-color: rgba(100, 156, 228, 0.8);
        box-shadow: 0 0 0 4px rgba(100, 156, 228, 0.15);
      }

      /* 商品状態はrequiredなのでこれで薄色placeholder化できる */
      .select-wrap .select:invalid {
        color: #888;
      }

      /* ===== 画像アップロード ===== */
      .uploader {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .thumbs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .thumb {
      width: 92px;
      height: 92px;
      border-radius: 16px;
      border: 1.5px dashed rgba(100,156,228,0.6);
      background: #FBFEF9;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-sizing: border-box;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .thumb .empty {
      color: rgba(100,156,228,0.9);
      font-size: 28px;
    }
      .thumb .remove-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 26px;
        height: 26px;
        border-radius: 999px;
        border: none;
        background: rgba(0,0,0,0.6);
        color: white;
        font-weight: 700;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        line-height: 1;
      }
      .thumb .remove-btn:focus { outline: 2px solid rgba(100,156,228,0.6); }

      .upload-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        background: #649ce4;
        color: white;
        font-size: 14px;
        font-weight: 700;
        border-radius: 999px;
        padding: 10px 14px;
        cursor: pointer;
        white-space: nowrap;
      }
      .upload-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .file-input {
        display: none;
      }

      /* ===== 学年タグ（複数） ===== */
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #eaf2ff;
        color: #2a5db0;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 13px;
        font-weight: 700;
      }
      .chip button {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #2a5db0;
        font-size: 14px;
        line-height: 1;
        padding: 0;
      }

      /* ===== 出品ボタン ===== */
      .actions {
        margin-top: 22px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }
      .submit-btn {
        width: 100%;
        border: none;
        background: #f96796;
        color: white;
        font-size: 16px;
        font-weight: 700;
        border-radius: 18px;
        padding: 14px 16px;
        cursor: pointer;
      }

      /* 削除チェックボックスを非表示 */
      input[name="delete_images"] {
        display: none;
      }

      @media (min-width: 768px) {
        .card {
          padding: 28px;
        }
        .title {
          font-size: 22px;
        }
      }
    </style>

    <script>
      function goBack() {
        if (window.history.length > 1) {
          history.back();
        } else if (document.referrer) {
          window.location.href = document.referrer;
        } else {
          window.location.href = "{% url 'takenoko:main' %}";
        }
      }

      // ===== 画像プレビュー（最大5枚） =====
      const MAX_IMAGES = 5;
      let selectedFiles = [];
      const existingImages = [{% for img in item.images.all %}{url: '{{ img.image.url }}', id: {{ img.id }}},{% endfor %}];
      const deletedImageIds = new Set();

      function $(id) {
        return document.getElementById(id);
      }

      function syncInputFiles() {
        const dt = new DataTransfer();
        selectedFiles.forEach(f => dt.items.add(f));
        $("images").files = dt.files;
      }

      function renderThumbs() {
        const container = $("allImages");
        container.innerHTML = "";

        const visibleExistingImages = existingImages.filter(img => !deletedImageIds.has(img.id));

        // 既存画像
        visibleExistingImages.forEach((img, idx) => {
          const box = document.createElement("div");
          box.className = "thumb";
          box.innerHTML = `<img src="${img.url}" alt="img${idx + 1}"><button type="button" class="remove-btn" aria-label="画像を削除" onclick="toggleDelete(${img.id})">×</button>`;
          container.appendChild(box);
        });

        // 新規画像
        selectedFiles.forEach((file, idx) => {
          const url = URL.createObjectURL(file);
          const box = document.createElement("div");
          box.className = "thumb";
          box.innerHTML = `<img src="${url}" alt="画像${idx+1}"><button type="button" class="remove-btn" aria-label="画像を削除" onclick="removeImage(${idx})">×</button>`;
          container.appendChild(box);
        });

        // 空のスロット
        const totalImages = visibleExistingImages.length + selectedFiles.length;
        for (let i = totalImages; i < MAX_IMAGES; i++) {
          const box = document.createElement("div");
          box.className = "thumb";
          box.innerHTML = `<div class="empty"><i class="fas fa-image"></i></div>`;
          container.appendChild(box);
        }

        // ボタンのdisabled
        const pickBtn = $("pickBtn");
        if (pickBtn) pickBtn.disabled = totalImages >= MAX_IMAGES;
      }

      function removeImage(index) {
        if (index < 0 || index >= selectedFiles.length) return;
        selectedFiles.splice(index, 1);
        syncInputFiles();
        renderThumbs();
      }

      function toggleDelete(id) {
        if (deletedImageIds.has(id)) {
          deletedImageIds.delete(id);
          let checkbox = document.querySelector(`input[name="delete_images"][value="${id}"]`);
          if (checkbox) checkbox.remove();
        } else {
          deletedImageIds.add(id);
          const newCheckbox = document.createElement("input");
          newCheckbox.type = "checkbox";
          newCheckbox.name = "delete_images";
          newCheckbox.value = id;
          newCheckbox.checked = true;
          document.getElementById("sellForm").appendChild(newCheckbox);
        }
        renderThumbs();
      }

      function addImages(fileList) {
        const files = Array.from(fileList || []);
        if (files.length === 0) return;

        const canAdd = Math.max(0, MAX_IMAGES - existingImages.length - selectedFiles.length);
        selectedFiles = selectedFiles.concat(files.slice(0, canAdd));

        syncInputFiles();
        renderThumbs();
      }

      function removeImage(index) {
        selectedFiles.splice(index, 1);
        const dt = new DataTransfer();
        selectedFiles.forEach((f) => dt.items.add(f));
        $("images").files = dt.files;
        renderThumbs();
      }

      function toggleExistingImageDelete(imgId) {
        const el = $("existing_img_" + imgId);
        const hidden = $("delete_img_" + imgId);
        if (!el || !hidden) return;
        const marked = el.classList.toggle("marked");
        const btn = el.querySelector(".remove-btn");
        if (marked) {
          if (btn) btn.textContent = "×";
          hidden.disabled = false;
        } else {
          if (btn) btn.textContent = "×";
          hidden.disabled = true;
        }
        updatePickBtnState();
      }

      function updatePickBtnState() {
        const existing = document.querySelectorAll("#existingThumbs .thumb").length;
        const toBeDeleted = document.querySelectorAll("#existingThumbs input[type='hidden']:not([disabled])").length;
        const existingRemaining = Math.max(0, existing - toBeDeleted);
        const total = existingRemaining + selectedFiles.length;
        $("pickBtn").disabled = total >= MAX_IMAGES || selectedFiles.length >= MAX_IMAGES;
      }

      // ===== 対象学年タグ select の色（required無しでも薄色placeholder化） =====
      function updateGradeSelectColor() {
        const sel = $("gradeSelect");
        if (!sel) return;
        sel.style.color = sel.value ? "#333" : "#888";
      }

      // ===== 対象学年タグ（複数選択） =====
      function addGradeTag() {
        const sel = $("gradeSelect");
        const val = sel.value;
        const text = sel.options[sel.selectedIndex]?.text || "";
        if (!val) return;

        const exists = document.querySelector(
          `input[name="grades"][value="${val}"]`
        );
        if (exists) return;

        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "grades";
        hidden.value = val;
        $("gradeHidden").appendChild(hidden);

        const chip = document.createElement("span");
        chip.className = "chip";
        chip.setAttribute("data-grade", val);
        chip.innerHTML = `${text}<button type="button" aria-label="削除" onclick="removeGradeTag('${val}')">×</button>`;
        $("gradeChips").appendChild(chip);

        sel.value = "";
        updateGradeSelectColor();
      }

      function removeGradeTag(val) {
        const chip = document.querySelector(`.chip[data-grade="${val}"]`);
        if (chip) chip.remove();
        const hidden = document.querySelector(
          `input[name="grades"][value="${val}"]`
        );
        if (hidden) hidden.remove();
      }

      // ===== カテゴリタグ select の色 =====
      function updateTagSelectColor() {
        const sel = $("tagSelect");
        if (!sel) return;
        sel.style.color = sel.value ? "#333" : "#888";
      }

      // ===== カテゴリタグ（複数選択） =====
      function addCategoryTag() {
        const sel = $("tagSelect");
        const val = sel.value;
        const text = sel.options[sel.selectedIndex]?.text || "";
        if (!val) return;

        const exists = document.querySelector(`input[name="tags"][value="${val}"]`);
        if (exists) return;

        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "tags";
        hidden.value = val;
        $("tagHidden").appendChild(hidden);

        const chip = document.createElement("span");
        chip.className = "chip";
        chip.setAttribute("data-tag", val);
        chip.innerHTML = `${text}<button type="button" aria-label="削除" onclick="removeCategoryTag('${val}')">×</button>`;
        $("tagChips").appendChild(chip);

        sel.value = "";
        updateTagSelectColor();
      }

      function removeCategoryTag(val) {
        const chip = document.querySelector(`.chip[data-tag="${val}"]`);
        if (chip) chip.remove();
        const hidden = document.querySelector(`input[name="tags"][value="${val}"]`);
        if (hidden) hidden.remove();
      }

      function getOptionText(selectId, val) {
        const sel = $(selectId);
        const opt = sel.querySelector(`option[value="${val}"]`);
        return opt ? opt.text : "";
      }

      function addHiddenAndChip(name, val, text, chipsId, dataAttr) {
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = name;
        hidden.value = val;
        $(name + "Hidden").appendChild(hidden);

        const chip = document.createElement("span");
        chip.className = "chip";
        chip.setAttribute("data-" + dataAttr, val);
        chip.innerHTML = `${text}<button type="button" aria-label="削除" onclick="remove${name.charAt(0).toUpperCase() + name.slice(1)}Tag('${val}')">×</button>`;
        $(chipsId).appendChild(chip);
      }

      // ===== 価格入力（最大99999 / 数字のみ） =====
      function normalizePrice() {
        const el = $("price");
        el.value = el.value.replace(/[０-９]/g, (s) =>
          String.fromCharCode(s.charCodeAt(0) - 0xfee0)
        );
        el.value = el.value.replace(/[^0-9]/g, "");
        const n = Number(el.value || 0);
        if (n > 999999) el.value = "999999";
      }

      window.addEventListener("DOMContentLoaded", () => {
        renderThumbs();
        $("images").addEventListener("change", (e) =>
          addImages(e.target.files)
        );
        $("price").addEventListener("input", normalizePrice);

        // 対象学年タグは任意：送信ブロックなし
        updateGradeSelectColor();
        $("gradeSelect").addEventListener("change", updateGradeSelectColor);

        updateTagSelectColor();
        $("tagSelect").addEventListener("change", updateTagSelectColor);

        // エラー再表示時、選択を復元（必要なときだけ配列に値が入る）
        const PRESELECTED_GRADES = {{ selected_grades|safe }};
        const PRESELECTED_TAGS = {{ selected_tags|safe }};
        PRESELECTED_GRADES.forEach(val => {
          const text = getOptionText("gradeSelect", val);
          addHiddenAndChip("grades", val, text, "gradeChips", "grade");
        });
        PRESELECTED_TAGS.forEach(val => {
          const text = getOptionText("tagSelect", val);
          addHiddenAndChip("tags", val, text, "tagChips", "tag");
        });
      });
    </script>
  </head>

  <body>
    {% include "teams/takenoko/Components/header.html" %}

    <button type="button" class="back-btn" onclick="goBack()" aria-label="戻る">
      <i class="fas fa-arrow-alt-circle-left"></i>
    </button>

    <main class="page">
      <section class="card">
        <h1 class="title">商品を編集</h1>

        <form action="" id="sellForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- 画像 -->
          <div class="field">
            <label class="label">画像</label>
            <div id="allImages" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
            <p class="text-sm text-gray-500 mt-2">※ 最大5枚</p>
          </div>

          <!-- 新規画像追加 -->
          <div class="field">
            <label class="upload-btn" id="pickBtn" for="images">
                <i class="fas fa-plus"></i> 画像を追加
              </label>
              <input
                id="images"
                name="images"
                class="file-input"
                type="file"
                accept="image/*"
                multiple
              />
          </div>

          <!-- 商品名 -->
          <div class="field">
            <label class="label" for="name">商品名</label>
            <input
              id="name"
              name="name"
              class="input"
              type="text"
              required
              value="{{ form.name.value|default_if_none:'' }}"
            />
          </div>

          <!-- 価格 -->
          <div class="field">
            <label class="label" for="price">商品価格</label>
            <input
              id="price"
              name="price"
              class="input"
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              maxlength="6"
              required
              value="{{ form.price.value|default_if_none:'' }}"
            />
          </div>

          <!-- 商品詳細 -->
          <div class="field">
            <label class="label" for="description">商品詳細</label>
            <textarea
              id="description"
              name="description"
              class="textarea"
              maxlength="300"
              required
            >{{ form.description.value|default_if_none:'' }}</textarea>
          </div>

          <!-- 商品状態（choicesをフォームから動的表示） -->
          <div class="field">
            <label class="label" for="condition">商品状態</label>
            <div class="select-wrap">
              <select id="condition" name="condition" class="select" required>
                <option value="" disabled {% if not form.condition.value %}selected{% endif %}>選択してください</option>
                {% for val, label in form.fields.condition.choices %}
                  <option value="{{ val }}" {% if form.condition.value == val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- 対象学年（DBのTargetGrade） -->
          <div class="field">
            <label class="label" for="gradeSelect">対象学年タグ（複数可）</label>
            <div style="display:flex; gap:10px;">
              <div class="select-wrap" style="flex:1;">
                <select id="gradeSelect" class="select">
                  <option value="" selected disabled>追加する学年を選択</option>
                  {% for val, label in form.fields.grades.choices %}
                    <option value="{{ val }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <button type="button" class="upload-btn" onclick="addGradeTag()"><i class="fas fa-tag"></i> 追加</button>
            </div>
            <div id="gradeHidden">
              {% for g in selected_grades %}
                <input type="hidden" name="grades" value="{{ g }}">
              {% endfor %}
            </div>
            <div class="chips" id="gradeChips">
              {% for g in selected_grades %}
                <span class="chip" data-grade="{{ g }}">
                  {% for val, label in form.fields.grades.choices %}
                    {% if val == g %}{{ label }}{% endif %}
                  {% endfor %}
                  <button type="button" aria-label="削除" onclick="removeGradeTag('{{ g }}')">×</button>
                </span>
              {% endfor %}
            </div>
          </div>

          <!-- タグ（Tagモデル） -->
          <div class="field">
            <label class="label" for="tagSelect">カテゴリタグ（複数可）</label>
            <div style="display:flex; gap:10px;">
              <div class="select-wrap" style="flex:1;">
                <select id="tagSelect" class="select">
                  <option value="" selected disabled>追加するタグを選択</option>
                  {% for val, label in form.fields.tags.choices %}
                    <option value="{{ val }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <button type="button" class="upload-btn" onclick="addCategoryTag()"><i class="fas fa-tag"></i> 追加</button>
            </div>
            <div id="tagHidden">
              {% for t in selected_tags %}
                <input type="hidden" name="tags" value="{{ t }}">
              {% endfor %}
            </div>
            <div class="chips" id="tagChips">
              {% for t in selected_tags %}
                <span class="chip" data-tag="{{ t }}">
                  {% for val, label in form.fields.tags.choices %}
                    {% if val == t %}{{ label }}{% endif %}
                  {% endfor %}
                  <button type="button" aria-label="削除" onclick="removeCategoryTag('{{ t }}')">×</button>
                </span>
              {% endfor %}
            </div>
          </div>

          <!-- 送信 -->
          <div class="actions">
            <button type="submit" class="submit-btn">編集する</button>
          </div>
        </form>
      </section>
    </main>
  </body>
</html>
