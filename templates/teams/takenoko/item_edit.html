{% load static %}
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      html,
      body {
        background-color: #fbfef9;
        margin: 0;
        padding: 0;
        font-family: "Noto Sans JP", sans-serif;
      }

      /* 戻るボタン */
      .back-btn {
        position: relative;
        top: 32px;
        left: 32px;
        font-size: 48px;
        color: #649ce4;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 9999;
      }
      .back-btn:focus {
        outline: none;
      }

      /* ===== ページ中央寄せコンテナ ===== */
      .page {
        width: 100%;
        position: relative;
        display: flex;
        justify-content: center;
        box-sizing: border-box;
      }

      .card {
        width: 100%;
        max-width: 576px;
        background: #fbfef9;
        border-radius: 24px;
        padding: 24px;
        box-sizing: border-box;
      }

      .title {
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 18px;
        color: #111;
      }

      .field {
        margin-bottom: 16px;
      }
      .label {
        display: block;
        font-size: 14px;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
        text-align: left;
      }

      .input,
      .textarea,
      .select {
        width: 100%;
        padding: 12px 14px;
        border-radius: 14px;
        border: 1.5px solid rgba(100, 156, 228, 0.35);
        background: white;
        box-sizing: border-box;
        font-size: 16px;
        outline: none;
      }
      .textarea {
        min-height: 120px;
        resize: vertical;
      }

      /* ===== selectをinput寄せにする ===== */
      .select-wrap {
        position: relative;
        width: 100%;
      }

      .select-wrap .select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;

        background: white;
        border: 1.5px solid rgba(100, 156, 228, 0.35);
        border-radius: 14px;
        padding: 12px 44px 12px 14px;
        font-size: 16px;
        line-height: 1.2;
        cursor: pointer;
      }

      .select-wrap::after {
        content: "\f078"; /* fa-chevron-down */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        position: absolute;
        right: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: #649ce4;
        pointer-events: none;
        font-size: 14px;
      }

      .select-wrap .select:focus,
      .input:focus,
      .textarea:focus {
        border-color: rgba(100, 156, 228, 0.8);
        box-shadow: 0 0 0 4px rgba(100, 156, 228, 0.15);
      }

      /* 商品状態はrequiredなのでこれで薄色placeholder化できる */
      .select-wrap .select:invalid {
        color: #888;
      }

      /* ===== 画像アップロード ===== */
      .uploader {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      .thumbs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .thumb {
        width: 96px;
        height: 96px;
        border-radius: 16px;
        border: 1.5px dashed rgba(100, 156, 228, 0.6);
        background: #fbfef9;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        box-sizing: border-box;
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .thumb.marked {
        opacity: 0.5;
        filter: grayscale(80%);
      }
      .remove-btn {
        position: absolute;
        right: 6px;
        top: 6px;
        border: none;
        background: rgba(255,255,255,0.9);
        color: #333;
        border-radius: 999px;
        padding: 4px 8px;
        font-weight: 700;
        cursor: pointer;
      }
      .remove-btn:focus { outline: none; }
      .thumb .empty {
        color: rgba(100, 156, 228, 0.9);
        font-size: 28px;
      }

      .upload-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        background: #649ce4;
        color: white;
        font-size: 14px;
        font-weight: 700;
        border-radius: 999px;
        padding: 10px 14px;
        cursor: pointer;
        white-space: nowrap;
      }
      .upload-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .file-input {
        display: none;
      }

      /* ===== 学年タグ（複数） ===== */
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #eaf2ff;
        color: #2a5db0;
        border-radius: 999px;
        padding: 6px 10px;
        font-size: 13px;
        font-weight: 700;
      }
      .chip button {
        border: none;
        background: transparent;
        cursor: pointer;
        color: #2a5db0;
        font-size: 14px;
        line-height: 1;
        padding: 0;
      }

      /* ===== 出品ボタン ===== */
      .actions {
        margin-top: 22px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
      }
      .submit-btn {
        width: 100%;
        border: none;
        background: #f96796;
        color: white;
        font-size: 16px;
        font-weight: 700;
        border-radius: 18px;
        padding: 14px 16px;
        cursor: pointer;
      }

      @media (min-width: 768px) {
        .card {
          padding: 28px;
        }
        .title {
          font-size: 22px;
        }
      }
    </style>

    <script>
      function goBack() {
        if (window.history.length > 1) {
          history.back();
        } else if (document.referrer) {
          window.location.href = document.referrer;
        } else {
          window.location.href = "{% url 'takenoko:main' %}";
        }
      }

      // ===== 画像プレビュー（最大5枚） =====
      const MAX_IMAGES = 5;
      let selectedFiles = [];

      function $(id) {
        return document.getElementById(id);
      }

      function renderThumbs() {
        const thumbs = $("thumbs");
        thumbs.innerHTML = "";

        selectedFiles.forEach((file, idx) => {
          const url = URL.createObjectURL(file);
          const box = document.createElement("div");
          box.className = "thumb";
          box.innerHTML = `<img src="${url}" alt="画像${idx + 1}"><button type="button" class="remove-btn" aria-label="画像を取り消す" onclick="removeImage(${idx})">×</button>`;
          thumbs.appendChild(box);
        });

        for (let i = selectedFiles.length; i < MAX_IMAGES; i++) {
          const box = document.createElement("div");
          box.className = "thumb";
          box.innerHTML = `<div class="empty"><i class="fas fa-image"></i></div>`;
          thumbs.appendChild(box);
        }

        updatePickBtnState();
      }

      function addImages(fileList) {
        const files = Array.from(fileList || []);
        if (files.length === 0) return;

        const existing = document.querySelectorAll("#existingThumbs .thumb").length;
        const toBeDeleted = document.querySelectorAll("#existingThumbs input[type='hidden']:not([disabled])").length;
        const existingRemaining = Math.max(0, existing - toBeDeleted);

        const canAdd = Math.max(0, MAX_IMAGES - existingRemaining - selectedFiles.length);
        selectedFiles = selectedFiles.concat(files.slice(0, canAdd));

        const dt = new DataTransfer();
        selectedFiles.forEach((f) => dt.items.add(f));
        $("images").files = dt.files;

        renderThumbs();
      }

      function removeImage(index) {
        selectedFiles.splice(index, 1);
        const dt = new DataTransfer();
        selectedFiles.forEach((f) => dt.items.add(f));
        $("images").files = dt.files;
        renderThumbs();
      }

      function toggleExistingImageDelete(imgId) {
        const el = $("existing_img_" + imgId);
        const hidden = $("delete_img_" + imgId);
        if (!el || !hidden) return;
        const marked = el.classList.toggle("marked");
        const btn = el.querySelector(".remove-btn");
        if (marked) {
          if (btn) btn.textContent = "取り消す";
          hidden.disabled = false;
        } else {
          if (btn) btn.textContent = "削除";
          hidden.disabled = true;
        }
        updatePickBtnState();
      }

      function updatePickBtnState() {
        const existing = document.querySelectorAll("#existingThumbs .thumb").length;
        const toBeDeleted = document.querySelectorAll("#existingThumbs input[type='hidden']:not([disabled])").length;
        const existingRemaining = Math.max(0, existing - toBeDeleted);
        const total = existingRemaining + selectedFiles.length;
        $("pickBtn").disabled = total >= MAX_IMAGES || selectedFiles.length >= MAX_IMAGES;
      }

      // ===== 対象学年タグ select の色（required無しでも薄色placeholder化） =====
      function updateGradeSelectColor() {
        const sel = $("gradeSelect");
        if (!sel) return;
        sel.style.color = sel.value ? "#333" : "#888";
      }

      // ===== 対象学年タグ（複数選択） =====
      function addGradeTag() {
        const sel = $("gradeSelect");
        const val = sel.value;
        const text = sel.options[sel.selectedIndex]?.text || "";
        if (!val) return;

        const exists = document.querySelector(
          `input[name="grades"][value="${val}"]`
        );
        if (exists) return;

        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "grades";
        hidden.value = val;
        $("gradeHidden").appendChild(hidden);

        const chip = document.createElement("span");
        chip.className = "chip";
        chip.setAttribute("data-grade", val);
        chip.innerHTML = `${text}<button type="button" aria-label="削除" onclick="removeGradeTag('${val}')">×</button>`;
        $("gradeChips").appendChild(chip);

        sel.value = "";
        updateGradeSelectColor();
      }

      function removeGradeTag(val) {
        const chip = document.querySelector(`.chip[data-grade="${val}"]`);
        if (chip) chip.remove();
        const hidden = document.querySelector(
          `input[name="grades"][value="${val}"]`
        );
        if (hidden) hidden.remove();
      }

      // ===== 価格入力（最大99999 / 数字のみ） =====
      function normalizePrice() {
        const el = $("price");
        el.value = el.value.replace(/[０-９]/g, (s) =>
          String.fromCharCode(s.charCodeAt(0) - 0xfee0)
        );
        el.value = el.value.replace(/[^0-9]/g, "");
        const n = Number(el.value || 0);
        if (n > 999999) el.value = "999999";
      }

      window.addEventListener("DOMContentLoaded", () => {
        renderThumbs();
        $("images").addEventListener("change", (e) =>
          addImages(e.target.files)
        );
        $("price").addEventListener("input", normalizePrice);

        // 対象学年タグは任意：送信ブロックなし
        updateGradeSelectColor();
        $("gradeSelect").addEventListener("change", updateGradeSelectColor);

        // 初期のピックボタン状態を計算
        updatePickBtnState();
      });
    </script>
  </head>

  <body>
    {% include "teams/takenoko/Components/header.html" %}

    <button type="button" class="back-btn" onclick="goBack()" aria-label="戻る">
      <i class="fas fa-arrow-alt-circle-left"></i>
    </button>

    <main class="page">
      <section class="card">
        <h1 class="title">商品を編集</h1>

        <form action="" id="sellForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <!-- 既存画像（クリックで削除/取り消し） -->
          <div class="field">
            <label class="label">登録済み画像（クリックで削除を切替）</label>
            <div style="display:flex; gap:12px; flex-wrap:wrap;" id="existingThumbs">
              {% for img in item.images.all %}
                <div class="thumb{% if delete_images and img.id|stringformat:"s" in delete_images %} marked{% endif %}" id="existing_img_{{ img.id }}" data-img-id="{{ img.id }}" style="width:120px; height:120px;">
                  <img src="{{ img.image.url }}" alt="img{{ forloop.counter }}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">
                  {% if delete_images and img.id|stringformat:"s" in delete_images %}
                    <button type="button" class="remove-btn" aria-label="既存画像を削除" onclick="toggleExistingImageDelete({{ img.id }})">取り消す</button>
                    <input type="hidden" name="delete_images" value="{{ img.id }}" id="delete_img_{{ img.id }}">
                  {% else %}
                    <button type="button" class="remove-btn" aria-label="既存画像を削除" onclick="toggleExistingImageDelete({{ img.id }})">削除</button>
                    <input type="hidden" name="delete_images" value="{{ img.id }}" id="delete_img_{{ img.id }}" disabled>
                  {% endif %}
                </div>
              {% empty %}
                <p style="color:#888;">登録済み画像はありません。</p>
              {% endfor %}
            </div>
            <p class="text-sm text-gray-500 mt-2">※ 最大5枚。削除後＋追加分が5枚以内になるようにしてください。</p>
          </div>

          <!-- 新規画像追加 -->
          <div class="field">
            <label class="label" for="images">画像を追加（複数可・5MB以下）</label>

            <div class="uploader">
              <div class="thumbs" id="thumbs"></div>

              <div style="display:flex; flex-direction:column; gap:8px;">
                <label class="upload-btn" id="pickBtn" for="images"><i class="fas fa-plus"></i> 画像を追加</label>
                <input id="images" name="images" class="file-input" type="file" accept="image/*" multiple />
              </div>
            </div>
          </div>

          <!-- 商品名 -->
          <div class="field">
            <label class="label" for="name">商品名</label>
            <input
              id="name"
              name="name"
              class="input"
              type="text"
              required
              value="{{ form.name.value|default_if_none:'' }}"
            />
          </div>

          <!-- 価格 -->
          <div class="field">
            <label class="label" for="price">商品価格</label>
            <input
              id="price"
              name="price"
              class="input"
              type="text"
              inputmode="numeric"
              pattern="[0-9]*"
              maxlength="6"
              required
              value="{{ form.price.value|default_if_none:'' }}"
            />
          </div>

          <!-- 商品詳細 -->
          <div class="field">
            <label class="label" for="description">商品詳細</label>
            <textarea
              id="description"
              name="description"
              class="textarea"
              maxlength="300"
              required
            >{{ form.description.value|default_if_none:'' }}</textarea>
          </div>

          <!-- 商品状態（choicesをフォームから動的表示） -->
          <div class="field">
            <label class="label" for="condition">商品状態</label>
            <div class="select-wrap">
              <select id="condition" name="condition" class="select" required>
                <option value="" disabled {% if not form.condition.value %}selected{% endif %}>選択してください</option>
                {% for val, label in form.fields.condition.choices %}
                  <option value="{{ val }}" {% if form.condition.value == val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- 対象学年（DBのTargetGrade） -->
          <div class="field">
            <label class="label" for="gradeSelect">対象学年タグ（複数可）</label>
            <div style="display:flex; gap:10px;">
              <div class="select-wrap" style="flex:1;">
                <select id="gradeSelect" class="select">
                  <option value="" selected disabled>追加する学年を選択</option>
                  {% for val, label in form.fields.grades.choices %}
                    <option value="{{ val }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <button type="button" class="upload-btn" onclick="addGradeTag()"><i class="fas fa-tag"></i> 追加</button>
            </div>
            <div id="gradeHidden">
              {% for g in selected_grades %}
                <input type="hidden" name="grades" value="{{ g }}">
              {% endfor %}
            </div>
            <div class="chips" id="gradeChips">
              {% for g in selected_grades %}
                <span class="chip" data-grade="{{ g }}">
                  {% for val, label in form.fields.grades.choices %}
                    {% if val == g %}{{ label }}{% endif %}
                  {% endfor %}
                  <button type="button" aria-label="削除" onclick="removeGradeTag('{{ g }}')">×</button>
                </span>
              {% endfor %}
            </div>
          </div>

          <!-- タグ（Tagモデル） -->
          <div class="field">
            <label class="label" for="tagSelect">カテゴリタグ（複数可）</label>
            <div style="display:flex; gap:10px;">
              <div class="select-wrap" style="flex:1;">
                <select id="tagSelect" class="select">
                  <option value="" selected disabled>追加するタグを選択</option>
                  {% for val, label in form.fields.tags.choices %}
                    <option value="{{ val }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <button type="button" class="upload-btn" onclick="addCategoryTag()"><i class="fas fa-tag"></i> 追加</button>
            </div>
            <div id="tagHidden">
              {% for t in selected_tags %}
                <input type="hidden" name="tags" value="{{ t }}">
              {% endfor %}
            </div>
            <div class="chips" id="tagChips">
              {% for t in selected_tags %}
                <span class="chip" data-tag="{{ t }}">
                  {% for val, label in form.fields.tags.choices %}
                    {% if val == t %}{{ label }}{% endif %}
                  {% endfor %}
                  <button type="button" aria-label="削除" onclick="removeCategoryTag('{{ t }}')">×</button>
                </span>
              {% endfor %}
            </div>
          </div>



          <!-- 送信 -->
          <div class="actions">
            <button type="submit" class="submit-btn">編集する</button>
          </div>
        </form>
      </section>
    </main>
  </body>
</html>
