{% load static %}
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      html,
      body {
        background-color: #fbfef9;
        margin: 0;
        padding: 0;
      }

      .back-btn {
        position: fixed;
        top: 128px;
        left: 32px;
        font-size: 48px;
        color: #649ce4;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 9999;
      }
      .back-btn:focus {
        outline: none;
      }

      /* 画像 */
      .thumb {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        object-fit: cover;
        cursor: pointer;
        border: 2px solid transparent;
        background: #eee;
        display: block;
      }
      .thumb.is-active {
        border-color: #649ce4;
      }

      .main-img {
        width: 400px;
        height: 400px;
        border-radius: 32px;
        object-fit: cover;
        display: block;
        background: #eee;
      }

      /* 右側情報 */
      .info-title {
        font-size: 32px;
        font-weight: 700;
      }
      .info-price {
        font-size: 24px;
        margin-top: 24px;
      }

      .info-label {
        font-size: 16px;
        margin-top: 24px;
        color: #444;
        font-weight: 700;
      }
      .info-text {
        font-size: 16px;
        margin-top: 8px;
        color: #333;
        line-height: 1.7;
        white-space: pre-wrap;
      }

      .tag {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: #eaf2ff;
        color: #2a5db0;
        margin-right: 8px;
        margin-bottom: 6px;
        font-size: 14px;
        font-weight: 700;
      }

      .badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 999px;
        background: #fff0f5;
        color: #c2185b;
        font-size: 14px;
        font-weight: 700;
      }

      .primary-btn {
        width: 640px;
        height: 48px;
        border-radius: 16px;
        background-color: #f96796;
        color: white;
        margin-top: 48px;
        border: none;
        cursor: pointer;
        font-weight: 700;
      }
    </style>

    <script>
      function goBack() {
        if (window.history.length > 1) {
          history.back();
        } else if (document.referrer) {
          window.location.href = document.referrer;
        } else {
          window.location.href = "/"; // 仮
        }
      }

      // サムネクリックでメイン切替
      function changeImage(src, el) {
        const main = document.getElementById("mainImage");
        if (main) main.src = src;

        document
          .querySelectorAll(".thumb")
          .forEach((t) => t.classList.remove("is-active"));
        if (el) el.classList.add("is-active");
      }

      // 一番上のサムネをデフォルトでメイン表示
      window.addEventListener("DOMContentLoaded", () => {
        const firstThumb = document.querySelector(".thumb");
        const main = document.getElementById("mainImage");

        if (firstThumb && main) {
          main.src = firstThumb.src; // ← ここが要望の肝
          firstThumb.classList.add("is-active");
        }
      });
    </script>
  </head>

  <body>
    {% include "teams/takenoko/Components/header.html" %}

    <button type="button" class="back-btn" onclick="goBack()" aria-label="戻る">
      <i class="fas fa-arrow-alt-circle-left"></i>
    </button>

    <div style="position: relative; width: 1184px; margin: 64px auto">
      <div style="position: relative">
        <!-- サムネ列 -->
        <div
          style="
            position: absolute;
            display: grid;
            grid-template-columns: 1fr;
            row-gap: 20px;
          "
        >
          {% if item.images.all %} {% for img in item.images.all %}
          <img
            src="{{ img.image.url }}"
            alt="サムネ{{ forloop.counter }}"
            class="thumb{% if forloop.first %} is-active{% endif %}"
            onclick="changeImage(this.src, this)"
          />
          {% endfor %} {% else %}
          <img
            src="{% static 'images/noimage.png' %}"
            alt="画像なし"
            class="thumb is-active"
            onclick="changeImage(this.src, this)"
          />
          {% endif %}
        </div>

        <!-- メイン画像 -->
        <div style="position: absolute; margin-left: 80px">
          <img
            id="mainImage"
            class="main-img"
            src="{% if item.get_main_image %}{{ item.get_main_image.image.url }}{% else %}{% static 'images/noimage.png' %}{% endif %}"
            alt="メイン画像"
          />
        </div>
      </div>

      <!-- 右側：商品情報 -->
      <div style="position: relative; left: 544px; width: 640px">
        <p class="info-title">{{ item.name }}</p>
        <p class="info-price">¥{{ item.price|floatformat:0 }}</p>

        <p class="info-label">状態</p>
        <span class="badge">{{ item.get_condition_display }}</span>

        <p class="info-label">説明</p>
        <p class="info-text">{{ item.description }}</p>

        <p class="info-label">対象学年</p>
        <div style="margin-top: 8px">
          {% for g in item.target_grades.all %}
          <span class="tag">{{ g.display_name }}</span>
          {% empty %}
          <span class="tag">指定なし</span>
          {% endfor %}
        </div>

        <p class="info-label">タグ</p>
        <div style="margin-top: 8px">
          {% for t in item.tags.all %}
          <span class="tag">{{ t.display_name }}</span>
          {% empty %}
          <span class="tag">タグなし</span>
          {% endfor %}
        </div>

        <a href="{% url 'takenoko:start_trading' %}">
          <button type="button" class="primary-btn">取引開始</button>
        </a>
      </div>
    </div>
  </body>
</html>
