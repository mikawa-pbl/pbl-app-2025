<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±Šæ©‹æŠ€è¡“ç§‘å­¦å¤§å­¦ ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒãƒƒãƒ— (è·é›¢è¨ˆç®—æ©Ÿèƒ½ä»˜ã)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }

        .popup-btn {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            background-color: #800000;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
        }
        .popup-btn:hover { background-color: #a00000; }
        
        .info-text { font-size: 14px; line-height: 1.5; }
        
        /* è·é›¢è¡¨ç¤ºã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .dist-badge {
            display: inline-block;
            background: #eee;
            color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
        }

        /* GPSãƒœã‚¿ãƒ³ */
        .leaflet-control-gps {
            background-color: white;
            width: 34px;
            height: 34px;
            border-bottom: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            line-height: 34px;
            font-size: 20px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
        .leaflet-control-gps:hover { background-color: #f4f4f4; }

        .comment-wrap { padding:6px 8px; background:#f8f8f8; border-radius:6px; margin-top:6px; }
        .comment-time { font-size:12px; color:#666; margin-top:4px; }
        .status-label { font-weight:700; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // åœ°å›³ã®åˆæœŸåŒ–
        var map = L.map('map').setView([34.701663, 137.408313], 17);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // â˜… ç¾åœ¨åœ°ã‚’ä¿å­˜ã—ã¦ãŠãå¤‰æ•°
        var currentLatLng = null;

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒãƒ—ï¼ˆui.html ã¨æƒãˆã‚‹ï¼‰
        var statusMap = {
            'empty': 'ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹',
            'moderate': 'ğŸŸ¡ ã‚„ã‚„æ··é›‘',
            'crowded': 'ğŸ”´ æ··é›‘'
        };

        // æ–½è¨­æƒ…å ±ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆAPIã‹ã‚‰å–å¾—ï¼‰
        var facilitiesByName = {}; // name -> facility object
        var facilitiesById = {}; // id -> facility object

        async function loadFacilities() {
            try {
                const res = await fetch('/team_northcliff/api/facilities/');
                if (!res.ok) throw new Error('æ–½è¨­æƒ…å ±å–å¾—å¤±æ•—');
                const data = await res.json();
                if (Array.isArray(data.facilities)) {
                    data.facilities.forEach(f => {
                        facilitiesByName[f.name] = f;
                        facilitiesById[f.id] = f;
                    });
                }
            } catch (e) {
                console.error('æ–½è¨­æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // --- å…±é€šé–¢æ•°: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä¸­èº«ã‚’å‹•çš„ã«ä½œã‚‹ ---
        function generatePopupContentElement(layer, facility, fallbackTitle, fallbackDesc) {
            // create container element to avoid HTML injection
            var container = document.createElement('div');
            container.className = 'info-text';

            // distance badge
            var distText = "ğŸ“ (GPSæœªå–å¾—)";
            if (currentLatLng) {
                var meters = map.distance(currentLatLng, layer.getLatLng());
                if (meters >= 1000) {
                    distText = "ğŸš¶ ç¾åœ¨åœ°ã‹ã‚‰ " + (meters / 1000).toFixed(2) + " km";
                } else {
                    distText = "ğŸš¶ ç¾åœ¨åœ°ã‹ã‚‰ " + Math.round(meters) + " m";
                }
            }
            var distBadge = document.createElement('span');
            distBadge.className = 'dist-badge';
            distBadge.textContent = distText;
            container.appendChild(distBadge);
            container.appendChild(document.createElement('br'));

            // title
            var titleEl = document.createElement('b');
            titleEl.textContent = facility && facility.name ? facility.name : fallbackTitle;
            container.appendChild(titleEl);
            container.appendChild(document.createElement('br'));

            // last post / status
            if (facility) {
                var lastPost = document.createElement('div');
                lastPost.style.marginTop = '6px';
                var lpText = 'æœ€çµ‚æŠ•ç¨¿ï¼š ' + (facility.last_post_time || 'æƒ…å ±ãªã—');
                lastPost.textContent = lpText;
                container.appendChild(lastPost);

                var statusDiv = document.createElement('div');
                statusDiv.style.marginTop = '6px';
                var statusLabel = document.createElement('span');
                statusLabel.className = 'status-label';
                var statusDisplay = statusMap[facility.latest_status] || 'æƒ…å ±ãªã—';
                statusLabel.textContent = 'ç¾åœ¨ã®çŠ¶æ³ï¼š' + ' ';
                statusDiv.appendChild(statusLabel);

                var statusValue = document.createElement('span');
                statusValue.textContent = statusDisplay;
                statusDiv.appendChild(statusValue);
                container.appendChild(statusDiv);

                // recent comments (API already returns up to 3 latest comments within 10min)
                if (Array.isArray(facility.recent_comments) && facility.recent_comments.length > 0) {
                    facility.recent_comments.forEach(function(c) {
                        var cWrap = document.createElement('div');
                        cWrap.className = 'comment-wrap';
                        var cText = document.createElement('div');
                        cText.textContent = c.comment || '';
                        cText.style.whiteSpace = 'pre-wrap';
                        cWrap.appendChild(cText);
                        var cTime = document.createElement('div');
                        cTime.className = 'comment-time';
                        cTime.textContent = c.time_ago || '';
                        cWrap.appendChild(cTime);
                        container.appendChild(cWrap);
                    });
                }
            } else {
                // fallback description
                var descEl = document.createElement('div');
                descEl.style.marginTop = '6px';
                descEl.textContent = fallbackDesc || '';
                container.appendChild(descEl);
            }

            // "æœ€æ–°æƒ…å ±ã‚’å–å¾—" ãƒœã‚¿ãƒ³ (ãƒªãƒ³ã‚¯) - UIå´ã¨åŒã˜ãƒ©ãƒ™ãƒ«
            var link = document.createElement('a');
            link.className = 'popup-btn';
            link.target = '_blank';
            // ãƒªãƒ³ã‚¯å…ˆã¯ãƒãƒ¼ãƒ  UI ã«é£›ã°ã™ï¼ˆé©å®œ username ã‚’ä½¿ã†ã‚µã‚¤ãƒˆã®ãƒˆãƒƒãƒ—ã¸ï¼‰
            link.href = '/team_northcliff/'; 
            link.textContent = 'æœ€æ–°æƒ…å ±ã‚’å–å¾—';
            container.appendChild(link);

            return container;
        }

        // --- ãƒãƒ¼ã‚«ãƒ¼ã®è¨­ç½® (loadFacilitieså¾Œã«ä½œæˆ) ---
        function addMarkers() {
            // 1. é™„å±å›³æ›¸é¤¨
            var libraryLatLng = L.latLng(34.70084228819001, 137.41008130531003);
            var libraryMarker = L.marker(libraryLatLng).addTo(map);
            libraryMarker.bindPopup(function() {
                var f = facilitiesByName['é™„å±å›³æ›¸é¤¨'] || facilitiesByName['å›³æ›¸é¤¨'] || facilitiesById[Object.keys(facilitiesById)[0]];
                return generatePopupContentElement(libraryMarker, f, "é™„å±å›³æ›¸é¤¨", "æœ€çµ‚æŠ•ç¨¿ï¼š --");
            });

            // 2. ï¼ˆåŒ—å²¡ç ”ç©¶å®¤ã¯éè¡¨ç¤º: è¦æ±‚ã©ãŠã‚Šã“ã“ã§ã¯è¿½åŠ ã—ãªã„ï¼‰

            // 3. åŒ—é§è»Šå ´ -> L.marker ã«å¤‰æ›´
            var northParkLatLng = L.latLng(34.7030802064815, 137.40754813094193);
            var northParkMarker = L.marker(northParkLatLng, {icon: L.icon({iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41], iconAnchor:[12,41]})}).addTo(map);
            northParkMarker.bindPopup(function() {
                var f = facilitiesByName['åŒ—é§è»Šå ´'] || facilitiesByName['åŒ— é§è»Šå ´'] || facilitiesByName['é§è»Šå ´'] || null;
                return generatePopupContentElement(northParkMarker, f, "åŒ—é§è»Šå ´", "æœ€çµ‚æŠ•ç¨¿ï¼š --");
            });

            // 4. é£Ÿå ‚ï¼ˆè¿½åŠ ï¼‰
            var cafeteriaLatLng = L.latLng(34.700797551357624, 137.40906746128755);
            var cafeteriaMarker = L.marker(cafeteriaLatLng).addTo(map);
            cafeteriaMarker.bindPopup(function() {
                var f = facilitiesByName['é£Ÿå ‚'] || facilitiesByName['å­¦é£Ÿ'] || facilitiesByName['é£Ÿå ‚ï¼å­¦é£Ÿ'] || null;
                return generatePopupContentElement(cafeteriaMarker, f, "é£Ÿå ‚", "æœ€çµ‚æŠ•ç¨¿ï¼š --");
            });

            // 5. è¿½åŠ : ãƒã‚¹åœï¼ˆæŒ‡å®šåº§æ¨™ï¼‰
            var busStopLatLng = L.latLng(34.70088331851511, 137.41275196588953);
            var busStopMarker = L.marker(busStopLatLng).addTo(map);
            busStopMarker.bindPopup(function() {
                var f = facilitiesByName['ãƒã‚¹åœ'] || facilitiesByName['ãƒã‚¹åœç•™æ‰€'] || null;
                return generatePopupContentElement(busStopMarker, f, "ãƒã‚¹åœ", "æœ€çµ‚æŠ•ç¨¿ï¼š --");
            });
        }

        // --- GPSé–¢é€£æ©Ÿèƒ½ ---
        var currentLocMarker = null;
        var currentLocCircle = null;

        function onLocationFound(e) {
            currentLatLng = e.latlng;

            var radius = e.accuracy;

            if (currentLocMarker) { map.removeLayer(currentLocMarker); }
            if (currentLocCircle) { map.removeLayer(currentLocCircle); }

            currentLocMarker = L.circleMarker(e.latlng, {
                color: '#fff', weight: 2, fillColor: '#007bff', fillOpacity: 1, radius: 8
            }).addTo(map).bindPopup("ç¾åœ¨åœ°");

            currentLocCircle = L.circle(e.latlng, radius, {
                color: '#007bff', fillColor: '#007bff', fillOpacity: 0.1, weight: 1
            }).addTo(map);
        }

        function onLocationError(e) {
            alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n" + e.message);
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // --- GPSãƒœã‚¿ãƒ³ ---
        var GpsControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-control-gps leaflet-bar');
                container.innerHTML = 'ğŸ“';
                container.onclick = function(e) {
                    L.DomEvent.stopPropagation(e);
                    map.locate({setView: true, maxZoom: 17}); 
                }
                return container;
            }
        });
        map.addControl(new GpsControl());

        // åˆæœŸå‡¦ç†: æ–½è¨­æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®
        (async function init() {
            await loadFacilities();
            addMarkers();
        })();
    </script>
</body>
</html>