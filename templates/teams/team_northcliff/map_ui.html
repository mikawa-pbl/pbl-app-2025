{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±Šæ©‹æŠ€è¡“ç§‘å­¦å¤§å­¦ ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒãƒƒãƒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; z-index: 0; }

        /* ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º */
        #points-overlay {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-weight: bold; color: #2563eb;
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã‚¹ã‚¿ã‚¤ãƒ« */
        .popup-content { min-width: 220px; font-size: 14px; }
        .popup-btn {
            display: block; width: 100%; margin-top: 8px; padding: 8px 0;
            text-align: center; color: white; border-radius: 4px;
            font-weight: bold; border: none; cursor: pointer;
        }
        .btn-unlock { background-color: #2563eb; } 
        .btn-post { background-color: #16a34a; }
        
        .dist-badge {
            display: inline-block; background: #eee; color: #333;
            padding: 2px 6px; border-radius: 4px; font-size: 12px;
            margin-bottom: 5px; border: 1px solid #ccc;
        }

        /* å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ©ãƒ™ãƒ«ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaflet-tooltip.facility-label {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #333;
            color: #333;
            font-weight: bold;
            font-size: 12px;
            padding: 2px 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .modal-overlay { z-index: 2000; }
        .leaflet-control-gps {
            background-color: white; width: 34px; height: 34px;
            border-bottom: 1px solid #ccc; border-radius: 4px;
            cursor: pointer; text-align: center; line-height: 34px; font-size: 20px;
        }
        .comment-wrap { padding:6px 8px; background:#f8f8f8; border-radius:6px; margin-top:6px; }
        .comment-time { font-size:12px; color:#666; margin-top:4px; }
    </style>
</head>
<body>
    {% csrf_token %}

    <div id="points-overlay">ä¿æœ‰: èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="map"></div>

    <div id="confirm-modal" class="fixed inset-0 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl">
            <h3 class="text-lg font-bold text-gray-900">æƒ…å ±ã‚’å–å¾—ã—ã¾ã™</h3>
            <p class="mt-2 text-sm text-gray-600">æœ€æ–°æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« 1P æ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-unlock-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-unlock-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">OK (1Pæ¶ˆè²»)</button>
            </div>
        </div>
    </div>

    <div id="post-modal" class="fixed inset-0 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl">
            <h3 id="post-modal-title" class="text-lg font-bold text-gray-900">æ··é›‘çŠ¶æ³ã‚’æŠ•ç¨¿</h3>
            <div class="mt-4 space-y-4">
                <select id="post-status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="" disabled selected>æ··é›‘çŠ¶æ³ã‚’é¸æŠ</option>
                    <option value="empty">ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹</option>
                    <option value="moderate">ğŸŸ¡ ã‚„ã‚„æ··é›‘</option>
                    <option value="crowded">ğŸ”´ æ··é›‘</option>
                </select>
                <textarea id="post-comment" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ (ä»»æ„)"></textarea>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-post-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-post-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">æŠ•ç¨¿ (1Pç²å¾—)</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const username = '{{ username|escapejs }}';
        
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            points: 0,
            userId: null,
            userFacilityAccess: new Set(),
            targetFacilityId: null,
            facilities: []
        };

        // ãƒãƒ¼ã‚«ãƒ¼ã¨åº§æ¨™ã‚’ç®¡ç†ã™ã‚‹è¾æ›¸ (ID -> Marker/LatLng)
        const markersMap = {};
        const facilityCoords = {};

        const statusMap = { 'empty': 'ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹', 'moderate': 'ğŸŸ¡ ã‚„ã‚„æ··é›‘', 'crowded': 'ğŸ”´ æ··é›‘' };
        
        // API Helper
        function getCsrfToken() { return document.querySelector('[name=csrfmiddlewaretoken]').value; }
        async function apiCall(url, method='GET', data=null) {
            const opts = { method, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() } };
            if (data) opts.body = JSON.stringify(data);
            const res = await fetch(url, opts);
            const json = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(json.error || `API Error: ${res.status}`);
            return json;
        }

        // --- åˆæœŸåŒ– ---
        async function initializeApp() {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
                const userData = await apiCall(`/team_northcliff/api/${username}/user-data/`);
                state.userId = userData.user_id;
                state.points = userData.points;
                updatePoints();

                // æ–½è¨­æƒ…å ±å–å¾—
                await loadFacilities();
                
                // ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®ï¼ˆJSå®šç¾©ã®åº§æ¨™ã‚’ä½¿ç”¨ï¼‰
                addMarkers();

            } catch (e) {
                console.error(e);
                document.getElementById('points-overlay').textContent = "ã‚¨ãƒ©ãƒ¼";
            }
        }
        function updatePoints() { document.getElementById('points-overlay').textContent = `ä¿æœ‰: ${state.points}P`; }

        async function loadFacilities() {
            try {
                const data = await apiCall('/team_northcliff/api/facilities/');
                state.facilities = data.facilities;
            } catch(e) { console.error(e); }
        }

        // --- ãƒãƒƒãƒ—è¨­å®š ---
        var map = L.map('map').setView([34.701663, 137.408313], 17);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        var currentLatLng = null;

        // --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”Ÿæˆ ---
        function generatePopupContent(facility, fallbackName) {
            const div = document.createElement('div');
            div.className = 'popup-content';

            // ã‚¿ã‚¤ãƒˆãƒ«
            const title = document.createElement('b');
            title.textContent = facility ? facility.name : fallbackName;
            div.appendChild(title);

            // æ–½è¨­ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
            if (!facility) {
                div.appendChild(document.createElement('br'));
                div.appendChild(document.createTextNode("ãƒ‡ãƒ¼ã‚¿ãªã—"));
                return div;
            }

            // ãƒ­ãƒƒã‚¯åˆ¤å®š
            const isUnlocked = state.userFacilityAccess.has(facility.id);

            if (isUnlocked) {
                // === 1. ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ (æœ€æ–°æƒ…å ±ã®ã¿è¡¨ç¤º) ===
                // è¦æœ›é€šã‚ŠæŠ•ç¨¿ãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºã«ã™ã‚‹
                
                const lastPost = document.createElement('div');
                lastPost.style.marginTop = '6px';
                lastPost.textContent = `æœ€çµ‚æŠ•ç¨¿ï¼š ${facility.last_post_time || 'æƒ…å ±ãªã—'}`;
                div.appendChild(lastPost);

                const statusDiv = document.createElement('div');
                statusDiv.innerHTML = `<b>ç¾åœ¨ã®çŠ¶æ³ï¼š</b> ${statusMap[facility.latest_status] || 'æƒ…å ±ãªã—'}`;
                div.appendChild(statusDiv);

                // ã‚³ãƒ¡ãƒ³ãƒˆ
                if (facility.recent_comments && facility.recent_comments.length > 0) {
                    facility.recent_comments.forEach(c => {
                        const cDiv = document.createElement('div');
                        cDiv.className = 'comment-wrap';
                        const cText = document.createElement('div');
                        cText.textContent = c.comment || ''; // XSSå¯¾ç­–
                        cDiv.appendChild(cText);
                        const cTime = document.createElement('div');
                        cTime.className = 'comment-time';
                        cTime.textContent = c.time_ago || '';
                        cDiv.appendChild(cTime);
                        div.appendChild(cDiv);
                    });
                }
                // â€» ã“ã“ã«æŠ•ç¨¿ãƒœã‚¿ãƒ³ã¯ä½œæˆã—ãªã„

            } else {
                // === ãƒ­ãƒƒã‚¯ä¸­ (è§£é™¤ãƒœã‚¿ãƒ³ or æŠ•ç¨¿ãƒœã‚¿ãƒ³) ===
                const note = document.createElement('p');
                note.textContent = 'è©³ç´°ã‚’è¦‹ã‚‹ã«ã¯ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚';
                note.style.color = '#666'; note.style.marginTop = '8px';
                div.appendChild(note);

                // è§£é™¤ãƒœã‚¿ãƒ³
                const unlockBtn = document.createElement('button');
                unlockBtn.className = 'popup-btn btn-unlock';
                unlockBtn.textContent = 'æœ€æ–°æƒ…å ±ã‚’å–å¾— (1Pæ¶ˆè²»)';
                unlockBtn.onclick = () => openUnlockModal(facility.id);
                div.appendChild(unlockBtn);

                // æŠ•ç¨¿ãƒœã‚¿ãƒ³
                const postBtn = document.createElement('button');
                postBtn.className = 'popup-btn btn-post';
                postBtn.style.marginTop = '5px';
                postBtn.textContent = 'æŠ•ç¨¿ã™ã‚‹';
                postBtn.onclick = () => openPostModal(facility.id);
                div.appendChild(postBtn);
            }
            return div;
        }

        // --- ãƒãƒ¼ã‚«ãƒ¼è¨­ç½® (4. å¸¸ã«ãƒ©ãƒ™ãƒ«è¡¨ç¤º) ---
        function addMarkers() {
            const locations = [
                { searchKey: 'å›³æ›¸é¤¨', label: 'é™„å±å›³æ›¸é¤¨', lat: 34.700842, lng: 137.410081 },
                { searchKey: 'é§è»Šå ´', label: 'åŒ—é§è»Šå ´', lat: 34.703080, lng: 137.407548, icon: true },
                { searchKey: 'é£Ÿ', label: 'é£Ÿå ‚', lat: 34.700797, lng: 137.409067 },
                { searchKey: 'ã‚«ãƒ•ã‚§', label: 'ã‚«ãƒ•ã‚§', lat: 34.700950, lng: 137.409500 },
                { searchKey: 'ãƒã‚¹', label: 'ãƒã‚¹åœ', lat: 34.700883, lng: 137.412751 }
            ];

            locations.forEach(loc => {
                const latlng = L.latLng(loc.lat, loc.lng);
                let marker;
                if (loc.icon) {
                    marker = L.marker(latlng, { icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize:[25,41], iconAnchor:[12,41]}) });
                } else {
                    marker = L.marker(latlng);
                }
                
                // â˜… 4. ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§åå‰ã‚’å¸¸ã«è¡¨ç¤º
                marker.bindTooltip(loc.label, {
                    permanent: true, 
                    direction: 'top', 
                    offset: [-10, -35],
                    className: 'facility-label'
                });

                marker.addTo(map);

                // æ–½è¨­ãƒ‡ãƒ¼ã‚¿ç´ä»˜ã‘
                let f = state.facilities.find(item => item.name.includes(loc.searchKey));
                if (f) {
                    // IDã§ãƒãƒ¼ã‚«ãƒ¼ã¨åº§æ¨™ã‚’é€†å¼•ãã§ãã‚‹ã‚ˆã†ã«ä¿å­˜
                    markersMap[f.id] = marker;
                    facilityCoords[f.id] = latlng;
                }

                marker.bindPopup(() => {
                    // æœ€æ–°ã®æ¤œç´¢çµæœã‚’ä½¿ç”¨ (å†ãƒ­ãƒ¼ãƒ‰å¯¾å¿œ)
                    let currentF = state.facilities.find(item => item.name.includes(loc.searchKey));
                    
                    let distHtml = '';
                    if (currentLatLng) {
                        const d = map.distance(currentLatLng, latlng);
                        const txt = d >= 1000 ? (d/1000).toFixed(2)+'km' : Math.round(d)+'m';
                        distHtml = `<span class="dist-badge">ğŸš¶ ç¾åœ¨åœ°ã‹ã‚‰ ${txt}</span><br>`;
                    }

                    const content = generatePopupContent(currentF, loc.label);
                    
                    if(distHtml) {
                        const dSpan = document.createElement('div');
                        dSpan.innerHTML = distHtml;
                        content.insertBefore(dSpan, content.firstChild);
                    }
                    return content;
                });
            });
        }

        // --- Mock GPS ---
        function setMockLocation() {
            const mockLat = 34.701317;
            const mockLng = 137.410044;
            currentLatLng = L.latLng(mockLat, mockLng);
            
            map.eachLayer(layer => { if(layer._mockLocation) map.removeLayer(layer); });

            const blueDot = L.circleMarker(currentLatLng, {
                color: '#fff', weight: 2, fillColor: '#007bff', fillOpacity: 1, radius: 8
            });
            blueDot._mockLocation = true;
            blueDot.addTo(map).bindPopup("ç¾åœ¨åœ° (ãƒ†ã‚¹ãƒˆç”¨)");

            const circle = L.circle(currentLatLng, { radius: 20, color: '#007bff', weight: 1, opacity: 0.2 });
            circle._mockLocation = true;
            circle.addTo(map);
        }

        map.on('locationfound', (e) => { setMockLocation(); });
        map.on('locationerror', (e) => { console.warn("GPSå¤±æ•—"); setMockLocation(); });

        var GpsControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function(map) {
                var btn = L.DomUtil.create('div', 'leaflet-control-gps leaflet-bar');
                btn.innerHTML = 'ğŸ“';
                btn.onclick = (e) => {
                    L.DomEvent.stopPropagation(e);
                    map.locate({setView: true, maxZoom: 17}); 
                };
                return btn;
            }
        });
        map.addControl(new GpsControl());

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
        const confirmModal = document.getElementById('confirm-modal');
        const postModal = document.getElementById('post-modal');

        function openUnlockModal(fid) {
            if(state.points < 1) { alert("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“"); return; }
            state.targetFacilityId = fid;
            confirmModal.classList.remove('hidden'); confirmModal.classList.add('flex');
        }

        function openPostModal(fid) {
            // === 3. è·é›¢åˆ¶é™ (100m) ===
            if (currentLatLng && facilityCoords[fid]) {
                const dist = map.distance(currentLatLng, facilityCoords[fid]);
                if (dist > 100) {
                    alert(`ç¾åœ¨åœ°ã‹ã‚‰é›¢ã‚Œã™ãã¦ã„ã¾ã™ (ç´„${Math.round(dist)}m)ã€‚\næŠ•ç¨¿ã¯100måœå†…ã§ã®ã¿å¯èƒ½ã§ã™ã€‚`);
                    return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã‹ãªã„
                }
            }

            state.targetFacilityId = fid;
            
            // æ–½è¨­åã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«åæ˜ 
            const target = state.facilities.find(f => f.id === fid);
            const titleEl = document.getElementById('post-modal-title');
            if (target && titleEl) {
                titleEl.textContent = `${target.name}ã®æ··é›‘çŠ¶æ³ã‚’æŠ•ç¨¿`;
            }

            document.getElementById('post-status').value = "";
            document.getElementById('post-comment').value = "";
            postModal.classList.remove('hidden'); postModal.classList.add('flex');
        }

        function closeModal(m) {
            m.classList.add('hidden'); m.classList.remove('flex');
            // targetFacilityId ã¯ã‚¯ãƒªã‚¢ã—ãªã„ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ›´æ–°ã§ä½¿ã†ãŸã‚ï¼‰
        }

        document.getElementById('cancel-unlock-btn').onclick = () => {
            closeModal(confirmModal);
            state.targetFacilityId = null;
        };
        document.getElementById('cancel-post-btn').onclick = () => {
            closeModal(postModal);
            state.targetFacilityId = null;
        };

        // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å®Ÿè¡Œ
        document.getElementById('confirm-unlock-btn').onclick = async () => {
            const fid = state.targetFacilityId;
            try {
                await apiCall(`/team_northcliff/api/${username}/access-facility/`, 'POST', { facility_id: fid });
                state.points -= 1;
                state.userFacilityAccess.add(fid);
                updatePoints();
                closeModal(confirmModal);
                
                // === 2. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ç¶­æŒã—ã¦å†…å®¹ã‚’æ›´æ–° ===
                const marker = markersMap[fid];
                if (marker) {
                    const f = state.facilities.find(item => item.id === fid);
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚Œã°ä¸­èº«ã‚’æ›¸ãæ›ãˆ
                    if (map.hasLayer(marker.getPopup())) {
                        marker.setPopupContent(generatePopupContent(f, f.name));
                    } else {
                        // å¿µã®ãŸã‚é–‰ã˜ã¦ã„ãŸã‚‰é–‹ã
                        marker.openPopup();
                    }
                }
            } catch(e) { alert(e.message); state.targetFacilityId = null; }
        };

        // æŠ•ç¨¿å®Ÿè¡Œ
        document.getElementById('confirm-post-btn').onclick = async () => {
            const status = document.getElementById('post-status').value;
            const comment = document.getElementById('post-comment').value;
            if(!status) return alert("çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„");
            
            try {
                await apiCall(`/team_northcliff/api/${username}/create-post/`, 'POST', {
                    facility_id: state.targetFacilityId, status, comment
                });
                state.points += 1;
                state.userFacilityAccess.add(state.targetFacilityId);
                updatePoints();
                await loadFacilities(); // ãƒ‡ãƒ¼ã‚¿å†å–å¾—
                closeModal(postModal);
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ›´æ–°
                const fid = state.targetFacilityId;
                const marker = markersMap[fid];
                if (marker) {
                    const f = state.facilities.find(item => item.id === fid);
                    // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ã®è¡¨ç¤ºï¼ˆæŠ•ç¨¿ãƒœã‚¿ãƒ³ãªã—ï¼‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹
                    marker.setPopupContent(generatePopupContent(f, f.name));
                    marker.openPopup();
                }
                state.targetFacilityId = null;

            } catch(error) { 
                if (error && error.message && error.message.includes('ï¼‘ï¼åˆ†ä»¥å†…ã«')) {
                    alert('ï¼‘ï¼åˆ†ä»¥å†…ã«åŒä¸€ã®æ–½è¨­æƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“');
                } else {
                    alert(error.message || 'æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        };

        initializeApp();
        setMockLocation();

    </script>
</body>
</html>