{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±Šæ©‹æŠ€è¡“ç§‘å­¦å¤§å­¦ ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ãƒãƒƒãƒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; z-index: 0; }

        /* ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º */
        #points-overlay {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 8px 12px; border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-weight: bold; color: #2563eb;
        }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã‚¹ã‚¿ã‚¤ãƒ« */
        .popup-content { min-width: 220px; font-size: 14px; }
        .popup-btn {
            display: block; width: 100%; margin-top: 8px; padding: 8px 0;
            text-align: center; color: white; border-radius: 4px;
            font-weight: bold; border: none; cursor: pointer;
        }
        .btn-unlock { background-color: #2563eb; } 
        .btn-post { background-color: #16a34a; }
        
        .dist-badge {
            display: inline-block; background: #eee; color: #333;
            padding: 2px 6px; border-radius: 4px; font-size: 12px;
            margin-bottom: 5px; border: 1px solid #ccc;
        }

        /* å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ©ãƒ™ãƒ«ï¼ˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .leaflet-tooltip.facility-label {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #333;
            color: #333;
            font-weight: bold;
            font-size: 12px;
            padding: 2px 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .modal-overlay { z-index: 2000; }
        .leaflet-control-gps {
            background-color: white; width: 34px; height: 34px;
            border-bottom: 1px solid #ccc; border-radius: 4px;
            cursor: pointer; text-align: center; line-height: 34px; font-size: 20px;
        }
        .comment-wrap { padding:6px 8px; background:#f8f8f8; border-radius:6px; margin-top:6px; }
        .comment-time { font-size:12px; color:#666; margin-top:4px; }
    </style>
</head>
<body>
    {% csrf_token %}

    <div class="fixed top-2 right-2 z-[1000]">
        <div id="user-menu-btn" class="flex items-center space-x-3 bg-white p-2 rounded-lg shadow-md cursor-pointer hover:bg-gray-50 transition">
            <span id="points-display" class="text-base font-bold text-blue-600">ä¿æœ‰: ...</span>
            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <!-- ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden ring-1 ring-black ring-opacity-5">
            <div class="px-4 py-2 text-xs text-gray-500 border-b">ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆ</div>
            <div id="user-list-container" class="max-h-60 overflow-y-auto">
                <!-- JSã§è¿½åŠ  -->
            </div>
        </div>
    </div>
    <div id="map"></div>

    <div id="confirm-modal" class="fixed inset-0 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl">
            <h3 class="text-lg font-bold text-gray-900">æƒ…å ±ã‚’å–å¾—ã—ã¾ã™</h3>
            <p class="mt-2 text-sm text-gray-600">æœ€æ–°æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« 1P æ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-unlock-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-unlock-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">OK (1Pæ¶ˆè²»)</button>
            </div>
        </div>
    </div>

    <div id="post-modal" class="fixed inset-0 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl">
            <h3 id="post-modal-title" class="text-lg font-bold text-gray-900">æ··é›‘çŠ¶æ³ã‚’æŠ•ç¨¿</h3>
            <div class="mt-4 space-y-4">
                <select id="post-status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <option value="" disabled selected>æ··é›‘çŠ¶æ³ã‚’é¸æŠ</option>
                    <option value="empty">ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹</option>
                    <option value="moderate">ğŸŸ¡ ã‚„ã‚„æ··é›‘</option>
                    <option value="crowded">ğŸ”´ æ··é›‘</option>
                </select>
                <textarea id="post-comment" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3" placeholder="ä¾‹: å¸­ã¯åŠåˆ†ãã‚‰ã„ç©ºã„ã¦ã„ã¾ã™"></textarea>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-post-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="confirm-post-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">æŠ•ç¨¿ (1Pç²å¾—)</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const username = '{{ username|escapejs }}';
        
        // çŠ¶æ…‹ç®¡ç†
        const state = {
            points: 0,
            userId: null,
            userFacilityAccess: new Set(),
            targetFacilityId: null,
            facilities: [],
            userLocation: null,         // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®æƒ…å ±
            isLocationAcquired: false   // ä½ç½®æƒ…å ±å–å¾—æ¸ˆã¿ãƒ•ãƒ©ã‚°
        };

        // ãƒãƒ¼ã‚«ãƒ¼ã¨åº§æ¨™ã‚’ç®¡ç†ã™ã‚‹è¾æ›¸ (ID -> Marker/LatLng)
        const markersMap = {};
        const facilityCoords = {};

        const statusMap = { 'empty': 'ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹', 'moderate': 'ğŸŸ¡ ã‚„ã‚„æ··é›‘', 'crowded': 'ğŸ”´ æ··é›‘' };
        
        // API Helper
        function getCsrfToken() { return document.querySelector('[name=csrfmiddlewaretoken]').value; }
        async function apiCall(url, method='GET', data=null) {
            const opts = { method, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() } };
            if (data) opts.body = JSON.stringify(data);
            const res = await fetch(url, opts);
            const json = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(json.error || `API Error: ${res.status}`);
            return json;
        }

        // --- ãƒãƒƒãƒ—è¨­å®š ---
        var map = L.map('map').setView([34.701663, 137.408313], 17); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        
        var userMarker = null;

        // --- åˆæœŸåŒ– ---
        async function initializeApp() {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
                const userData = await apiCall(`/team_northcliff/api/${username}/user-data/`);
                state.userId = userData.user_id;
                state.points = userData.points;
                state.userLocation = { latitude: userData.latitude, longitude: userData.longitude };
                
                // 5åˆ†ä»¥å†…ã®é–²è¦§æ¨©é™ã‚’åæ˜ 
                if (userData.accessible_facility_ids) {
                    userData.accessible_facility_ids.forEach(id => state.userFacilityAccess.add(id));
                }

                updatePoints();

                // èµ·å‹•æ™‚ã«ä½ç½®æƒ…å ±ã‚’è¦æ±‚
                handleLocationPermission();

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
                setupUserSwitcher();

                // æ–½è¨­æƒ…å ±å–å¾—
                await loadFacilities();
                
            } catch (e) {
                console.error(e);
                document.getElementById('points-display').textContent = "ã‚¨ãƒ©ãƒ¼";
            }
        }
        function updatePoints() { document.getElementById('points-display').textContent = `ä¿æœ‰: ${state.points}P`; }

        async function loadFacilities() {
            try {
                const data = await apiCall('/team_northcliff/api/facilities/');
                state.facilities = data.facilities;
                addMarkers(); // ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®
            } catch(e) { console.error(e); }
        }

        // --- ä½ç½®æƒ…å ±è¨±å¯ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
        function handleLocationPermission() {
            if (state.isLocationAcquired) return true;
            // èµ·å‹•æ™‚ã«ä½ç½®æƒ…å ±ã‚’è¦æ±‚ã™ã‚‹é€šçŸ¥ï¼ˆDBã®ä½ç½®æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç¤ºã™ï¼‰
            const confirmed = confirm("æŠ•ç¨¿ã‚„è·é›¢ã®è¡¨ç¤ºã«ã¯ã€ä½ç½®æƒ…å ±ãŒå¿…è¦ã§ã™ã€‚\nï¼ˆç™»éŒ²ã•ã‚ŒãŸä½ç½®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ï¼‰\n\nè¨±å¯ã—ã¾ã™ã‹ï¼Ÿ");
            if (confirmed) {
                state.isLocationAcquired = true;
                setUserLocationMarker();
                return true;
            }
            alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ãªã„ã¨ã€ã“ã®æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
            return false;
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
        async function setupUserSwitcher() {
            const btn = document.getElementById('user-menu-btn');
            const menu = document.getElementById('user-dropdown');
            const listContainer = document.getElementById('user-list-container');
            
            // ãƒˆã‚°ãƒ«
            btn.onclick = (e) => {
                e.stopPropagation();
                menu.classList.toggle('hidden');
            };

            // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.addEventListener('click', (e) => {
                if (!btn.contains(e.target) && !menu.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—
            try {
                const data = await apiCall('/team_northcliff/api/users/');
                if (data.users) {
                    listContainer.innerHTML = '';
                    data.users.forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer';
                        div.textContent = u.name;
                        if (u.name === username) {
                             div.classList.add('bg-blue-50', 'font-bold');
                        }
                        div.onclick = () => {
                            window.location.href = `/team_northcliff/map_ui/${encodeURIComponent(u.name)}/`;
                        };
                        listContainer.appendChild(div);
                    });
                }
            } catch (e) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—å¤±æ•—', e);
            }
        }

        // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®æƒ…å ±ã®è¡¨ç¤º ---
        function setUserLocationMarker() {
             if (!state.userLocation || !state.userLocation.latitude || !state.userLocation.longitude) return;
             
             const latlng = [state.userLocation.latitude, state.userLocation.longitude];
             
             // ãƒãƒƒãƒ—ä¸­å¿ƒã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½ç½®ã¸
             map.setView(latlng, 17);

             // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
             if (userMarker) map.removeLayer(userMarker);

             // é’ã„ãƒ‰ãƒƒãƒˆãƒãƒ¼ã‚«ãƒ¼
             userMarker = L.circleMarker(latlng, {
                color: '#fff', weight: 2, fillColor: '#007bff', fillOpacity: 1, radius: 8
             });
             userMarker.addTo(map).bindPopup("ç¾åœ¨åœ°");

             // ç¯„å›²å††
             L.circle(latlng, { radius: 20, color: '#007bff', weight: 1, opacity: 0.2 }).addTo(map);
        }

        // --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”Ÿæˆ ---
        function generatePopupContent(facility) {
            const div = document.createElement('div');
            div.className = 'popup-content';

            // ã‚¿ã‚¤ãƒˆãƒ«
            const title = document.createElement('b');
            title.textContent = facility.name;
            div.appendChild(title);

            // ãƒ­ãƒƒã‚¯åˆ¤å®š
            const isUnlocked = state.userFacilityAccess.has(facility.id);

            if (isUnlocked) {
                // === 1. ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ (æœ€æ–°æƒ…å ±ã®ã¿è¡¨ç¤º) ===
                
                const lastPost = document.createElement('div');
                lastPost.style.marginTop = '6px';
                lastPost.textContent = `æœ€çµ‚æŠ•ç¨¿ï¼š ${facility.last_post_time || 'æƒ…å ±ãªã—'}`;
                div.appendChild(lastPost);

                const statusDiv = document.createElement('div');
                statusDiv.innerHTML = `<b>ç¾åœ¨ã®çŠ¶æ³ï¼š</b> ${statusMap[facility.latest_status] || 'æƒ…å ±ãªã—'}`;
                div.appendChild(statusDiv);

                // ã‚³ãƒ¡ãƒ³ãƒˆ
                if (facility.recent_comments && facility.recent_comments.length > 0) {
                    facility.recent_comments.forEach(c => {
                        const cDiv = document.createElement('div');
                        cDiv.className = 'comment-wrap';
                        const cText = document.createElement('div');
                        cText.textContent = c.comment || ''; // XSSå¯¾ç­–
                        cDiv.appendChild(cText);
                        const cTime = document.createElement('div');
                        cTime.className = 'comment-time';
                        cTime.textContent = c.time_ago || '';
                        cDiv.appendChild(cTime);
                        div.appendChild(cDiv);
                    });
                }

            } else {
                // === ãƒ­ãƒƒã‚¯ä¸­ (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) ===
                const note = document.createElement('p');
                note.textContent = 'è©³ç´°ã‚’è¦‹ã‚‹ã«ã¯ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚';
                note.style.color = '#666'; note.style.marginTop = '8px';
                div.appendChild(note);
            }

            // === ãƒœã‚¿ãƒ³ã¯å¸¸ã«è¡¨ç¤º ===
            
            // è§£é™¤ãƒœã‚¿ãƒ³
            const unlockBtn = document.createElement('button');
            unlockBtn.className = 'popup-btn btn-unlock';
            
            if (isUnlocked) {
                unlockBtn.textContent = 'æƒ…å ±ã‚’æ›´æ–°';
                // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ãªã‚‰ç¢ºèªãªã—ã§å®Ÿè¡Œ
                unlockBtn.onclick = () => executeUnlock(facility.id);
            } else {
                unlockBtn.textContent = 'æœ€æ–°æƒ…å ±ã‚’å–å¾— (1Pæ¶ˆè²»)';
                unlockBtn.onclick = () => openUnlockModal(facility.id);
            }
            div.appendChild(unlockBtn);

            // æŠ•ç¨¿ãƒœã‚¿ãƒ³
            const postBtn = document.createElement('button');
            postBtn.className = 'popup-btn btn-post';
            postBtn.style.marginTop = '5px';
            postBtn.textContent = 'æŠ•ç¨¿ã™ã‚‹';
            postBtn.onclick = () => openPostModal(facility.id);
            div.appendChild(postBtn);

            return div;
        }

        // --- ãƒãƒ¼ã‚«ãƒ¼è¨­ç½® (ãƒ‡ãƒ¼ã‚¿åŸºç›¤) ---
        function addMarkers() {
            // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªã‚¢ï¼ˆå¿…è¦ãªã‚‰å®Ÿè£…ã™ã‚‹ãŒã€ä»Šå›ã¯è¿½åŠ ã®ã¿ã§OKï¼‰

            state.facilities.forEach(facility => {
                if (!facility.latitude || !facility.longitude) return;

                const latlng = L.latLng(facility.latitude, facility.longitude);
                const marker = L.marker(latlng);
                
                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§åå‰ã‚’å¸¸ã«è¡¨ç¤º
                marker.bindTooltip(facility.name, {
                    permanent: true, 
                    direction: 'top', 
                    offset: [-10, -35],
                    className: 'facility-label'
                });

                marker.addTo(map);

                // ç®¡ç†ç”¨ä¿å­˜
                markersMap[facility.id] = marker;
                facilityCoords[facility.id] = latlng;

                marker.bindPopup(() => {
                    // æœ€æ–°ã®çŠ¶æ…‹ã‚’å‚ç…§
                    const currentF = state.facilities.find(f => f.id === facility.id);
                    
                    let distHtml = '';
                    if (state.userLocation && state.userLocation.latitude && state.userLocation.longitude) {
                        const userLatLng = L.latLng(state.userLocation.latitude, state.userLocation.longitude);
                        const d = map.distance(userLatLng, latlng);
                        const txt = d >= 1000 ? (d/1000).toFixed(2)+'km' : Math.round(d)+'m';
                        distHtml = `<span class="dist-badge">ğŸš¶ ç¾åœ¨åœ°ã‹ã‚‰ ${txt}</span><br>`;
                    }

                    const content = generatePopupContent(currentF);
                    
                    if(distHtml) {
                        const dSpan = document.createElement('div');
                        dSpan.innerHTML = distHtml;
                        content.insertBefore(dSpan, content.firstChild);
                    }
                    return content;
                });
            });
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
        const confirmModal = document.getElementById('confirm-modal');
        const postModal = document.getElementById('post-modal');

        function openUnlockModal(fid) {
            if(state.points < 1) { alert("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“"); return; }
            state.targetFacilityId = fid;
            confirmModal.classList.remove('hidden'); confirmModal.classList.add('flex');
        }

        function openPostModal(fid) {
            // === 3. è·é›¢åˆ¶é™ (100m) ===
            // DBä¸Šã®ä½ç½®æƒ…å ±ã§è¨ˆç®—
            if (state.userLocation && state.userLocation.latitude && state.userLocation.longitude && facilityCoords[fid]) {
                const userLatLng = L.latLng(state.userLocation.latitude, state.userLocation.longitude);
                const dist = map.distance(userLatLng, facilityCoords[fid]);
                if (dist > 100) {
                    alert(`ç¾åœ¨åœ°ã‹ã‚‰é›¢ã‚Œã™ãã¦ã„ã¾ã™ (ç´„${Math.round(dist)}m)ã€‚\næŠ•ç¨¿ã¯100måœå†…ã§ã®ã¿å¯èƒ½ã§ã™ã€‚`);
                    return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã‹ãªã„
                }
            } else {
                 alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¦ã„ãªã„ãŸã‚æŠ•ç¨¿ã§ãã¾ã›ã‚“ã€‚");
                 return;
            }

            state.targetFacilityId = fid;
            
            // æ–½è¨­åã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«åæ˜ 
            const target = state.facilities.find(f => f.id === fid);
            const titleEl = document.getElementById('post-modal-title');
            if (target && titleEl) {
                titleEl.textContent = `${target.name}ã®æ··é›‘çŠ¶æ³ã‚’æŠ•ç¨¿`;
            }

            document.getElementById('post-status').value = "";
            document.getElementById('post-comment').value = "";
            postModal.classList.remove('hidden'); postModal.classList.add('flex');
        }

        function closeModal(m) {
            m.classList.add('hidden'); m.classList.remove('flex');
            // targetFacilityId ã¯ã‚¯ãƒªã‚¢ã—ãªã„
        }

        document.getElementById('cancel-unlock-btn').onclick = () => {
            closeModal(confirmModal);
            state.targetFacilityId = null;
        };
        document.getElementById('cancel-post-btn').onclick = () => {
            closeModal(postModal);
            state.targetFacilityId = null;
        };

        // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å®Ÿè¡Œ
        async function executeUnlock(fid) {
            try {
                await apiCall(`/team_northcliff/api/${username}/access-facility/`, 'POST', { facility_id: fid });
                // æˆåŠŸæ™‚ã®ã¿çŠ¶æ…‹æ›´æ–°ï¼ˆãƒã‚¤ãƒ³ãƒˆã¯æ¶ˆè²»ã•ã‚Œã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œãªã„ãŒã€BackendãŒç®¡ç†ï¼‰
                // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ãã‚Œã‚’åæ˜ 
                const res = await apiCall(`/team_northcliff/api/${username}/user-data/`);
                state.points = res.points; // æ­£ç¢ºãªãƒã‚¤ãƒ³ãƒˆã«æ›´æ–°
                state.userFacilityAccess.add(fid);
                updatePoints();
                
                // æ–½è¨­æƒ…å ±ã‚’å†å–å¾—ã—ã¦æœ€æ–°åŒ–
                await loadFacilities();
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ç¶­æŒã—ã¦å†…å®¹ã‚’æ›´æ–°
                const marker = markersMap[fid];
                if (marker) {
                    const f = state.facilities.find(item => item.id === fid);
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚Œã°ä¸­èº«ã‚’æ›¸ãæ›ãˆ
                    if (map.hasLayer(marker.getPopup())) {
                        marker.setPopupContent(generatePopupContent(f));
                    }
                }
            } catch(e) { alert(e.message); }
        }

        document.getElementById('confirm-unlock-btn').onclick = async () => {
             const fid = state.targetFacilityId;
             closeModal(confirmModal);
             await executeUnlock(fid);
             state.targetFacilityId = null;
        };

        // æŠ•ç¨¿å®Ÿè¡Œ
        document.getElementById('confirm-post-btn').onclick = async () => {
            const status = document.getElementById('post-status').value;
            const comment = document.getElementById('post-comment').value;
            if(!status) return alert("çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„");
            
            try {
                await apiCall(`/team_northcliff/api/${username}/create-post/`, 'POST', {
                    facility_id: state.targetFacilityId, status, comment
                });
                state.points += 1;
                state.userFacilityAccess.add(state.targetFacilityId);
                updatePoints();
                await loadFacilities(); // ãƒ‡ãƒ¼ã‚¿å†å–å¾—
                closeModal(postModal);
                
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ›´æ–°
                const fid = state.targetFacilityId;
                const marker = markersMap[fid];
                if (marker) {
                    const f = state.facilities.find(item => item.id === fid);
                    // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ã®è¡¨ç¤ºï¼ˆæŠ•ç¨¿ãƒœã‚¿ãƒ³ãªã—ï¼‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹
                    marker.setPopupContent(generatePopupContent(f));
                    marker.openPopup();
                }
                state.targetFacilityId = null;

            } catch(error) { 
                if (error && error.message && error.message.includes('åˆ†ä»¥å†…ã«')) {
                    alert('5åˆ†ä»¥å†…ã«åŒä¸€ã®æ–½è¨­æƒ…å ±ã‚’æŠ•ç¨¿ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“');
                } else {
                    alert(error.message || 'æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        };

        initializeApp();

    </script>
</body>
</html>