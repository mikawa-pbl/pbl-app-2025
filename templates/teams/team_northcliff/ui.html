{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€ç§‘å¤§ æ··é›‘ãƒãƒƒãƒ—</title>
    <!-- Tailwind CSSã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans JP ã‚’Tailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼(sans)ã¨ã—ã¦è¨­å®š */
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            overscroll-behavior: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£é–ã‚’é˜²æ­¢ */
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚’æš—ãã™ã‚‹ */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">

    {% csrf_token %}

    <!-- (A) ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="sticky top-0 z-10 flex items-center justify-between w-full px-4 py-3 bg-white shadow-sm">
        <h1 class="text-lg font-bold text-gray-800">æŠ€ç§‘å¤§ æ··é›‘ãƒãƒƒãƒ—</h1>
        <div class="flex items-center space-x-3">
            <span id="points-display" class="text-base font-bold text-blue-600">ä¿æœ‰: èª­ã¿è¾¼ã¿ä¸­...</span>
            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (æ–½è¨­ä¸€è¦§) -->
    <main class="h-full pb-20 overflow-y-auto">
        <div class="max-w-md px-4 py-6 mx-auto">
            <h2 class="text-xl font-bold text-gray-900">æ–½è¨­ä¸€è¦§</h2>
            
            <div id="facility-list" class="mt-4 space-y-4">
                <p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </main>

    <!-- (D) æƒ…å ±æŠ•ç¨¿ãƒœã‚¿ãƒ³ (FAB) -->
    <button id="open-post-modal-btn" class="fixed z-20 flex items-center justify-center w-14 h-14 bg-green-500 text-white rounded-full shadow-lg bottom-6 right-6 hover:bg-green-600 transition duration-300">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
    </button>

    <!-- (C) ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl modal-content">
            <h3 class="text-lg font-bold text-gray-900">æƒ…å ±ã‚’å–å¾—ã—ã¾ã™</h3>
            <p class="mt-2 text-sm text-gray-600">æœ€æ–°æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« 1P æ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-unlock-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="confirm-unlock-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    OK (1Pæ¶ˆè²»)
                </button>
            </div>
        </div>
    </div>

    <!-- (D) æƒ…å ±æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="post-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl modal-content">
            <h3 class="text-lg font-bold text-gray-900">æ··é›‘çŠ¶æ³ã‚’æŠ•ç¨¿</h3>
            <div class="mt-4 space-y-4">
                <select id="post-facility" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="" disabled selected>æ–½è¨­ã‚’é¸æŠ</option>
                </select>
                <select id="post-status" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="" disabled selected>æ··é›‘çŠ¶æ³ã‚’é¸æŠ</option>
                    <option value="empty">ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹</option>
                    <option value="moderate">ğŸŸ¡ ã‚„ã‚„æ··é›‘</option>
                    <option value="crowded">ğŸ”´ æ··é›‘</option>
                </select>
                <textarea id="post-comment" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ (ä»»æ„)"></textarea>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-post-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="confirm-post-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                    æŠ•ç¨¿ (1Pç²å¾—)
                </button>
            </div>
        </div>
    </div>

    <script>
        const username = '{{ username|escapejs }}';

        const statusMap = {
            'empty': 'ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹',
            'moderate': 'ğŸŸ¡ ã‚„ã‚„æ··é›‘',
            'crowded': 'ğŸ”´ æ··é›‘'
        };

        const state = {
            points: 0,
            userId: null,
            facilities: [],
            targetFacilityId: null,
            userFacilityAccess: new Set(),
        };

        // --- DOMè¦ç´  ---
        const pointsDisplay = document.getElementById('points-display');
        const facilityList = document.getElementById('facility-list');
        const confirmModal = document.getElementById('confirm-modal');
        const cancelUnlockBtn = document.getElementById('cancel-unlock-btn');
        const confirmUnlockBtn = document.getElementById('confirm-unlock-btn');
        const postModal = document.getElementById('post-modal');
        const openPostModalBtn = document.getElementById('open-post-modal-btn');
        const cancelPostBtn = document.getElementById('cancel-post-btn');
        const confirmPostBtn = document.getElementById('confirm-post-btn');
        const postFacilitySelect = document.getElementById('post-facility');
        const postStatusSelect = document.getElementById('post-status');
        const postCommentInput = document.getElementById('post-comment');

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: CSRF ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— ---
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: APIå‘¼ã³å‡ºã— ---
        async function apiCall(url, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            return await response.json();
        }

        // --- åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
        async function initializeApp() {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ãƒã‚¤ãƒ³ãƒˆå–å¾—
                const userData = await apiCall(`/team_northcliff/api/${username}/user-data/`);
                state.userId = userData.user_id;
                state.points = userData.points;
                pointsDisplay.textContent = `ä¿æœ‰: ${state.points}P`;

                // æ–½è¨­ä¸€è¦§ã‚’å–å¾—
                const facilitiesData = await apiCall('/team_northcliff/api/facilities/');
                state.facilities = facilitiesData.facilities;

                // æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®æ–½è¨­é¸æŠè‚¢ã‚’è¨­å®š
                postFacilitySelect.innerHTML = '<option value="" disabled selected>æ–½è¨­ã‚’é¸æŠ</option>';
                state.facilities.forEach(facility => {
                    const option = document.createElement('option');
                    option.value = facility.id;
                    option.textContent = facility.name;
                    postFacilitySelect.appendChild(option);
                });

                render();
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                facilityList.innerHTML = '<p class="text-red-500">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        // --- UIå†æç”» ---
        function render() {
            facilityList.innerHTML = '';

            state.facilities.forEach(facility => {
                const facilityCard = document.createElement('div');
                facilityCard.className = 'p-4 bg-white rounded-lg shadow-md border border-gray-200';

                let cardContent = `
                    <h3 class="text-lg font-bold text-gray-800">${facility.name}</h3>
                    <p class="text-xs text-gray-500 mt-1">æœ€çµ‚æŠ•ç¨¿ï¼š ${facility.last_post_time}</p>
                    <div class="border-t my-3"></div>
                `;

                const isUnlocked = state.userFacilityAccess.has(facility.id);

                if (isUnlocked) {
                    // é–²è¦§å¾Œã®çŠ¶æ…‹ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã¯å¾Œã‹ã‚‰å®‰å…¨ã«è¿½åŠ ï¼‰
                    const statusDisplay = statusMap[facility.latest_status] || 'æƒ…å ±ãªã—';
                    cardContent += `
                        <div>
                            <span class="text-sm font-medium text-gray-700">ç¾åœ¨ã®çŠ¶æ³ï¼š</span>
                            <span class="text-base font-bold">${statusDisplay}</span>
                        </div>
                    `;
                } else {
                    // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ãƒœã‚¿ãƒ³
                    cardContent += `
                        <button 
                            class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition duration-300"
                            data-id="${facility.id}"
                        >
                            æœ€æ–°æƒ…å ±ã‚’å–å¾— (1Pæ¶ˆè²»)
                        </button>
                    `;
                }

                facilityCard.innerHTML = cardContent;
                facilityList.appendChild(facilityCard);

                // --- ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ã§ã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã‚’å®‰å…¨ã«è¿½åŠ ï¼ˆtextContent ã‚’ä½¿ã†ï¼‰ ---
                if (isUnlocked && Array.isArray(facility.recent_comments) && facility.recent_comments.length > 0) {
                    const commentsContainer = document.createElement('div');
                    commentsContainer.className = 'mt-3 space-y-3';

                    facility.recent_comments.forEach(c => {
                        const cWrap = document.createElement('div');
                        cWrap.className = 'p-3 bg-gray-50 rounded-md';

                        const cText = document.createElement('p');
                        cText.className = 'text-sm text-gray-700';
                        cText.textContent = c.comment || '';

                        const cTime = document.createElement('p');
                        cTime.className = 'text-xs text-gray-500 mt-1';
                        cTime.textContent = c.time_ago || '';

                        cWrap.appendChild(cText);
                        cWrap.appendChild(cTime);
                        commentsContainer.appendChild(cWrap);
                    });

                    facilityCard.appendChild(commentsContainer);
                }
            });
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
        function openModal(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            if (!document.querySelector('.modal-overlay:not(.hidden)')) {
                document.body.classList.remove('overflow-hidden');
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

        facilityList.addEventListener('click', async (event) => {
            if (event.target.tagName === 'BUTTON' && event.target.dataset.id) {
                const facilityId = parseInt(event.target.dataset.id);

                if (state.points <= 0) {
                    alert('ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“');
                    return;
                }

                state.targetFacilityId = facilityId;
                openModal(confirmModal);
            }
        });

        cancelUnlockBtn.addEventListener('click', () => {
            closeModal(confirmModal);
            state.targetFacilityId = null;
        });

        confirmUnlockBtn.addEventListener('click', async () => {
            try {
                // APIå‘¼ã³å‡ºã—: ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ã—ã¦æ–½è¨­æƒ…å ±ã«ã‚¢ã‚¯ã‚»ã‚¹
                await apiCall(`/team_northcliff/api/${username}/access-facility/`, 'POST', {
                    facility_id: state.targetFacilityId,
                });

                // çŠ¶æ…‹æ›´æ–°
                state.points -= 1;
                state.userFacilityAccess.add(state.targetFacilityId);
                pointsDisplay.textContent = `ä¿æœ‰: ${state.points}P`;
                render();
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                alert('æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            closeModal(confirmModal);
            state.targetFacilityId = null;
        });

        openPostModalBtn.addEventListener('click', () => {
            postFacilitySelect.value = '';
            postStatusSelect.value = '';
            postCommentInput.value = '';
            openModal(postModal);
        });

        cancelPostBtn.addEventListener('click', () => {
            closeModal(postModal);
        });

        confirmPostBtn.addEventListener('click', async () => {
            const facilityId = parseInt(postFacilitySelect.value);
            const status = postStatusSelect.value;
            const comment = postCommentInput.value.trim();

            if (!facilityId || !status) {
                alert('æ–½è¨­ã¨æ··é›‘çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            try {
                // APIå‘¼ã³å‡ºã—: æŠ•ç¨¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                await apiCall(`/team_northcliff/api/${username}/create-post/`, 'POST', {
                    facility_id: facilityId,
                    status,
                    comment: comment || null,
                });

                // ãƒã‚¤ãƒ³ãƒˆç²å¾—ã¨æŠ•ç¨¿è€…ã¯è‡ªå‹•çš„ã«æ–½è¨­ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
                state.points += 1;
                state.userFacilityAccess.add(facilityId);
                pointsDisplay.textContent = `ä¿æœ‰: ${state.points}P`;

                // æ–½è¨­ã®æœ€æ–°æƒ…å ±ã‚’å†å–å¾—
                const facilitiesData = await apiCall('/team_northcliff/api/facilities/');
                state.facilities = facilitiesData.facilities;

                render();
                closeModal(postModal);
            } catch (error) {
                console.error('æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>