{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€ç§‘å¤§ æ··é›‘ãƒãƒƒãƒ—</title>
    <!-- Tailwind CSSã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans JP ã‚’Tailwindã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼(sans)ã¨ã—ã¦è¨­å®š */
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            overscroll-behavior: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€£é–ã‚’é˜²æ­¢ */
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èƒŒæ™¯ã‚’æš—ãã™ã‚‹ */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden">

    {% csrf_token %}

    <!-- (A) ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="sticky top-0 z-10 flex items-center justify-between w-full px-4 py-3 bg-white shadow-sm">
        <h1 class="text-lg font-bold text-gray-800">æŠ€ç§‘å¤§ æ··é›‘ãƒãƒƒãƒ—</h1>
        <div class="flex items-center space-x-3">
            <span id="points-display" class="text-base font-bold text-blue-600">ä¿æœ‰: ...</span>
            <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (æ–½è¨­ä¸€è¦§) -->
    <main class="h-full pb-20 overflow-y-auto">
        <div class="max-w-md px-4 py-6 mx-auto">
            <h2 class="text-xl font-bold text-gray-900">æ–½è¨­ä¸€è¦§</h2>
            
            <div id="facility-list" class="mt-4 space-y-4">
                <p class="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </main>

    <!-- (C) ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl modal-content">
            <h3 class="text-lg font-bold text-gray-900">æƒ…å ±ã‚’å–å¾—ã—ã¾ã™</h3>
            <p class="mt-2 text-sm text-gray-600">æœ€æ–°æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« 1P æ¶ˆè²»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-unlock-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="confirm-unlock-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    OK (1Pæ¶ˆè²»)
                </button>
            </div>
        </div>
    </div>

    <!-- (D) æƒ…å ±æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="post-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 bg-black bg-opacity-50 modal-overlay">
        <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl modal-content">
            <div class="flex justify-between items-start">
                <h3 id="post-modal-title" class="text-lg font-bold text-gray-900">æ··é›‘çŠ¶æ³ã‚’æŠ•ç¨¿</h3>
                <span id="post-modal-distance" class="text-sm font-semibold">--</span>
            </div>
            <div class="mt-4 space-y-4">
                <div id="post-facility-container" style="display: none;">
                    <select id="post-facility" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="" disabled selected>æ–½è¨­ã‚’é¸æŠ</option>
                    </select>
                </div>
                <select id="post-status" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="" disabled selected>æ··é›‘çŠ¶æ³ã‚’é¸æŠ</option>
                    <option value="empty">ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹</option>
                    <option value="moderate">ğŸŸ¡ ã‚„ã‚„æ··é›‘</option>
                    <option value="crowded">ğŸ”´ æ··é›‘</option>
                </select>
                <textarea id="post-comment" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ (ä»»æ„)"></textarea>
            </div>
            <p id="post-distance-error" class="text-sm font-bold text-center text-red-600 mt-4 hidden"></p>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="cancel-post-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button id="confirm-post-btn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                    æŠ•ç¨¿ (1Pç²å¾—)
                </button>
            </div>
        </div>
    </div>

    <script>
        const username = '{{ username|escapejs }}';

        const statusMap = {
            'empty': 'ğŸŸ¢ ç©ºã„ã¦ã„ã‚‹',
            'moderate': 'ğŸŸ¡ ã‚„ã‚„æ··é›‘',
            'crowded': 'ğŸ”´ æ··é›‘'
        };

        const state = {
            points: 0,
            userId: null,
            facilities: [],
            targetFacilityId: null,
            userFacilityAccess: new Set(),
            postLockedFacilityId: null, // ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸæŠ•ç¨¿å…ˆ
            userLocation: null,         // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®æƒ…å ±
            isLocationAcquired: false,  // ä½ç½®æƒ…å ±å–å¾—æ¸ˆã¿ãƒ•ãƒ©ã‚°
        };

        // --- DOMè¦ç´  ---
        const pointsDisplay = document.getElementById('points-display');
        const facilityList = document.getElementById('facility-list');
        const confirmModal = document.getElementById('confirm-modal');
        const cancelUnlockBtn = document.getElementById('cancel-unlock-btn');
        const confirmUnlockBtn = document.getElementById('confirm-unlock-btn');
        const postModal = document.getElementById('post-modal');
        const cancelPostBtn = document.getElementById('cancel-post-btn');
        const confirmPostBtn = document.getElementById('confirm-post-btn');
        const postFacilitySelect = document.getElementById('post-facility');
        const postFacilityContainer = document.getElementById('post-facility-container');
        const postModalTitle = document.getElementById('post-modal-title');
        const postStatusSelect = document.getElementById('post-status');
        const postCommentInput = document.getElementById('post-comment');
        const postModalDistance = document.getElementById('post-modal-distance');
        const postDistanceError = document.getElementById('post-distance-error');

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: CSRF ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— ---
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
        
        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: è·é›¢è¨ˆç®— ---
        function haversine(lat1, lon1, lat2, lon2) {
            if (lat1 == null || lon1 == null || lat2 == null || lon2 == null) return null;
            const R = 6371000; // åœ°çƒã®åŠå¾„ (ãƒ¡ãƒ¼ãƒˆãƒ«)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // è·é›¢ (ãƒ¡ãƒ¼ãƒˆãƒ«)
        }
        
        function getDistanceColor(distance) {
            if (distance == null) return 'text-gray-500';
            if (distance < 50) return 'text-green-600';
            if (distance <= 100) return 'text-orange-500';
            return 'text-red-600';
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: APIå‘¼ã³å‡ºã— ---
        async function apiCall(url, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            const response = await fetch(url, options);
            let json = null;
            try {
                json = await response.json();
            } catch (e) {
                // ignore parse error
            }
            if (!response.ok) {
                const msg = (json && json.error) ? json.error : `API Error: ${response.status}`;
                throw new Error(msg);
            }
            return json;
        }

        // --- ä½ç½®æƒ…å ±è¨±å¯ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° ---
        function handleLocationPermission() {
            if (state.isLocationAcquired) return true;
            // èµ·å‹•æ™‚ã«ä½ç½®æƒ…å ±ã‚’è¦æ±‚ã™ã‚‹é€šçŸ¥ï¼ˆDBã®ä½ç½®æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’ç¤ºã™ï¼‰
            const confirmed = confirm("æŠ•ç¨¿ã‚„è·é›¢ã®è¡¨ç¤ºã«ã¯ã€ä½ç½®æƒ…å ±ãŒå¿…è¦ã§ã™ã€‚\nï¼ˆç™»éŒ²ã•ã‚ŒãŸä½ç½®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ï¼‰\n\nè¨±å¯ã—ã¾ã™ã‹ï¼Ÿ");
            if (confirmed) {
                state.isLocationAcquired = true;
                updateAllDistancesUI();
                return true;
            }
            alert("ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ãªã„ã¨ã€ã“ã®æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
            return false;
        }

        // --- åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
        async function initializeApp() {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆãƒã‚¤ãƒ³ãƒˆã¨ä½ç½®æƒ…å ±ï¼‰å–å¾—
                const userData = await apiCall(`/team_northcliff/api/${username}/user-data/`);
                state.userId = userData.user_id;
                state.points = userData.points;
                state.userLocation = { latitude: userData.latitude, longitude: userData.longitude };
                pointsDisplay.textContent = `ä¿æœ‰: ${state.points}P`;

                // èµ·å‹•æ™‚ã«ä½ç½®æƒ…å ±ã‚’è¦æ±‚
                handleLocationPermission();

                // æ–½è¨­ä¸€è¦§ã‚’å–å¾—
                const facilitiesData = await apiCall('/team_northcliff/api/facilities/');
                state.facilities = facilitiesData.facilities;

                render();
            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                facilityList.innerHTML = '<p class="text-red-500">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</p>';
            }
        }
        
        // --- UIå†æç”» ---
        function render() {
            facilityList.innerHTML = '';

            state.facilities.forEach(facility => {
                const facilityCard = document.createElement('div');
                facilityCard.className = 'p-4 bg-white rounded-lg shadow-md border border-gray-200';
                
                const distance = state.isLocationAcquired ? haversine(state.userLocation.latitude, state.userLocation.longitude, facility.latitude, facility.longitude) : null;
                const distanceText = distance != null ? `è·é›¢: ${Math.round(distance)}m` : 'è·é›¢: --';
                const distanceColor = getDistanceColor(distance);

                let cardContent = `
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-gray-800">${facility.name}</h3>
                        <span class="facility-distance text-sm font-semibold ${distanceColor}">${distanceText}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">æœ€çµ‚æŠ•ç¨¿ï¼š ${facility.last_post_time}</p>
                    <div class="border-t my-3"></div>
                `;

                const isUnlocked = state.userFacilityAccess.has(facility.id);

                if (isUnlocked) {
                    const statusDisplay = statusMap[facility.latest_status] || 'æƒ…å ±ãªã—';
                    cardContent += `<div><span class="text-sm font-medium text-gray-700">ç¾åœ¨ã®çŠ¶æ³ï¼š</span><span class="text-base font-bold">${statusDisplay}</span></div>`;
                } else {
                    cardContent += `
                        <div class="flex space-x-2">
                            <button class="flex-1 px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700" data-action="unlock" data-id="${facility.id}">æœ€æ–°æƒ…å ±ã‚’å–å¾— (1Pæ¶ˆè²»)</button>
                            <button class="flex-none px-3 py-2 font-medium text-white bg-green-600 rounded-md hover:bg-green-700" data-action="post" data-facility-id="${facility.id}">æŠ•ç¨¿ã™ã‚‹</button>
                        </div>
                    `;
                }

                facilityCard.innerHTML = cardContent;
                facilityList.appendChild(facilityCard);

                // --- ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿ã§ã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã‚’å®‰å…¨ã«è¿½åŠ ï¼ˆtextContent ã‚’ä½¿ã†ï¼‰ ---
                if (isUnlocked && Array.isArray(facility.recent_comments) && facility.recent_comments.length > 0) {
                    const commentsContainer = document.createElement('div');
                    commentsContainer.className = 'mt-3 space-y-3';
                    facility.recent_comments.forEach(c => {
                        const cWrap = document.createElement('div');
                        cWrap.className = 'p-3 bg-gray-50 rounded-md';
                        const cText = document.createElement('p');
                        cText.className = 'text-sm text-gray-700';
                        cText.textContent = c.comment || '';
                        const cTime = document.createElement('p');
                        cTime.className = 'text-xs text-gray-500 mt-1';
                        cTime.textContent = c.time_ago || '';
                        cWrap.appendChild(cText);
                        cWrap.appendChild(cTime);
                        commentsContainer.appendChild(cWrap);
                    });
                    facilityCard.appendChild(commentsContainer);
                }
            });
        }
        
        // --- è·é›¢è¡¨ç¤ºã ã‘ã‚’æ›´æ–° ---
        function updateAllDistancesUI() {
            if (!state.isLocationAcquired) return;
            document.querySelectorAll('.facility-distance').forEach((el, index) => {
                const facility = state.facilities[index];
                if (!facility) return;
                const distance = haversine(state.userLocation.latitude, state.userLocation.longitude, facility.latitude, facility.longitude);
                el.textContent = distance != null ? `è·é›¢: ${Math.round(distance)}m` : 'è·é›¢: --';
                el.className = `facility-distance text-sm font-semibold ${getDistanceColor(distance)}`;
            });
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
        function openModal(modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            if (!document.querySelector('.modal-overlay:not(.hidden)')) {
                document.body.classList.remove('overflow-hidden');
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        facilityList.addEventListener('click', async (event) => {
            const btn = event.target.closest('button');
            if (!btn) return;

            const action = btn.dataset.action;
            if (action === 'unlock') {
                if (state.points <= 0) { alert('ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“'); return; }
                state.targetFacilityId = parseInt(btn.dataset.id);
                openModal(confirmModal);
                return;
            }

            if (action === 'post') {
                if (!handleLocationPermission()) return;
                
                const facilityId = parseInt(btn.dataset.facilityId);
                const facility = state.facilities.find(f => f.id === facilityId);
                if (!facility) return;

                // è©²å½“æ–½è¨­ã®ã¿æŠ•ç¨¿ã§ãã‚‹ã‚ˆã†ã«ãƒ­ãƒƒã‚¯ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãæº–å‚™
                state.postLockedFacilityId = facilityId;
                
                const distance = haversine(state.userLocation.latitude, state.userLocation.longitude, facility.latitude, facility.longitude);
                const distanceText = distance != null ? `è·é›¢: ${Math.round(distance)}m` : 'è·é›¢: --';
                const distanceColor = getDistanceColor(distance);
                
                postModalTitle.textContent = `${facility.name}ã®æ··é›‘çŠ¶æ³ã‚’æŠ•ç¨¿`;
                postModalDistance.textContent = distanceText;
                postModalDistance.className = `text-sm font-semibold ${distanceColor}`;
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸåŒ–
                postStatusSelect.value = '';
                postCommentInput.value = '';
                
                // è·é›¢ã«å¿œã˜ã¦æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã‚’åˆ¶å¾¡
                if (distance != null && distance > 100) {
                    postDistanceError.textContent = 'è·é›¢ãŒé ã™ãã‚‹ãŸã‚ã€æŠ•ç¨¿ã§ãã¾ã›ã‚“ã€‚';
                    postDistanceError.classList.remove('hidden');
                    confirmPostBtn.disabled = true;
                    confirmPostBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    postDistanceError.classList.add('hidden');
                    confirmPostBtn.disabled = false;
                    confirmPostBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                }
                
                openModal(postModal);
                return;
            }
        });

        cancelUnlockBtn.addEventListener('click', () => {
            closeModal(confirmModal);
            state.targetFacilityId = null;
        });

        confirmUnlockBtn.addEventListener('click', async () => {
            try {
                await apiCall(`/team_northcliff/api/${username}/access-facility/`, 'POST', { facility_id: state.targetFacilityId });
                state.points -= 1;
                state.userFacilityAccess.add(state.targetFacilityId);
                pointsDisplay.textContent = `ä¿æœ‰: ${state.points}P`;
                render();
            } catch (error) {
                console.error('ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
                alert('æƒ…å ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            closeModal(confirmModal);
            state.targetFacilityId = null;
        });

        cancelPostBtn.addEventListener('click', () => {
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ãƒ­ãƒƒã‚¯è§£é™¤ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            state.postLockedFacilityId = null;
            closeModal(postModal);
        });

        confirmPostBtn.addEventListener('click', async () => {
            const facilityId = state.postLockedFacilityId;
            const status = postStatusSelect.value;
            const comment = postCommentInput.value.trim();

            if (!facilityId || !status) {
                alert('æ–½è¨­ã¨æ··é›‘çŠ¶æ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            try {
                // APIå‘¼ã³å‡ºã—: æŠ•ç¨¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
                await apiCall(`/team_northcliff/api/${username}/create-post/`, 'POST', {
                    facility_id: facilityId,
                    status: status,
                    comment: comment || null,
                });

                // çŠ¶æ…‹æ›´æ–°
                state.points += 1;
                state.userFacilityAccess.add(facilityId);
                pointsDisplay.textContent = `ä¿æœ‰: ${state.points}P`;

                // æœ€æ–°ã®æ–½è¨­æƒ…å ±ã‚’å†å–å¾—
                const facilitiesData = await apiCall('/team_northcliff/api/facilities/');
                state.facilities = facilitiesData.facilities;
                
                // UIã‚’å†æç”»ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                render();
                state.postLockedFacilityId = null;
                closeModal(postModal);

            } catch (error) {
                // æ—¢å­˜ã®ã‚¯ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ç¶­æŒ
                if (error && error.message && error.message.includes('ï¼‘ï¼åˆ†ä»¥å†…')) {
                    alert(error.message);
                } else if (error && error.message && error.message.includes('ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ããªã„')) {
                    alert(error.message);
                } else if (error && error.message && error.message.includes('æ–½è¨­ã‹ã‚‰100mä»¥ä¸Šé›¢ã‚Œã¦ã„ã‚‹')) {
                    alert(error.message);
                } else {
                    console.error('æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
                    alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        });

        // --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>