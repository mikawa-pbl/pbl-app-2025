{% extends 'teams/team_tansaibou/base.html' %}

{% block title %}ダッシュボード - {{ store.name }}{% endblock %}

{% block extra_style %}
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}
.header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.header-row h1 {
    margin: 0;
}
.refresh-btn {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}
.refresh-btn:hover {
    background-color: #45a049;
}
.refresh-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

/* サマリーカード */
.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.summary-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    text-align: center;
}
.summary-card .label {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}
.summary-card .value {
    font-size: 28px;
    font-weight: bold;
    color: #333;
}
.summary-card .value.sales {
    color: #4CAF50;
}

/* グラフセクション */
.chart-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
.chart-section h3 {
    margin: 0 0 15px 0;
    color: #333;
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 5px;
}
.chart-container {
    position: relative;
    height: 300px;
}

/* 比較グラフ横並び */
.comparison-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
@media (max-width: 900px) {
    .comparison-row {
        grid-template-columns: 1fr;
    }
}

/* テーブルセクション */
.table-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
.table-section h3 {
    margin: 0 0 15px 0;
    color: #333;
    border-bottom: 2px solid #4CAF50;
    padding-bottom: 5px;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
}
.data-table th, .data-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #eee;
}
.data-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #555;
}
.data-table tr:hover {
    background-color: #f5f5f5;
}
.data-table .amount {
    text-align: right;
    font-weight: bold;
}
.rank-badge {
    display: inline-block;
    width: 24px;
    height: 24px;
    line-height: 24px;
    text-align: center;
    border-radius: 50%;
    font-weight: bold;
    font-size: 12px;
}
.rank-1 { background: #FFD700; color: #333; }
.rank-2 { background: #C0C0C0; color: #333; }
.rank-3 { background: #CD7F32; color: white; }
.rank-other { background: #eee; color: #666; }

/* 予測テーブル横並び */
.prediction-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
@media (max-width: 900px) {
    .prediction-row {
        grid-template-columns: 1fr;
    }
}

/* ステータスバッジ */
.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}
.status-critical {
    background-color: #ffebee;
    color: #c62828;
}
.status-warning {
    background-color: #fff3e0;
    color: #ef6c00;
}
.status-ok {
    background-color: #e8f5e9;
    color: #2e7d32;
}

/* クイックリンク */
.quick-links {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}
.quick-link {
    padding: 10px 20px;
    background-color: #f5f5f5;
    color: #333;
    text-decoration: none;
    border-radius: 4px;
    font-size: 14px;
}
.quick-link:hover {
    background-color: #e0e0e0;
}
.quick-link.primary {
    background-color: #4CAF50;
    color: white;
}
.quick-link.primary:hover {
    background-color: #45a049;
}

/* ローディング */
.loading {
    text-align: center;
    padding: 40px;
    color: #999;
}

/* フッター */
.dashboard-footer {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: center;
}
.dashboard-footer p {
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
}
.logout-btn {
    background: none;
    border: none;
    color: #f44336;
    cursor: pointer;
    font-size: 14px;
}
.logout-btn:hover {
    text-decoration: underline;
}
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="header-row">
        <h1>{{ store.name }} - ダッシュボード</h1>
        <button class="refresh-btn" onclick="refreshAll()" id="refreshBtn">
            データを更新
        </button>
    </div>

    <!-- クイックリンク -->
    <div class="quick-links">
        <a href="{% url 'team_tansaibou:index' %}" class="quick-link primary">POSレジ</a>
        <a href="{% url 'team_tansaibou:product_list' %}" class="quick-link">商品管理</a>
        <a href="{% url 'team_tansaibou:productset_list' %}" class="quick-link">セット商品</a>
        <a href="{% url 'team_tansaibou:sale_list' %}" class="quick-link">販売履歴</a>
        <a href="{% url 'team_tansaibou:member_list' %}" class="quick-link">担当者管理</a>
    </div>

    <!-- サマリーカード -->
    <div class="summary-cards">
        <div class="summary-card">
            <div class="label">本日の売上</div>
            <div class="value sales" id="todaySales">-</div>
        </div>
        <div class="summary-card">
            <div class="label">本日の取引件数</div>
            <div class="value" id="todayCount">-</div>
        </div>
        <div class="summary-card">
            <div class="label">経過時間</div>
            <div class="value" id="elapsedTime">-</div>
        </div>
        <div class="summary-card">
            <div class="label">残り営業時間</div>
            <div class="value" id="remainingTime">-</div>
        </div>
    </div>

    <!-- 時間帯別グラフ -->
    <div class="chart-section">
        <h3>時間帯別 売上・取引件数</h3>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>

    <!-- 比較グラフ -->
    <div class="comparison-row">
        <div class="chart-section">
            <h3>年度比較</h3>
            <div class="chart-container">
                <canvas id="yearlyChart"></canvas>
            </div>
        </div>
        <div class="chart-section">
            <h3>日別比較</h3>
            <div class="chart-container">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 人気ランキング -->
    <div class="table-section">
        <h3>売上ランキング（本日）</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 50px;">順位</th>
                    <th>商品名</th>
                    <th>タイプ</th>
                    <th style="width: 80px;">販売数</th>
                    <th style="width: 100px;">売上金額</th>
                    <th style="width: 80px;">現在庫</th>
                </tr>
            </thead>
            <tbody id="rankingTable">
                <tr><td colspan="6" class="loading">読み込み中...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- 予測テーブル -->
    <div class="prediction-row">
        <div class="table-section">
            <h3>売り切れ予測</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>商品名</th>
                        <th>現在庫</th>
                        <th>販売速度</th>
                        <th>予測時間</th>
                        <th>状態</th>
                    </tr>
                </thead>
                <tbody id="selloutTable">
                    <tr><td colspan="5" class="loading">読み込み中...</td></tr>
                </tbody>
            </table>
        </div>
        <div class="table-section">
            <h3>ロス予測（営業終了時）</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>商品名</th>
                        <th>現在庫</th>
                        <th>予測残数</th>
                        <th>ロス金額</th>
                    </tr>
                </thead>
                <tbody id="lossTable">
                    <tr><td colspan="4" class="loading">読み込み中...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- フッター -->
    <div class="dashboard-footer">
        <p>ログイン中: {{ store.username }}</p>
        <form action="{% url 'team_tansaibou:logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="logout-btn">ログアウト</button>
        </form>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_script %}
<script>
// グラフインスタンス
let hourlyChart = null;
let yearlyChart = null;
let dailyChart = null;

// 通貨フォーマット
function formatCurrency(value) {
    return '¥' + value.toLocaleString();
}

// 本日の売上を取得
async function fetchTodaySales() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_today_sales" %}');
        const data = await response.json();
        document.getElementById('todaySales').textContent = formatCurrency(data.total_sales);
        document.getElementById('todayCount').textContent = data.transaction_count + '件';
    } catch (error) {
        console.error('Error fetching today sales:', error);
    }
}

// 時間帯別データを取得してグラフ描画
async function fetchHourlyStats() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_hourly_stats" %}');
        const data = await response.json();

        const ctx = document.getElementById('hourlyChart').getContext('2d');

        if (hourlyChart) {
            hourlyChart.destroy();
        }

        hourlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '売上（円）',
                        data: data.sales,
                        backgroundColor: 'rgba(76, 175, 80, 0.6)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '件数',
                        data: data.counts,
                        type: 'line',
                        borderColor: 'rgba(33, 150, 243, 1)',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: '売上（円）' },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: '件数' },
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error fetching hourly stats:', error);
    }
}

// 年度比較
async function fetchYearlyComparison() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_yearly_comparison" %}');
        const data = await response.json();

        const ctx = document.getElementById('yearlyChart').getContext('2d');

        if (yearlyChart) {
            yearlyChart.destroy();
        }

        yearlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '売上（円）',
                    data: data.sales,
                    backgroundColor: ['rgba(255, 152, 0, 0.6)', 'rgba(76, 175, 80, 0.6)'],
                    borderColor: ['rgba(255, 152, 0, 1)', 'rgba(76, 175, 80, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                return '件数: ' + data.counts[context.dataIndex] + '件';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '売上（円）' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error fetching yearly comparison:', error);
    }
}

// 日別比較
async function fetchDailyComparison() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_daily_comparison" %}');
        const data = await response.json();

        const ctx = document.getElementById('dailyChart').getContext('2d');

        if (dailyChart) {
            dailyChart.destroy();
        }

        dailyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '売上（円）',
                    data: data.sales,
                    backgroundColor: ['rgba(156, 39, 176, 0.6)', 'rgba(33, 150, 243, 0.6)'],
                    borderColor: ['rgba(156, 39, 176, 1)', 'rgba(33, 150, 243, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                return '件数: ' + data.counts[context.dataIndex] + '件';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '売上（円）' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error fetching daily comparison:', error);
    }
}

// 人気ランキング
async function fetchProductRanking() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_product_ranking" %}');
        const data = await response.json();

        const tbody = document.getElementById('rankingTable');

        if (data.ranking.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">本日の販売データがありません</td></tr>';
            return;
        }

        let html = '';
        data.ranking.forEach((item, index) => {
            const rank = index + 1;
            let rankClass = 'rank-other';
            if (rank === 1) rankClass = 'rank-1';
            else if (rank === 2) rankClass = 'rank-2';
            else if (rank === 3) rankClass = 'rank-3';

            html += `
                <tr>
                    <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                    <td>${item.name}</td>
                    <td>${item.type}</td>
                    <td>${item.quantity}</td>
                    <td class="amount">${formatCurrency(item.sales)}</td>
                    <td>${item.stock}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    } catch (error) {
        console.error('Error fetching product ranking:', error);
        document.getElementById('rankingTable').innerHTML = '<tr><td colspan="6" style="text-align: center; color: #f44336;">データの取得に失敗しました</td></tr>';
    }
}

// 売り切れ予測・ロス予測
async function fetchStockPrediction() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_stock_prediction" %}');
        const data = await response.json();

        // 経過時間・残り時間を更新
        document.getElementById('elapsedTime').textContent = data.hours_elapsed + '時間';
        document.getElementById('remainingTime').textContent = data.remaining_hours + '時間';

        // 売り切れ予測テーブル
        const selloutTbody = document.getElementById('selloutTable');
        if (data.sellout_predictions.length === 0) {
            selloutTbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">予測データがありません</td></tr>';
        } else {
            let html = '';
            data.sellout_predictions.forEach(item => {
                const statusClass = 'status-' + item.status;
                const statusText = item.status === 'critical' ? '危険' : (item.status === 'warning' ? '注意' : '余裕');

                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.current_stock}</td>
                        <td>${item.sales_rate} 個/時</td>
                        <td>${item.time_to_sellout} 時間</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
            selloutTbody.innerHTML = html;
        }

        // ロス予測テーブル
        const lossTbody = document.getElementById('lossTable');
        if (data.loss_predictions.length === 0) {
            lossTbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">予測データがありません</td></tr>';
        } else {
            let html = '';
            data.loss_predictions.forEach(item => {
                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.current_stock}</td>
                        <td>${item.predicted_remaining}</td>
                        <td class="amount">${formatCurrency(item.loss_amount)}</td>
                    </tr>
                `;
            });
            lossTbody.innerHTML = html;
        }
    } catch (error) {
        console.error('Error fetching stock prediction:', error);
        document.getElementById('selloutTable').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #f44336;">データの取得に失敗しました</td></tr>';
        document.getElementById('lossTable').innerHTML = '<tr><td colspan="4" style="text-align: center; color: #f44336;">データの取得に失敗しました</td></tr>';
    }
}

// 全データを更新
async function refreshAll() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.textContent = '更新中...';

    try {
        await Promise.all([
            fetchTodaySales(),
            fetchHourlyStats(),
            fetchYearlyComparison(),
            fetchDailyComparison(),
            fetchProductRanking(),
            fetchStockPrediction()
        ]);
    } finally {
        btn.disabled = false;
        btn.textContent = 'データを更新';
    }
}

// ページ読み込み時に初期化
document.addEventListener('DOMContentLoaded', function() {
    refreshAll();
});
</script>
{% endblock %}
