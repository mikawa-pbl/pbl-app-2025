{% extends 'teams/team_tansaibou/base.html' %}

{% block title %}ダッシュボード - {{ store.name }}{% endblock %}

{% block content %}
<div class="max-w-screen-xl mx-auto px-4">
    <!-- ヘッダー -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">{{ store.name }} - ダッシュボード</h1>
        <button id="refreshBtn" onclick="refreshAll()"
                class="text-white bg-gray-800 hover:bg-gray-900 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 disabled:bg-gray-400 disabled:cursor-not-allowed">
            データを更新
        </button>
    </div>

    <!-- クイックリンク -->
    <div class="flex flex-wrap gap-3 mb-6">
        <a href="{% url 'team_tansaibou:index' %}"
           class="text-white bg-gray-800 hover:bg-gray-900 font-medium rounded-lg text-sm px-5 py-2.5">
            POSレジ
        </a>
        <a href="{% url 'team_tansaibou:product_list' %}"
           class="text-gray-900 bg-gray-100 hover:bg-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">
            商品管理
        </a>
        <a href="{% url 'team_tansaibou:productset_list' %}"
           class="text-gray-900 bg-gray-100 hover:bg-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">
            セット商品
        </a>
        <a href="{% url 'team_tansaibou:sale_list' %}"
           class="text-gray-900 bg-gray-100 hover:bg-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">
            販売履歴
        </a>
        <a href="{% url 'team_tansaibou:member_list' %}"
           class="text-gray-900 bg-gray-100 hover:bg-gray-200 font-medium rounded-lg text-sm px-5 py-2.5">
            担当者管理
        </a>
    </div>

    <!-- サマリーカード -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">本日の売上</div>
            <div id="todaySales" class="text-2xl font-bold text-blue-600">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-24 mx-auto"></div>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">本日の取引件数</div>
            <div id="todayCount" class="text-2xl font-bold text-gray-900">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-16 mx-auto"></div>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">経過時間</div>
            <div id="elapsedTime" class="text-2xl font-bold text-gray-900">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-20 mx-auto"></div>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">残り営業時間</div>
            <div id="remainingTime" class="text-2xl font-bold text-gray-900">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-20 mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- 損益サマリーカード -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">売上高</div>
            <div id="totalRevenue" class="text-2xl font-bold text-blue-600">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-20 mx-auto"></div>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">売上原価</div>
            <div id="totalCogs" class="text-2xl font-bold text-gray-600">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-20 mx-auto"></div>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">粗利益</div>
            <div id="totalProfit" class="text-2xl font-bold text-green-600">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-24 mx-auto"></div>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">粗利益率</div>
            <div id="profitMargin" class="text-2xl font-bold text-gray-900">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-16 mx-auto"></div>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5 text-center">
            <div class="text-base text-gray-700 font-medium mb-1">在庫評価額</div>
            <div id="inventoryValue" class="text-2xl font-bold text-orange-600">
                <div class="skeleton-loader animate-pulse h-8 bg-gray-200 rounded w-20 mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- 商品別利益テーブル -->
    <div class="bg-white border border-gray-200 rounded-lg shadow p-5 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-green-500">商品別損益（本日）</h3>
        <div class="relative overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-4 py-3">商品名</th>
                        <th scope="col" class="px-4 py-3 w-16">販売数</th>
                        <th scope="col" class="px-4 py-3 w-24">売上高</th>
                        <th scope="col" class="px-4 py-3 w-24">売上原価</th>
                        <th scope="col" class="px-4 py-3 w-24">粗利益</th>
                        <th scope="col" class="px-4 py-3 w-20">粗利率</th>
                    </tr>
                </thead>
                <tbody id="profitTable">
                    <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-24"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-12"></div></td></tr>
                    <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-20"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-12"></div></td></tr>
                    <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-28"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-12"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 時間帯別グラフ -->
    <div class="bg-white border border-gray-200 rounded-lg shadow p-5 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">時間帯別 売上・取引件数</h3>
        <div class="relative h-72">
            <!-- Chart Skeleton -->
            <div id="hourlyChartSkeleton" class="absolute inset-0 flex items-end justify-around p-4 animate-pulse">
                <div class="w-8 bg-gray-200 rounded-t" style="height: 40%"></div>
                <div class="w-8 bg-gray-200 rounded-t" style="height: 65%"></div>
                <div class="w-8 bg-gray-200 rounded-t" style="height: 80%"></div>
                <div class="w-8 bg-gray-200 rounded-t" style="height: 55%"></div>
                <div class="w-8 bg-gray-200 rounded-t" style="height: 90%"></div>
                <div class="w-8 bg-gray-200 rounded-t" style="height: 70%"></div>
                <div class="w-8 bg-gray-200 rounded-t" style="height: 45%"></div>
                <div class="w-8 bg-gray-200 rounded-t" style="height: 60%"></div>
            </div>
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>

    <!-- 比較グラフ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">年度比較</h3>
            <div class="relative h-72">
                <div id="yearlyChartSkeleton" class="absolute inset-0 flex items-end justify-around p-4 animate-pulse">
                    <div class="w-16 bg-gray-200 rounded-t" style="height: 60%"></div>
                    <div class="w-16 bg-gray-200 rounded-t" style="height: 80%"></div>
                </div>
                <canvas id="yearlyChart"></canvas>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">日別比較</h3>
            <div class="relative h-72">
                <div id="dailyChartSkeleton" class="absolute inset-0 flex items-end justify-around p-4 animate-pulse">
                    <div class="w-16 bg-gray-200 rounded-t" style="height: 70%"></div>
                    <div class="w-16 bg-gray-200 rounded-t" style="height: 55%"></div>
                </div>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 人気ランキング -->
    <div class="bg-white border border-gray-200 rounded-lg shadow p-5 mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">売上ランキング（本日）</h3>
        <div class="relative overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-4 py-3 w-12">順位</th>
                        <th scope="col" class="px-4 py-3">商品名</th>
                        <th scope="col" class="px-4 py-3">タイプ</th>
                        <th scope="col" class="px-4 py-3 w-20">販売数</th>
                        <th scope="col" class="px-4 py-3 w-24">売上金額</th>
                        <th scope="col" class="px-4 py-3 w-20">現在庫</th>
                    </tr>
                </thead>
                <tbody id="rankingTable">
                    <!-- Skeleton Loading -->
                    <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-6 w-6 bg-gray-200 rounded-full"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-32"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td></tr>
                    <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-6 w-6 bg-gray-200 rounded-full"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-28"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td></tr>
                    <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-6 w-6 bg-gray-200 rounded-full"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-24"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 予測テーブル -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">売り切れ予測</h3>
            <div class="relative overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-4 py-3">商品名</th>
                            <th scope="col" class="px-4 py-3">現在庫</th>
                            <th scope="col" class="px-4 py-3">販売速度</th>
                            <th scope="col" class="px-4 py-3">予測時間</th>
                            <th scope="col" class="px-4 py-3">状態</th>
                        </tr>
                    </thead>
                    <tbody id="selloutTable">
                        <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-24"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-12"></div></td><td class="px-4 py-3"><div class="h-5 bg-gray-200 rounded w-12"></div></td></tr>
                        <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-20"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-12"></div></td><td class="px-4 py-3"><div class="h-5 bg-gray-200 rounded w-12"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="bg-white border border-gray-200 rounded-lg shadow p-5">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b-2 border-blue-500">ロス予測（営業終了時）</h3>
            <div class="relative overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-4 py-3">商品名</th>
                            <th scope="col" class="px-4 py-3">現在庫</th>
                            <th scope="col" class="px-4 py-3">予測残数</th>
                            <th scope="col" class="px-4 py-3">ロス金額</th>
                        </tr>
                    </thead>
                    <tbody id="lossTable">
                        <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-24"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td></tr>
                        <tr class="animate-pulse"><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-20"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-8"></div></td><td class="px-4 py-3"><div class="h-4 bg-gray-200 rounded w-16"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- フッター -->
    <div class="mt-8 pt-6 border-t border-gray-200 text-center">
        <p class="text-gray-500 text-sm mb-3">ログイン中: {{ store.username }}</p>
        <form action="{% url 'team_tansaibou:logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="text-red-600 hover:text-red-800 hover:underline text-sm">
                ログアウト
            </button>
        </form>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_script %}
<script>
// グラフインスタンス
let hourlyChart = null;
let yearlyChart = null;
let dailyChart = null;

// 通貨フォーマット
function formatCurrency(value) {
    return '¥' + value.toLocaleString();
}

// Skeleton非表示ヘルパー
function hideSkeleton(id) {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
}

// 本日の売上を取得
async function fetchTodaySales() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_today_sales" %}');
        const data = await response.json();
        document.getElementById('todaySales').textContent = formatCurrency(data.total_sales);
        document.getElementById('todayCount').textContent = data.transaction_count + '件';
    } catch (error) {
        console.error('Error fetching today sales:', error);
    }
}

// 時間帯別データを取得してグラフ描画
async function fetchHourlyStats() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_hourly_stats" %}');
        const data = await response.json();

        hideSkeleton('hourlyChartSkeleton');
        const ctx = document.getElementById('hourlyChart').getContext('2d');

        if (hourlyChart) {
            hourlyChart.destroy();
        }

        hourlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: '売上（円）',
                        data: data.sales,
                        backgroundColor: 'rgba(55, 65, 81, 0.6)',
                        borderColor: 'rgba(55, 65, 81, 1)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '件数',
                        data: data.counts,
                        type: 'line',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: '売上（円）' },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: '件数' },
                        beginAtZero: true,
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error fetching hourly stats:', error);
    }
}

// 年度比較
async function fetchYearlyComparison() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_yearly_comparison" %}');
        const data = await response.json();

        hideSkeleton('yearlyChartSkeleton');
        const ctx = document.getElementById('yearlyChart').getContext('2d');

        if (yearlyChart) {
            yearlyChart.destroy();
        }

        yearlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '売上（円）',
                    data: data.sales,
                    backgroundColor: ['rgba(107, 114, 128, 0.6)', 'rgba(59, 130, 246, 0.6)'],
                    borderColor: ['rgba(107, 114, 128, 1)', 'rgba(59, 130, 246, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                return '件数: ' + data.counts[context.dataIndex] + '件';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '売上（円）' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error fetching yearly comparison:', error);
    }
}

// 日別比較
async function fetchDailyComparison() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_daily_comparison" %}');
        const data = await response.json();

        hideSkeleton('dailyChartSkeleton');
        const ctx = document.getElementById('dailyChart').getContext('2d');

        if (dailyChart) {
            dailyChart.destroy();
        }

        dailyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: '売上（円）',
                    data: data.sales,
                    backgroundColor: ['rgba(139, 92, 246, 0.6)', 'rgba(59, 130, 246, 0.6)'],
                    borderColor: ['rgba(139, 92, 246, 1)', 'rgba(59, 130, 246, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                return '件数: ' + data.counts[context.dataIndex] + '件';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: '売上（円）' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error fetching daily comparison:', error);
    }
}

// 損益分析
async function fetchProfitAnalysis() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_profit_analysis" %}');
        const data = await response.json();

        // サマリー更新
        document.getElementById('totalRevenue').textContent = formatCurrency(data.total_revenue);
        document.getElementById('totalCogs').textContent = formatCurrency(data.total_cogs);
        document.getElementById('totalProfit').textContent = formatCurrency(data.total_profit);
        document.getElementById('profitMargin').textContent = data.profit_margin + '%';
        document.getElementById('inventoryValue').textContent = formatCurrency(data.inventory_value);

        // 利益に応じて色を変更
        const profitEl = document.getElementById('totalProfit');
        if (data.total_profit >= 0) {
            profitEl.classList.remove('text-red-600');
            profitEl.classList.add('text-green-600');
        } else {
            profitEl.classList.remove('text-green-600');
            profitEl.classList.add('text-red-600');
        }

        // 商品別利益テーブル
        const tbody = document.getElementById('profitTable');

        if (data.products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">本日の販売データがありません</td></tr>';
            return;
        }

        let html = '';
        data.products.forEach(item => {
            const profitClass = item.profit >= 0 ? 'text-green-600' : 'text-red-600';
            const marginClass = item.margin >= 30 ? 'text-green-600' : (item.margin >= 20 ? 'text-yellow-600' : 'text-red-600');

            html += `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-3">${item.quantity}</td>
                    <td class="px-4 py-3 font-bold text-blue-600">${formatCurrency(item.revenue)}</td>
                    <td class="px-4 py-3 text-gray-600">${formatCurrency(item.cost)}</td>
                    <td class="px-4 py-3 font-bold ${profitClass}">${formatCurrency(item.profit)}</td>
                    <td class="px-4 py-3 font-medium ${marginClass}">${item.margin}%</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    } catch (error) {
        console.error('Error fetching profit analysis:', error);
        document.getElementById('profitTable').innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">データの取得に失敗しました</td></tr>';
    }
}

// 人気ランキング
async function fetchProductRanking() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_product_ranking" %}');
        const data = await response.json();

        const tbody = document.getElementById('rankingTable');

        if (data.ranking.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-400">本日の販売データがありません</td></tr>';
            return;
        }

        let html = '';
        data.ranking.forEach((item, index) => {
            const rank = index + 1;
            let rankClass = 'bg-gray-100 text-gray-600';
            if (rank === 1) rankClass = 'bg-yellow-400 text-gray-900';
            else if (rank === 2) rankClass = 'bg-gray-300 text-gray-900';
            else if (rank === 3) rankClass = 'bg-amber-600 text-white';

            html += `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-3"><span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${rankClass}">${rank}</span></td>
                    <td class="px-4 py-3 font-medium text-gray-900">${item.name}</td>
                    <td class="px-4 py-3">${item.type}</td>
                    <td class="px-4 py-3">${item.quantity}</td>
                    <td class="px-4 py-3 font-bold text-blue-600">${formatCurrency(item.sales)}</td>
                    <td class="px-4 py-3">${item.stock}</td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    } catch (error) {
        console.error('Error fetching product ranking:', error);
        document.getElementById('rankingTable').innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-red-500">データの取得に失敗しました</td></tr>';
    }
}

// 売り切れ予測・ロス予測
async function fetchStockPrediction() {
    try {
        const response = await fetch('{% url "team_tansaibou:api_stock_prediction" %}');
        const data = await response.json();

        // 経過時間・残り時間を更新
        document.getElementById('elapsedTime').textContent = data.hours_elapsed + '時間';
        document.getElementById('remainingTime').textContent = data.remaining_hours + '時間';

        // 売り切れ予測テーブル
        const selloutTbody = document.getElementById('selloutTable');
        if (data.sellout_predictions.length === 0) {
            selloutTbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">予測データがありません</td></tr>';
        } else {
            let html = '';
            data.sellout_predictions.forEach(item => {
                let statusClass = 'bg-gray-100 text-gray-800';
                let statusText = '余裕';
                if (item.status === 'critical') {
                    statusClass = 'bg-red-100 text-red-800';
                    statusText = '危険';
                } else if (item.status === 'warning') {
                    statusClass = 'bg-yellow-100 text-yellow-800';
                    statusText = '注意';
                }

                html += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3">${item.current_stock}</td>
                        <td class="px-4 py-3">${item.sales_rate} 個/時</td>
                        <td class="px-4 py-3">${item.time_to_sellout} 時間</td>
                        <td class="px-4 py-3"><span class="text-xs font-medium px-2.5 py-0.5 rounded ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
            });
            selloutTbody.innerHTML = html;
        }

        // ロス予測テーブル
        const lossTbody = document.getElementById('lossTable');
        if (data.loss_predictions.length === 0) {
            lossTbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-400">予測データがありません</td></tr>';
        } else {
            let html = '';
            data.loss_predictions.forEach(item => {
                html += `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">${item.name}</td>
                        <td class="px-4 py-3">${item.current_stock}</td>
                        <td class="px-4 py-3">${item.predicted_remaining}</td>
                        <td class="px-4 py-3 font-bold text-blue-600">${formatCurrency(item.loss_amount)}</td>
                    </tr>
                `;
            });
            lossTbody.innerHTML = html;
        }
    } catch (error) {
        console.error('Error fetching stock prediction:', error);
        document.getElementById('selloutTable').innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">データの取得に失敗しました</td></tr>';
        document.getElementById('lossTable').innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">データの取得に失敗しました</td></tr>';
    }
}

// 全データを更新
async function refreshAll() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.textContent = '更新中...';

    try {
        await Promise.all([
            fetchTodaySales(),
            fetchProfitAnalysis(),
            fetchHourlyStats(),
            fetchYearlyComparison(),
            fetchDailyComparison(),
            fetchProductRanking(),
            fetchStockPrediction()
        ]);
    } finally {
        btn.disabled = false;
        btn.textContent = 'データを更新';
    }
}

// ページ読み込み時に初期化
document.addEventListener('DOMContentLoaded', function() {
    refreshAll();
});
</script>
{% endblock %}
