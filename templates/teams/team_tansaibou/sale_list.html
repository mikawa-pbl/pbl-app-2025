{% extends 'teams/team_tansaibou/base.html' %}

{% block title %}販売履歴 - Team Tansaibou{% endblock %}

{% block content %}
<div class="max-w-screen-xl mx-auto px-4">
    <!-- ヘッダー -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-900">販売履歴</h1>
        <a href="{% url 'team_tansaibou:index' %}"
           class="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5">
            レジへ戻る
        </a>
    </div>

    <!-- サマリーカード -->
    <div class="p-6 bg-white border border-gray-200 rounded-lg shadow mb-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">サマリー</h2>
        <p class="text-gray-600"><span class="font-medium">総取引件数:</span> {{ transactions|length }}件</p>
    </div>

    {% if transactions %}
    <!-- テーブル -->
    <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
        <table class="w-full text-sm text-left text-gray-500">
            <thead class="text-xs text-white uppercase bg-green-600">
                <tr>
                    <th scope="col" class="px-6 py-3">取引日</th>
                    <th scope="col" class="px-6 py-3">担当者</th>
                    <th scope="col" class="px-6 py-3">支払方法</th>
                    <th scope="col" class="px-6 py-3">合計金額</th>
                    <th scope="col" class="px-6 py-3">備考</th>
                    <th scope="col" class="px-6 py-3">詳細</th>
                    <th scope="col" class="px-6 py-3">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in transactions %}
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-6 py-4">{{ transaction.transaction_date }}</td>
                    <td class="px-6 py-4">{{ transaction.recorded_by.name }}</td>
                    <td class="px-6 py-4">
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">
                            {{ transaction.get_payment_method_display }}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-semibold text-gray-900 text-right">¥{{ transaction.total_amount|floatformat:0 }}</td>
                    <td class="px-6 py-4">{{ transaction.notes|default:"-" }}</td>
                    <td class="px-6 py-4">
                        <button type="button"
                                class="text-blue-600 hover:underline text-sm cursor-pointer"
                                onclick="toggleItems({{ transaction.id }})">
                            <span id="toggle-{{ transaction.id }}">▼ 詳細を見る</span>
                        </button>
                    </td>
                    <td class="px-6 py-4">
                        <a href="{% url 'team_tansaibou:sale_edit' transaction.id %}"
                           class="text-white bg-gray-500 hover:bg-gray-600 font-medium rounded-lg text-xs px-3 py-1.5">
                            編集
                        </a>
                    </td>
                </tr>
                <!-- 詳細行 -->
                <tr class="bg-gray-50 hidden" id="items-{{ transaction.id }}">
                    <td colspan="7" class="px-6 py-4">
                        <div class="relative overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-white uppercase bg-gray-600">
                                    <tr>
                                        <th scope="col" class="px-4 py-2">商品名</th>
                                        <th scope="col" class="px-4 py-2">タイプ</th>
                                        <th scope="col" class="px-4 py-2">数量</th>
                                        <th scope="col" class="px-4 py-2">単価</th>
                                        <th scope="col" class="px-4 py-2">小計</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in transaction.items.all %}
                                    <tr class="bg-white border-b">
                                        <td class="px-4 py-2">
                                            {% if item.product %}
                                                {{ item.product.name }}
                                            {% elif item.product_set %}
                                                {{ item.product_set.name }}
                                            {% else %}
                                                (不明)
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-2">
                                            {% if item.product %}
                                                <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-0.5 rounded">通常商品</span>
                                            {% elif item.product_set %}
                                                <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2 py-0.5 rounded">セット商品</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-2">{{ item.quantity }}</td>
                                        <td class="px-4 py-2">¥{{ item.price_at_sale|floatformat:0 }}</td>
                                        <td class="px-4 py-2 font-semibold text-right">¥{{ item.subtotal|floatformat:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <!-- データなし -->
    <div class="p-12 bg-white border border-gray-200 rounded-lg shadow text-center">
        <p class="text-gray-500 mb-4">まだ販売データがありません</p>
        <a href="{% url 'team_tansaibou:index' %}"
           class="text-white bg-green-600 hover:bg-green-700 font-medium rounded-lg text-sm px-5 py-2.5">
            最初の販売を登録する →
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_script %}
<script>
function toggleItems(transactionId) {
    const itemsRow = document.getElementById('items-' + transactionId);
    const toggleLink = document.getElementById('toggle-' + transactionId);

    if (itemsRow.classList.contains('hidden')) {
        itemsRow.classList.remove('hidden');
        toggleLink.textContent = '▲ 詳細を隠す';
    } else {
        itemsRow.classList.add('hidden');
        toggleLink.textContent = '▼ 詳細を見る';
    }
}
</script>
{% endblock %}
