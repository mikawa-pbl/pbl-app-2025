<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ room.title }} - Team Terrace Chat</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: #333; color: #fff; padding: 1rem; }
        #chat-container { flex: 1; overflow-y: auto; padding: 1rem; background: #f0f2f5; }
        .message { background: #fff; padding: 0.5rem 1rem; margin-bottom: 0.5rem; border-radius: 8px; max-width: 80%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message.question { border-left: 4px solid #ff9800; background: #fff3e0; }
        #input-area { padding: 1rem; background: #fff; border-top: 1px solid #ddd; display: flex; gap: 0.5rem; }
        #message-input { flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 0.5rem 1rem; background: #007bff; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <header>
        <h1>{{ room.title }}</h1>
    </header>

    <div id="chat-container">
        <!-- Messages will be loaded here -->
    </div>

    <div id="input-area">
        {% csrf_token %}
        <input type="text" id="message-input" placeholder="メッセージを入力...">
        <button id="send-button">送信</button>
    </div>

    <script>
        const roomId = "{{ room.uuid }}";
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');

        // メッセージを表示する関数
        function appendMessage(msg) {
            const div = document.createElement('div');
            div.className = `message ${msg.is_question ? 'question' : ''}`;
            div.textContent = msg.content;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight; // 最下部へスクロール
        }

        // メッセージ一覧を取得
        let lastMessageId = 0;
        async function fetchMessages() {
            try {
                let url = `/team_terrace/api/room/${roomId}/messages/list/`;
                if (lastMessageId > 0) {
                    url += `?after_id=${lastMessageId}`;
                }

                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    if (data.messages.length > 0) {
                        data.messages.forEach(appendMessage);
                        lastMessageId = data.messages[data.messages.length - 1].id;
                    }
                }
            } catch (error) {
                console.error('Failed to fetch messages:', error);
            }
        }

        // メッセージ送信
        async function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            try {
                const res = await fetch(`/team_terrace/api/room/${roomId}/messages/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ content: content })
                });

                if (res.ok) {
                    messageInput.value = '';
                    const newMsg = await res.json();
                    appendMessage(newMsg);
                }
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }

        // CSRFトークン取得のためのヘルパー関数
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // 初回ロード
        fetchMessages();

        // ポーリング開始 (2秒間隔)
        setInterval(fetchMessages, 2000);
    </script>
</body>
</html>
